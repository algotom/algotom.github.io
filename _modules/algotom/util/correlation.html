

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>algotom.util.correlation &mdash; Algotom&#39;s documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="Algotom&#39;s documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> Algotom
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../toc/section1.html">1. Basic tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../toc/section2.html">2. Features and capabilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../toc/section3.html">3. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../toc/section4.html">4. Demonstrations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../toc/section5.html">5. Technical notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../toc/section6.html">6. Update notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../toc/api.html">7. API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../toc/credits.html">8. Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../toc/highlights.html">9. Highlights</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Algotom</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>algotom.util.correlation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for algotom.util.correlation</h1><div class="highlight"><pre>
<span></span><span class="c1"># ============================================================================</span>
<span class="c1"># ============================================================================</span>
<span class="c1"># Copyright (c) 2022 Nghia T. Vo. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1"># ============================================================================</span>
<span class="c1"># Author: Nghia T. Vo</span>
<span class="c1"># E-mail:</span>
<span class="c1"># Description: Python module of correlation-related methods.</span>
<span class="c1"># Publication date: 20th June 2022</span>
<span class="c1"># Contributors:</span>
<span class="c1"># ============================================================================</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module of correlation-based methods for finding shifts between images or</span>
<span class="sd">stacks of images. The methods are designed to be flexible to:</span>

<span class="sd">    -   Run on multicore CPU or GPU.</span>
<span class="sd">    -   Use small/large RAM or small/large GPU memory.</span>
<span class="sd">    -   Work with small/large size of data.</span>
<span class="sd">    -   Find shifts locally or globally.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">jit</span><span class="p">,</span> <span class="n">cuda</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">correlate</span>
<span class="kn">from</span> <span class="nn">algotom.rec.reconstruction</span> <span class="kn">import</span> <span class="n">make_smoothing_window</span>


<div class="viewcode-block" id="normalize_image"><a class="viewcode-back" href="../../../toc/api/algotom.util.correlation.html#algotom.util.correlation.normalize_image">[docs]</a><span class="k">def</span> <span class="nf">normalize_image</span><span class="p">(</span><span class="n">mat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize an image.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        2D or 3D array.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">        2D or 3D array. Normalized image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">mat1</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
        <span class="n">mat1</span> <span class="o">=</span> <span class="n">mat1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">mat1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">clist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)])</span>
        <span class="n">mat1</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat</span> <span class="o">/</span> <span class="n">rlist</span><span class="p">)</span> <span class="o">/</span> <span class="n">clist</span>
        <span class="n">mat1</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mat1</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">mat1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mat1</span></div>


<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_generate_correlation_map_2d_input_cpu</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CPU-function to generate a correlation map (Pearson coefficients) by</span>
<span class="sd">    shifting the second image around the first image.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        2D array. Reference image (size of height0 x width0).</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        2D array. Image to be translated (size of height1 x width1). Its</span>
<span class="sd">        size should be smaller than the reference image.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">        2D array with the size of (height0-height1+1) x (width0-width1+1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">height0</span><span class="p">,</span> <span class="n">width0</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="p">(</span><span class="n">height1</span><span class="p">,</span> <span class="n">width1</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">height2</span><span class="p">,</span> <span class="n">width2</span> <span class="o">=</span> <span class="n">height0</span> <span class="o">-</span> <span class="n">height1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">width0</span> <span class="o">-</span> <span class="n">width1</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">mat1</span> <span class="o">=</span> <span class="n">mat</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mat1</span> <span class="o">*</span> <span class="n">mat1</span><span class="p">)</span>
    <span class="n">coef_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height2</span><span class="p">,</span> <span class="n">width2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width2</span><span class="p">):</span>
            <span class="n">row0</span><span class="p">,</span> <span class="n">row1</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">height1</span>
            <span class="n">col0</span><span class="p">,</span> <span class="n">col1</span> <span class="o">=</span> <span class="n">j</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="n">width1</span>
            <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="p">[</span><span class="n">row0</span><span class="p">:</span><span class="n">row1</span><span class="p">,</span> <span class="n">col0</span><span class="p">:</span><span class="n">col1</span><span class="p">]</span>
            <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">ref_mat1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">)</span>
            <span class="n">ref_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ref_mat1</span> <span class="o">*</span> <span class="n">ref_mat1</span><span class="p">)</span>
            <span class="n">num1</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num</span> <span class="o">*</span> <span class="n">ref_num</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num1</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">coef_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mat1</span> <span class="o">*</span> <span class="n">ref_mat1</span><span class="p">)</span> <span class="o">/</span> <span class="n">num1</span>
    <span class="k">return</span> <span class="n">coef_mat</span>


<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_generate_correlation_map_3d_input_cpu</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CPU-function to generate a correlation map (Pearson coefficients) by</span>
<span class="sd">    shifting the second 3d-image around the first 3d-image along the axes of</span>
<span class="sd">    1 and 2.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        3D array. Reference image (size of depth0 x height0 x width0).</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        3D array. Image to be translated (size of depth0 x height1 x width1).</span>
<span class="sd">        Its size (height1, width1) must be smaller than the reference image.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">        2D array with the size of (height0-height1+1) x (width0-width1+1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">height0</span><span class="p">,</span> <span class="n">width0</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="p">(</span><span class="n">height1</span><span class="p">,</span> <span class="n">width1</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">height2</span><span class="p">,</span> <span class="n">width2</span> <span class="o">=</span> <span class="n">height0</span> <span class="o">-</span> <span class="n">height1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">width0</span> <span class="o">-</span> <span class="n">width1</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">coef_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height2</span><span class="p">,</span> <span class="n">width2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">mat1</span> <span class="o">=</span> <span class="n">mat</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mat1</span> <span class="o">*</span> <span class="n">mat1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width2</span><span class="p">):</span>
            <span class="n">row0</span><span class="p">,</span> <span class="n">row1</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">height1</span>
            <span class="n">col0</span><span class="p">,</span> <span class="n">col1</span> <span class="o">=</span> <span class="n">j</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="n">width1</span>
            <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="p">[:,</span> <span class="n">row0</span><span class="p">:</span><span class="n">row1</span><span class="p">,</span> <span class="n">col0</span><span class="p">:</span><span class="n">col1</span><span class="p">]</span>
            <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">ref_mat1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">)</span>
            <span class="n">ref_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ref_mat1</span> <span class="o">*</span> <span class="n">ref_mat1</span><span class="p">)</span>
            <span class="n">num1</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num</span> <span class="o">*</span> <span class="n">ref_num</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num1</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">coef_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mat1</span> <span class="o">*</span> <span class="n">ref_mat1</span><span class="p">)</span> <span class="o">/</span> <span class="n">num1</span>
    <span class="k">return</span> <span class="n">coef_mat</span>


<span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">__mean_2d</span><span class="p">(</span><span class="n">mat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU-kernel function to calculate mean of a 2d-array.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">num</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width</span><span class="p">):</span>
            <span class="n">num</span> <span class="o">+=</span> <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">num</span> <span class="o">/</span> <span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span>


<span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">__mean_3d</span><span class="p">(</span><span class="n">mat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU-kernel function to calculate mean of a 3d-array.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">num</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width</span><span class="p">):</span>
                <span class="n">num</span> <span class="o">+=</span> <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">num</span> <span class="o">/</span> <span class="p">(</span><span class="n">depth</span> <span class="o">*</span> <span class="n">height</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span>


<span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">__sum_square_2d</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">mean</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU-kernel function to calculate the sum of squares of a normed 2d-array.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        2D array.</span>
<span class="sd">    mean : float</span>
<span class="sd">        Mean of the array.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">sum_sqr</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean</span>
            <span class="n">sum_sqr</span> <span class="o">+=</span> <span class="n">val</span> <span class="o">*</span> <span class="n">val</span>
    <span class="k">return</span> <span class="n">sum_sqr</span>


<span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">__sum_square_3d</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">mean</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU-kernel function to calculate the sum of squares of a normed 3d-array.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        3D array.</span>
<span class="sd">    mean : float</span>
<span class="sd">        Mean of the array.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">sum_sqr</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean</span>
                <span class="n">sum_sqr</span> <span class="o">+=</span> <span class="n">val</span> <span class="o">*</span> <span class="n">val</span>
    <span class="k">return</span> <span class="n">sum_sqr</span>


<span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">__sum_multiply_2d</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">ref_mean</span><span class="p">,</span> <span class="n">mat_mean</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU-kernel function to calculate the sum of multiplies of two normed</span>
<span class="sd">    2d-arrays.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        2D array. The first image.</span>
<span class="sd">    ref_mean : float</span>
<span class="sd">        Mean of the first image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        2D array. The second image.</span>
<span class="sd">    mean : float</span>
<span class="sd">        Mean of the second image.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">sum_mul</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ref_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">ref_mean</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">mat_mean</span><span class="p">)</span>
            <span class="n">sum_mul</span> <span class="o">+=</span> <span class="n">val</span>
    <span class="k">return</span> <span class="n">sum_mul</span>


<span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">__sum_multiply_3d</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">ref_mean</span><span class="p">,</span> <span class="n">mat_mean</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU-kernel function to calculate the sum of multiplies of two normed</span>
<span class="sd">    2d-arrays.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        2D array. The first image.</span>
<span class="sd">    ref_mean : float</span>
<span class="sd">        Mean of the first image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        2D array. The second image.</span>
<span class="sd">    mean : float</span>
<span class="sd">        Mean of the second image.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">sum_mul</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ref_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">ref_mean</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">mat_mean</span><span class="p">)</span>
                <span class="n">sum_mul</span> <span class="o">+=</span> <span class="n">val</span>
    <span class="k">return</span> <span class="n">sum_mul</span>


<span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">__pearson_coefficient_2d</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU-kernel function to calculate the Pearson correlation coefficient</span>
<span class="sd">    between two images.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        2D array. The first image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        2D array. The second image.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Correlation coefficient.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mat_mean</span> <span class="o">=</span> <span class="n">__mean_2d</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="n">mat_sqr</span> <span class="o">=</span> <span class="n">__sum_square_2d</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">mat_mean</span><span class="p">)</span>
    <span class="n">ref_mean</span> <span class="o">=</span> <span class="n">__mean_2d</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">)</span>
    <span class="n">ref_sqr</span> <span class="o">=</span> <span class="n">__sum_square_2d</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">ref_mean</span><span class="p">)</span>
    <span class="n">sum_mul</span> <span class="o">=</span> <span class="n">__sum_multiply_2d</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">ref_mean</span><span class="p">,</span> <span class="n">mat_mean</span><span class="p">)</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ref_sqr</span> <span class="o">*</span> <span class="n">mat_sqr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">coef_mat</span> <span class="o">=</span> <span class="n">sum_mul</span> <span class="o">/</span> <span class="n">num</span>
    <span class="k">return</span> <span class="n">coef_mat</span>


<span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">__pearson_coefficient_3d</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU-kernel function to calculate the Pearson correlation coefficient</span>
<span class="sd">    between two 3d-images.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        3D array. The first 3d-image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        3D array. The second 3d-image.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Correlation coefficient.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mat_mean</span> <span class="o">=</span> <span class="n">__mean_3d</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="n">mat_sqr</span> <span class="o">=</span> <span class="n">__sum_square_3d</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">mat_mean</span><span class="p">)</span>
    <span class="n">ref_mean</span> <span class="o">=</span> <span class="n">__mean_3d</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">)</span>
    <span class="n">ref_sqr</span> <span class="o">=</span> <span class="n">__sum_square_3d</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">ref_mean</span><span class="p">)</span>
    <span class="n">sum_mul</span> <span class="o">=</span> <span class="n">__sum_multiply_3d</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">ref_mean</span><span class="p">,</span> <span class="n">mat_mean</span><span class="p">)</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ref_sqr</span> <span class="o">*</span> <span class="n">mat_sqr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">coef_mat</span> <span class="o">=</span> <span class="n">sum_mul</span> <span class="o">/</span> <span class="n">num</span>
    <span class="k">return</span> <span class="n">coef_mat</span>


<span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">_generate_correlation_map_2d_input_gpu</span><span class="p">(</span><span class="n">coef_mat</span><span class="p">,</span> <span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">sum_sqr</span><span class="p">,</span>
                                           <span class="n">height1</span><span class="p">,</span> <span class="n">width1</span><span class="p">,</span> <span class="n">height2</span><span class="p">,</span> <span class="n">width2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU-CPU function to generate correlation map between two 2d-images.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    coef_mat : array_like</span>
<span class="sd">        2D array. Coefficient map which is initialized and passed from CPU.</span>
<span class="sd">        In GPU global-memory.</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        2D array. Reference image, passed from CPU.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        2D array. The second image, passed from CPU.</span>
<span class="sd">    sum_sqr : float</span>
<span class="sd">        Sum of squares of values of the second image.</span>
<span class="sd">    height1 : int</span>
<span class="sd">        Height of the second image.</span>
<span class="sd">    width1 : int</span>
<span class="sd">        Width of the second image.</span>
<span class="sd">    height2 : int</span>
<span class="sd">        Height of the coefficient map.</span>
<span class="sd">    width2 : int</span>
<span class="sd">        Width of the coefficient map.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">        Update of the coefficient map passed from CPU.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">x_index</span><span class="p">,</span> <span class="n">y_index</span><span class="p">)</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y_index</span> <span class="o">&lt;</span> <span class="n">height2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x_index</span> <span class="o">&lt;</span> <span class="n">width2</span><span class="p">):</span>
        <span class="n">ref_mean</span> <span class="o">=</span> <span class="n">__mean_2d</span><span class="p">(</span>
            <span class="n">ref_mat</span><span class="p">[</span><span class="n">y_index</span><span class="p">:</span><span class="n">y_index</span> <span class="o">+</span> <span class="n">height1</span><span class="p">,</span> <span class="n">x_index</span><span class="p">:</span><span class="n">x_index</span> <span class="o">+</span> <span class="n">width1</span><span class="p">])</span>
        <span class="n">num_sqr</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">num_mul</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_index</span><span class="p">,</span> <span class="n">y_index</span> <span class="o">+</span> <span class="n">height1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_index</span><span class="p">,</span> <span class="n">x_index</span> <span class="o">+</span> <span class="n">width1</span><span class="p">):</span>
                <span class="n">i1</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">y_index</span>
                <span class="n">j1</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="n">x_index</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">ref_mean</span>
                <span class="n">num_sqr</span> <span class="o">+=</span> <span class="n">val</span> <span class="o">*</span> <span class="n">val</span>
                <span class="n">num_mul</span> <span class="o">+=</span> <span class="n">mat</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">j1</span><span class="p">]</span> <span class="o">*</span> <span class="n">val</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num_sqr</span> <span class="o">*</span> <span class="n">sum_sqr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">coef_mat</span><span class="p">[</span><span class="n">y_index</span><span class="p">,</span> <span class="n">x_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_mul</span> <span class="o">/</span> <span class="n">num</span>


<span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">_generate_correlation_map_3d_input_gpu</span><span class="p">(</span><span class="n">coef_mat</span><span class="p">,</span> <span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">sum_sqr</span><span class="p">,</span>
                                           <span class="n">depth</span><span class="p">,</span> <span class="n">height1</span><span class="p">,</span> <span class="n">width1</span><span class="p">,</span> <span class="n">height2</span><span class="p">,</span>
                                           <span class="n">width2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU-CPU function to generate correlation map between two 3d-images.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    coef_mat : array_like</span>
<span class="sd">        3D array. Coefficient map which is initialized and passed from CPU.</span>
<span class="sd">        In GPU global-memory.</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        3D array. Reference image, passed from CPU.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        3D array. The second image, passed from CPU.</span>
<span class="sd">    sum_sqr : float</span>
<span class="sd">        Sum of squares of values of the second image.</span>
<span class="sd">    depth : int</span>
<span class="sd">        Number of images, or the size of the 3d-arrays along axis 0.</span>
<span class="sd">    height1 : int</span>
<span class="sd">        Height of the second image.</span>
<span class="sd">    width1 : int</span>
<span class="sd">        Width of the second image.</span>
<span class="sd">    height2 : int</span>
<span class="sd">        Height of the coefficient map.</span>
<span class="sd">    width2 : int</span>
<span class="sd">        Width of the coefficient map.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">        Update of the coefficient map passed from CPU.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">x_index</span><span class="p">,</span> <span class="n">y_index</span><span class="p">)</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y_index</span> <span class="o">&lt;</span> <span class="n">height2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x_index</span> <span class="o">&lt;</span> <span class="n">width2</span><span class="p">):</span>
        <span class="n">ref_mean</span> <span class="o">=</span> <span class="n">__mean_3d</span><span class="p">(</span>
            <span class="n">ref_mat</span><span class="p">[:,</span> <span class="n">y_index</span><span class="p">:</span><span class="n">y_index</span> <span class="o">+</span> <span class="n">height1</span><span class="p">,</span> <span class="n">x_index</span><span class="p">:</span><span class="n">x_index</span> <span class="o">+</span> <span class="n">width1</span><span class="p">])</span>
        <span class="n">num_sqr</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">num_mul</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_index</span><span class="p">,</span> <span class="n">y_index</span> <span class="o">+</span> <span class="n">height1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_index</span><span class="p">,</span> <span class="n">x_index</span> <span class="o">+</span> <span class="n">width1</span><span class="p">):</span>
                    <span class="n">j1</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="n">y_index</span>
                    <span class="n">k1</span> <span class="o">=</span> <span class="n">k</span> <span class="o">-</span> <span class="n">x_index</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">ref_mean</span>
                    <span class="n">num_sqr</span> <span class="o">+=</span> <span class="n">val</span> <span class="o">*</span> <span class="n">val</span>
                    <span class="n">num_mul</span> <span class="o">+=</span> <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">k1</span><span class="p">]</span> <span class="o">*</span> <span class="n">val</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num_sqr</span> <span class="o">*</span> <span class="n">sum_sqr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">coef_mat</span><span class="p">[</span><span class="n">y_index</span><span class="p">,</span> <span class="n">x_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_mul</span> <span class="o">/</span> <span class="n">num</span>


<div class="viewcode-block" id="generate_correlation_map"><a class="viewcode-back" href="../../../toc/api/algotom.util.correlation.html#algotom.util.correlation.generate_correlation_map">[docs]</a><span class="k">def</span> <span class="nf">generate_correlation_map</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate the correlation map (Pearson coefficients) between two images by</span>
<span class="sd">    shifting the second image over the reference image.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        2D or 3D array. The reference image (e.g. with height0 x width0).</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        2D or 3D array. The second image (e.g. with height1 x width1). If 3D,</span>
<span class="sd">        the size of the first dimension (i.e. depth) must be the same as the</span>
<span class="sd">        reference image.</span>
<span class="sd">    gpu : bool, optional</span>
<span class="sd">        Use GPU for computing if True.</span>
<span class="sd">    block : tuple of two integer-values, optional</span>
<span class="sd">        Size of a GPU block. E.g. (4,4), (8, 8), ...</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">        2D array with the size of (height0-height1+1) x (width0-width1+1).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">gpu</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;!!! No Nvidia GPU found !!! Run with CPU instead !!!&quot;</span><span class="p">)</span>
            <span class="n">gpu</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dim</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">dim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inputs must be 2d or 3d arrays !!!&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">height0</span><span class="p">,</span> <span class="n">width0</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="p">(</span><span class="n">height1</span><span class="p">,</span> <span class="n">width1</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">height2</span><span class="p">,</span> <span class="n">width2</span> <span class="o">=</span> <span class="n">height0</span> <span class="o">-</span> <span class="n">height1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">width0</span> <span class="o">-</span> <span class="n">width1</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">height1</span> <span class="o">&gt;</span> <span class="n">height0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">width1</span> <span class="o">&gt;</span> <span class="n">width0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Size of the image must be equal or smaller than the &quot;</span>
                         <span class="s2">&quot;reference image !!!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Size of axis-0 must be the same !!!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gpu</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">coef_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height2</span><span class="p">,</span> <span class="n">width2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Block must be a tuple of two integers !!!&quot;</span><span class="p">)</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">height2</span><span class="p">,</span> <span class="n">width2</span><span class="p">)</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">size</span> <span class="o">/</span> <span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">size</span> <span class="o">/</span> <span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">mat1</span> <span class="o">=</span> <span class="n">mat</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
            <span class="n">sum_sqr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mat1</span> <span class="o">*</span> <span class="n">mat1</span><span class="p">)</span>
            <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">))</span>
            <span class="n">mat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">mat1</span><span class="p">))</span>
            <span class="n">f_alias</span> <span class="o">=</span> <span class="n">_generate_correlation_map_2d_input_gpu</span>
            <span class="n">f_alias</span><span class="p">[</span><span class="n">grid</span><span class="p">,</span> <span class="n">block</span><span class="p">](</span><span class="n">coef_mat</span><span class="p">,</span> <span class="n">ref_mat1</span><span class="p">,</span> <span class="n">mat1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">sum_sqr</span><span class="p">),</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">height1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">width1</span><span class="p">),</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">height2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">width2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mat1</span> <span class="o">=</span> <span class="n">mat</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
            <span class="n">sum_sqr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mat1</span> <span class="o">*</span> <span class="n">mat1</span><span class="p">)</span>
            <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">))</span>
            <span class="n">mat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">mat1</span><span class="p">))</span>
            <span class="n">f_alias</span> <span class="o">=</span> <span class="n">_generate_correlation_map_3d_input_gpu</span>
            <span class="n">f_alias</span><span class="p">[</span><span class="n">grid</span><span class="p">,</span> <span class="n">block</span><span class="p">](</span><span class="n">coef_mat</span><span class="p">,</span> <span class="n">ref_mat1</span><span class="p">,</span> <span class="n">mat1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">sum_sqr</span><span class="p">),</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">ref_mat1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">height1</span><span class="p">),</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">width1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">height2</span><span class="p">),</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">width2</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">coef_mat</span> <span class="o">=</span> <span class="n">_generate_correlation_map_2d_input_cpu</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coef_mat</span> <span class="o">=</span> <span class="n">_generate_correlation_map_3d_input_cpu</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">coef_mat</span></div>


<span class="k">def</span> <span class="nf">_locate_1d_peak_subpixel</span><span class="p">(</span><span class="n">list_data</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;diff&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Locate the position of the maximum value of a 1d-array with sub-pixel</span>
<span class="sd">    accuracy.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    list_data : array_like</span>
<span class="sd">        1D array.</span>
<span class="sd">    method : {&quot;diff&quot;, &quot;poly_fit&quot;}</span>
<span class="sd">        Method for finding sub-pixel shift. Two options: a differential</span>
<span class="sd">        method or a polynomial method.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Sub-pixel position of the maximum value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_data</span><span class="p">)</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">list_data</span><span class="p">)</span>
    <span class="n">pos_b</span><span class="p">,</span> <span class="n">pos_f</span><span class="p">,</span> <span class="n">size1</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;poly_fit&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Large array can cause numerical error!!!&quot;</span><span class="p">)</span>
        <span class="n">afact</span><span class="p">,</span> <span class="n">bfact</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">size</span><span class="p">),</span> <span class="n">list_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">afact</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">sub_pos</span> <span class="o">=</span> <span class="o">-</span> <span class="n">bfact</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">afact</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">size1</span> <span class="o">&gt;</span> <span class="n">sub_pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">sub_pos</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">size1</span> <span class="o">&gt;</span> <span class="n">pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">d1fx</span> <span class="o">=</span> <span class="p">(</span><span class="n">list_data</span><span class="p">[</span><span class="n">pos_f</span><span class="p">]</span> <span class="o">-</span> <span class="n">list_data</span><span class="p">[</span><span class="n">pos_b</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">d2fx</span> <span class="o">=</span> <span class="p">(</span><span class="n">list_data</span><span class="p">[</span><span class="n">pos_f</span><span class="p">]</span> <span class="o">+</span> <span class="n">list_data</span><span class="p">[</span><span class="n">pos_b</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">list_data</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">d2fx</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">x_off</span> <span class="o">=</span> <span class="o">-</span> <span class="n">d1fx</span> <span class="o">/</span> <span class="n">d2fx</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">x_off</span>
    <span class="k">return</span> <span class="n">pos</span>


<span class="k">def</span> <span class="nf">_locate_2d_peak_subpixel</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;diff&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Locate the position of the maximum value of a 2d-array with sub-pixel</span>
<span class="sd">    accuracy.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        2D array.</span>
<span class="sd">    method : {&quot;diff&quot;, &quot;poly_fit&quot;}</span>
<span class="sd">        Method for finding sub-pixel shift. Two options: a differential</span>
<span class="sd">        method (Ref. [1]) or a polynomial method (Ref. [2]).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of two floats</span>
<span class="sd">        Sub-pixel position (x, y), i.e. (column, row), of the maximum value.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    [1] : https://doi.org/10.48550/arXiv.0712.4289</span>
<span class="sd">    [2] : https://doi.org/10.1088/0957-0233/17/6/045</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="p">(</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">y_pos</span><span class="p">,</span> <span class="n">x_pos</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">y0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">x0</span>
    <span class="n">height1</span><span class="p">,</span> <span class="n">width1</span> <span class="o">=</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">width</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">y_check</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="p">(</span><span class="n">y0</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">y0</span> <span class="o">==</span> <span class="n">height1</span><span class="p">)</span> <span class="k">else</span> <span class="kc">True</span>
    <span class="n">x_check</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="p">(</span><span class="n">x0</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">x0</span> <span class="o">==</span> <span class="n">width1</span><span class="p">)</span> <span class="k">else</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;poly_fit&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">y_check</span> <span class="ow">or</span> <span class="n">x_check</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Large array can cause numerical error!!!&quot;</span><span class="p">)</span>
        <span class="n">x_list</span><span class="p">,</span> <span class="n">y_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
        <span class="n">x_mat</span><span class="p">,</span> <span class="n">y_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_list</span><span class="p">,</span> <span class="n">y_list</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x_mat</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">y_mat</span><span class="p">)</span>
        <span class="n">Amatrix</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
            <span class="n">Amatrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">Amatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Amatrix</span><span class="p">)</span>
        <span class="n">Bmatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span>
        <span class="n">coefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">Amatrix</span><span class="p">,</span> <span class="n">Bmatrix</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="mf">1e-64</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">a5</span> <span class="o">=</span> <span class="n">coefs</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">a4</span> <span class="o">*</span> <span class="n">a4</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">a3</span> <span class="o">*</span> <span class="n">a5</span>
        <span class="k">if</span> <span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">x_pos1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a1</span> <span class="o">*</span> <span class="n">a5</span> <span class="o">-</span> <span class="n">a2</span> <span class="o">*</span> <span class="n">a4</span><span class="p">)</span> <span class="o">/</span> <span class="n">num</span>
            <span class="n">y_pos1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a2</span> <span class="o">*</span> <span class="n">a3</span> <span class="o">-</span> <span class="n">a1</span> <span class="o">*</span> <span class="n">a4</span><span class="p">)</span> <span class="o">/</span> <span class="n">num</span>
            <span class="k">if</span> <span class="n">height1</span> <span class="o">&gt;</span> <span class="n">y_pos1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">y_pos</span> <span class="o">=</span> <span class="n">y_pos1</span>
            <span class="k">if</span> <span class="n">width1</span> <span class="o">&gt;</span> <span class="n">x_pos1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">x_pos</span> <span class="o">=</span> <span class="n">x_pos1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">d1fx</span><span class="p">,</span> <span class="n">d2fx</span><span class="p">,</span> <span class="n">d1fy</span><span class="p">,</span> <span class="n">d2fy</span><span class="p">,</span> <span class="n">d1fxy</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">y_check</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">x_check</span><span class="p">:</span>
            <span class="n">d1fy</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">y0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x0</span><span class="p">]</span> <span class="o">-</span> <span class="n">mat</span><span class="p">[</span><span class="n">y0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">d2fy</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">y0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x0</span><span class="p">]</span> <span class="o">+</span> <span class="n">mat</span><span class="p">[</span><span class="n">y0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mat</span><span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">y_check</span> <span class="ow">and</span> <span class="n">x_check</span><span class="p">:</span>
            <span class="n">d1fx</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mat</span><span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">d2fx</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">mat</span><span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mat</span><span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">y_check</span> <span class="ow">and</span> <span class="n">x_check</span><span class="p">:</span>
            <span class="n">d1fx</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mat</span><span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">d1fy</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">y0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x0</span><span class="p">]</span> <span class="o">-</span> <span class="n">mat</span><span class="p">[</span><span class="n">y0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x0</span><span class="p">])</span>
            <span class="n">d2fx</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">mat</span><span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mat</span><span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span><span class="p">])</span>
            <span class="n">d2fy</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">y0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x0</span><span class="p">]</span> <span class="o">+</span> <span class="n">mat</span><span class="p">[</span><span class="n">y0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mat</span><span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span><span class="p">])</span>
            <span class="n">d1fxy</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">y0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">mat</span><span class="p">[</span><span class="n">y0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mat</span><span class="p">[</span>
                <span class="n">y0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mat</span><span class="p">[</span><span class="n">y0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">d1fxy</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">d2fx</span> <span class="o">*</span> <span class="n">d2fy</span>
        <span class="k">if</span> <span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">x_off</span> <span class="o">=</span> <span class="p">(</span><span class="n">d2fy</span> <span class="o">*</span> <span class="n">d1fx</span> <span class="o">-</span> <span class="n">d1fxy</span> <span class="o">*</span> <span class="n">d1fy</span><span class="p">)</span> <span class="o">/</span> <span class="n">num</span>
            <span class="n">y_off</span> <span class="o">=</span> <span class="p">(</span><span class="n">d2fx</span> <span class="o">*</span> <span class="n">d1fy</span> <span class="o">-</span> <span class="n">d1fxy</span> <span class="o">*</span> <span class="n">d1fx</span><span class="p">)</span> <span class="o">/</span> <span class="n">num</span>
            <span class="k">if</span> <span class="mf">1.0</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x_off</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">x_pos</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">x_off</span>
            <span class="k">if</span> <span class="mf">1.0</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y_off</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">y_pos</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">y_off</span>
    <span class="k">return</span> <span class="n">x_pos</span><span class="p">,</span> <span class="n">y_pos</span>


<div class="viewcode-block" id="locate_peak"><a class="viewcode-back" href="../../../toc/api/algotom.util.correlation.html#algotom.util.correlation.locate_peak">[docs]</a><span class="k">def</span> <span class="nf">locate_peak</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">sub_pixel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">max_peak</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Locate the position of the maximum value of a 2d-array with sub-pixel</span>
<span class="sd">    accuracy.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        2D array.</span>
<span class="sd">    sub_pixel : bool, optional</span>
<span class="sd">        Enable sub-pixel location.</span>
<span class="sd">    method : {&quot;diff&quot;, &quot;poly_fit&quot;}</span>
<span class="sd">        Method for finding sub-pixel shift. Two options: a differential</span>
<span class="sd">        method (Ref. [1]) or a polynomial method (Ref. [2]).</span>
<span class="sd">    dim : {1, 2}</span>
<span class="sd">        Searching dimension for sub-pixel location.</span>
<span class="sd">    size : int</span>
<span class="sd">        Window size around the integer location of the maximum value used for</span>
<span class="sd">        sub-pixel searching.</span>
<span class="sd">    max_peak : bool, optional</span>
<span class="sd">        Used to locate the minimum value if False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of two floats</span>
<span class="sd">        Sub-pixel position (x, y), i.e. (column, row), of the maximum value.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    [1] : https://doi.org/10.48550/arXiv.0712.4289</span>
<span class="sd">    [2] : https://doi.org/10.1088/0957-0233/17/6/045</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">size</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;diff&quot;</span> <span class="k">else</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">max_peak</span><span class="p">:</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span> <span class="o">-</span> <span class="n">mat</span>
    <span class="p">(</span><span class="n">y_pos</span><span class="p">,</span> <span class="n">x_pos</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sub_pixel</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">height1</span><span class="p">,</span> <span class="n">width1</span> <span class="o">=</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">width</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">size</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">height1</span> <span class="o">&gt;</span> <span class="n">y_pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">width1</span> <span class="o">&gt;</span> <span class="n">x_pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">height</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">)):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">y_pos</span> <span class="o">-</span> <span class="n">radius</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">height</span> <span class="o">-</span> <span class="n">size</span><span class="p">)</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">x_pos</span> <span class="o">-</span> <span class="n">radius</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span> <span class="o">-</span> <span class="n">size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">x_vals</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">y_pos</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span><span class="n">col</span> <span class="o">+</span> <span class="n">size</span><span class="p">]</span>
                <span class="n">y_vals</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">row</span><span class="p">:</span><span class="n">row</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="n">x_pos</span><span class="p">]</span>
                <span class="n">x_pos1</span> <span class="o">=</span> <span class="n">_locate_1d_peak_subpixel</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
                <span class="n">y_pos1</span> <span class="o">=</span> <span class="n">_locate_1d_peak_subpixel</span><span class="p">(</span><span class="n">y_vals</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
                <span class="n">x_pos</span> <span class="o">=</span> <span class="n">col</span> <span class="o">+</span> <span class="n">x_pos1</span>
                <span class="n">y_pos</span> <span class="o">=</span> <span class="n">row</span> <span class="o">+</span> <span class="n">y_pos1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sub_mat</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">row</span><span class="p">:</span><span class="n">row</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span><span class="n">col</span> <span class="o">+</span> <span class="n">size</span><span class="p">]</span>
                <span class="p">(</span><span class="n">x_pos1</span><span class="p">,</span> <span class="n">y_pos1</span><span class="p">)</span> <span class="o">=</span> <span class="n">_locate_2d_peak_subpixel</span><span class="p">(</span><span class="n">sub_mat</span><span class="p">,</span>
                                                            <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
                <span class="n">x_pos</span> <span class="o">=</span> <span class="n">col</span> <span class="o">+</span> <span class="n">x_pos1</span>
                <span class="n">y_pos</span> <span class="o">=</span> <span class="n">row</span> <span class="o">+</span> <span class="n">y_pos1</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">y_pos</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">y_pos</span> <span class="o">==</span> <span class="n">height1</span><span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">width1</span> <span class="o">&gt;</span> <span class="n">x_pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">)):</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">x_pos</span> <span class="o">-</span> <span class="n">radius</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span> <span class="o">-</span> <span class="n">size</span><span class="p">)</span>
            <span class="n">x_vals</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">y_pos</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span><span class="n">col</span> <span class="o">+</span> <span class="n">size</span><span class="p">]</span>
            <span class="n">x_pos1</span> <span class="o">=</span> <span class="n">_locate_1d_peak_subpixel</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
            <span class="n">x_pos</span> <span class="o">=</span> <span class="n">col</span> <span class="o">+</span> <span class="n">x_pos1</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">x_pos</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">x_pos</span> <span class="o">==</span> <span class="n">width1</span><span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">height1</span> <span class="o">&gt;</span> <span class="n">y_pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">height</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">)):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">y_pos</span> <span class="o">-</span> <span class="n">radius</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">height</span> <span class="o">-</span> <span class="n">size</span><span class="p">)</span>
            <span class="n">y_vals</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">row</span><span class="p">:</span><span class="n">row</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="n">x_pos</span><span class="p">]</span>
            <span class="n">y_pos1</span> <span class="o">=</span> <span class="n">_locate_1d_peak_subpixel</span><span class="p">(</span><span class="n">y_vals</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
            <span class="n">y_pos</span> <span class="o">=</span> <span class="n">row</span> <span class="o">+</span> <span class="n">y_pos1</span>
    <span class="k">return</span> <span class="n">x_pos</span><span class="p">,</span> <span class="n">y_pos</span></div>


<div class="viewcode-block" id="find_shift_based_correlation_map"><a class="viewcode-back" href="../../../toc/api/algotom.util.correlation.html#algotom.util.correlation.find_shift_based_correlation_map">[docs]</a><span class="k">def</span> <span class="nf">find_shift_based_correlation_map</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                     <span class="n">sub_pixel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                     <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the relative translations of the second image against the first image</span>
<span class="sd">    using the correlation map generated by sliding the 2nd image over the 1st</span>
<span class="sd">    one. If the inputs are 3d-arrays, the size of the first axis must be the</span>
<span class="sd">    same.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        2D or 3D array. Reference image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        2D or 3D array. The second image. If 3D, the size of the first</span>
<span class="sd">        dimension (i.e. depth) must be the same as the reference image.</span>
<span class="sd">    margin : int, optional</span>
<span class="sd">        If the second image and the first image are the same size, the second</span>
<span class="sd">        image will be cropped with the margin amount from the edges before</span>
<span class="sd">        sliding. Basically, this value defines the sliding range.</span>
<span class="sd">    axis : {0, 1, None}</span>
<span class="sd">        To select the axis for sliding. If the inputs are 3d-arrays, 0 and 1</span>
<span class="sd">        corresponding to axis-1 and axis-2 of a 3d-array.</span>
<span class="sd">    sub_pixel : bool, optional</span>
<span class="sd">        Enable sub-pixel location.</span>
<span class="sd">    method : {&quot;diff&quot;, &quot;poly_fit&quot;}</span>
<span class="sd">        Method for finding sub-pixel shift. Two options: a differential</span>
<span class="sd">        method (Ref. [1]) or a polynomial method (Ref. [2]).</span>
<span class="sd">    dim : {1, 2}</span>
<span class="sd">        Searching dimension for sub-pixel location.</span>
<span class="sd">    size : int</span>
<span class="sd">        Window size around the integer location of the maximum value used for</span>
<span class="sd">        sub-pixel searching.</span>
<span class="sd">    gpu : bool, optional</span>
<span class="sd">        Use GPU for computing if True.</span>
<span class="sd">    block : tuple of two integer-values, optional</span>
<span class="sd">        Size of a GPU block. E.g. (4,4), (8, 8), ...</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of 2 floats</span>
<span class="sd">        The shifts in x and y-direction of the second image referred to the</span>
<span class="sd">        middle of the reference image.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    [1] : https://doi.org/10.48550/arXiv.0712.4289</span>
<span class="sd">    [2] : https://doi.org/10.1088/0957-0233/17/6/045</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">height0</span><span class="p">,</span> <span class="n">width0</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="p">(</span><span class="n">height1</span><span class="p">,</span> <span class="n">width1</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">check_3d</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">else</span> <span class="kc">False</span>
    <span class="n">check1</span><span class="p">,</span> <span class="n">check2</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">height0</span> <span class="o">==</span> <span class="n">height1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">width0</span> <span class="o">==</span> <span class="n">width1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">height1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">check_3d</span><span class="p">:</span>
                    <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[:,</span> <span class="n">margin</span><span class="p">:</span><span class="o">-</span><span class="n">margin</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="n">height1</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">margin</span><span class="p">:</span><span class="o">-</span><span class="n">margin</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="n">height1</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">check1</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">width1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">check_3d</span><span class="p">:</span>
                    <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">margin</span><span class="p">:</span><span class="o">-</span><span class="n">margin</span><span class="p">]</span>
                    <span class="n">width1</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[:,</span> <span class="n">margin</span><span class="p">:</span><span class="o">-</span><span class="n">margin</span><span class="p">]</span>
                    <span class="n">width1</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">check1</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">height1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="p">(</span><span class="n">width1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">check_3d</span><span class="p">:</span>
                    <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[:,</span> <span class="n">margin</span><span class="p">:</span><span class="o">-</span><span class="n">margin</span><span class="p">,</span> <span class="n">margin</span><span class="p">:</span><span class="o">-</span><span class="n">margin</span><span class="p">]</span>
                    <span class="p">(</span><span class="n">height1</span><span class="p">,</span> <span class="n">width1</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">margin</span><span class="p">:</span><span class="o">-</span><span class="n">margin</span><span class="p">,</span> <span class="n">margin</span><span class="p">:</span><span class="o">-</span><span class="n">margin</span><span class="p">]</span>
                    <span class="p">(</span><span class="n">height1</span><span class="p">,</span> <span class="n">width1</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">check1</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">check1</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">check2</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="p">(</span><span class="n">height0</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span> <span class="o">&lt;</span> <span class="n">height1</span><span class="p">)</span> <span class="k">else</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">check2</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="p">(</span><span class="n">width0</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span> <span class="o">&lt;</span> <span class="n">width1</span><span class="p">)</span> <span class="k">else</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">check2</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="p">((</span><span class="n">height0</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span> <span class="o">&lt;</span> <span class="n">height1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="n">width0</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span> <span class="o">&lt;</span> <span class="n">width1</span><span class="p">))</span> <span class="k">else</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">check2</span><span class="p">:</span>
        <span class="n">match_img</span> <span class="o">=</span> <span class="n">generate_correlation_map</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">gpu</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
        <span class="p">(</span><span class="n">height2</span><span class="p">,</span> <span class="n">width2</span><span class="p">)</span> <span class="o">=</span> <span class="n">match_img</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">y_mid</span><span class="p">,</span> <span class="n">x_mid</span> <span class="o">=</span> <span class="n">height2</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width2</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="p">(</span><span class="n">x_peak</span><span class="p">,</span> <span class="n">y_peak</span><span class="p">)</span> <span class="o">=</span> <span class="n">locate_peak</span><span class="p">(</span><span class="n">match_img</span><span class="p">,</span> <span class="n">sub_pixel</span><span class="o">=</span><span class="n">sub_pixel</span><span class="p">,</span>
                                           <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="p">(</span><span class="n">x_peak</span><span class="p">,</span> <span class="n">y_peak</span><span class="p">)</span> <span class="o">=</span> <span class="n">locate_peak</span><span class="p">(</span><span class="n">match_img</span><span class="p">,</span> <span class="n">sub_pixel</span><span class="o">=</span><span class="n">sub_pixel</span><span class="p">,</span>
                                           <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
            <span class="n">x_peak</span> <span class="o">=</span> <span class="n">x_mid</span> <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">x_peak</span>
            <span class="n">y_peak</span> <span class="o">=</span> <span class="n">y_mid</span> <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">y_peak</span>
        <span class="n">y_shift</span><span class="p">,</span> <span class="n">x_shift</span> <span class="o">=</span> <span class="n">y_peak</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">y_mid</span><span class="p">,</span> <span class="n">x_peak</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">x_mid</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The image shapes and the selected margin value &quot;</span>
                         <span class="s2">&quot;don&#39;t match !!!&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x_shift</span><span class="p">,</span> <span class="n">y_shift</span></div>


<span class="k">def</span> <span class="nf">_get_1d_shift_single_row_2d_input</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">win_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                      <span class="n">sub_pixel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                      <span class="n">gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">pad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                      <span class="n">norm</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    To find local 1d-shifts of the second image against the reference image</span>
<span class="sd">    where their shapes are the same. Each shifting value is associated with a</span>
<span class="sd">    column-index of the second image. The value is determined by selecting a</span>
<span class="sd">    slab of image-columns of the second image, defined by the &#39;win_size&#39;</span>
<span class="sd">    parameter, and sliding over a slightly larger area of the reference image,</span>
<span class="sd">    defined by the &#39;win_size&#39; and &#39;margin&#39; parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        2D array. Reference image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        2D array. The 2nd image. Must be the same size as the reference image.</span>
<span class="sd">    win_size : int</span>
<span class="sd">        To define the size of the slab of image-columns around the selected</span>
<span class="sd">        column of the 2nd image.</span>
<span class="sd">    margin : int</span>
<span class="sd">        To define the size of the selected area of the reference image for</span>
<span class="sd">        sliding, i.e. size = 2 * margin + win_size</span>
<span class="sd">    sub_pixel : bool, optional</span>
<span class="sd">        Enable sub-pixel location.</span>
<span class="sd">    method : {&quot;diff&quot;, &quot;poly_fit&quot;}</span>
<span class="sd">        Method for finding 1d sub-pixel position. Two options: a</span>
<span class="sd">        differential method or a polynomial method.</span>
<span class="sd">    size : int</span>
<span class="sd">        Window size around the integer location of the maximum value used for</span>
<span class="sd">        sub-pixel searching.</span>
<span class="sd">    gpu : bool, optional</span>
<span class="sd">        Use GPU for computing if True.</span>
<span class="sd">    block : tuple of two integer-values, optional</span>
<span class="sd">        Size of a GPU block. E.g. (4,4), (8, 8), ...</span>
<span class="sd">    pad : bool, optional</span>
<span class="sd">        Padding the result to the same width-size as the original images.</span>
<span class="sd">    norm : bool, optional</span>
<span class="sd">        Normalize the input images if True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">        1D array. X-shifting values associated with columns of the 2nd image.</span>
<span class="sd">        Starting index is at (margin + win_size // 2). Using the pad option</span>
<span class="sd">        to make it easier to find which value corresponding to which column.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">win_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">radi</span> <span class="o">=</span> <span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">radi</span> <span class="o">+</span> <span class="n">margin</span>
    <span class="k">if</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Shapes of the inputs are not the same !!!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">win_size</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Width </span><span class="si">{0}</span><span class="s2"> of the inputs is smaller than the &quot;</span>
                         <span class="s2">&quot;requested size (win_size + 2*margin) = &quot;</span>
                         <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">win_size</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span><span class="p">))</span>
    <span class="n">stop</span><span class="p">,</span> <span class="n">start1</span><span class="p">,</span> <span class="n">radi1</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">radi</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">f_alias</span> <span class="o">=</span> <span class="n">find_shift_based_correlation_map</span>
    <span class="k">if</span> <span class="n">norm</span><span class="p">:</span>
        <span class="n">ref_mat</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">)</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="p">[</span><span class="n">f_alias</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">[:,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">start</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="n">start1</span><span class="p">],</span>
                      <span class="n">mat</span><span class="p">[:,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">radi</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="n">radi1</span><span class="p">],</span> <span class="n">margin</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sub_pixel</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span>
                      <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">gpu</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
              <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)]</span>
    <span class="n">shifting_line</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">shifts</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">pad</span><span class="p">:</span>
        <span class="n">shifting_line</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">shifting_line</span><span class="p">,</span> <span class="n">radi</span> <span class="o">+</span> <span class="n">margin</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shifting_line</span>


<span class="k">def</span> <span class="nf">_get_1d_shift_multi_rows_3d_input</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">win_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                                      <span class="n">margin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">sub_pixel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;diff&quot;</span><span class="p">,</span>
                                      <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
                                      <span class="n">pad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ncore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    To find local 1d-shifts of the second 3d-image against the reference</span>
<span class="sd">    3d-image where their shapes are the same. Each shifting value is associated</span>
<span class="sd">    with a row- or column-index of the image. The value is determined by</span>
<span class="sd">    selecting a slab of columns or rows across the axis-0 (stack) of the</span>
<span class="sd">    second image, defined by the &#39;win_size&#39; parameter, and sliding over a</span>
<span class="sd">    slightly larger area of the reference image, defined by the &#39;win_size&#39; and</span>
<span class="sd">    &#39;margin&#39; parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        3D array. Reference image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        3D array. The 2nd image. Must be the same size as the reference image.</span>
<span class="sd">    direction : {&quot;x&quot;, &quot;y&quot;}</span>
<span class="sd">        Select the direction for finding 1d-shift.</span>
<span class="sd">    win_size : int</span>
<span class="sd">        To define the size of the area around the selected pixel of the 2nd</span>
<span class="sd">        image.</span>
<span class="sd">    margin : int</span>
<span class="sd">        To define the size of the area of the reference image for</span>
<span class="sd">        sliding, i.e. size = 2 * margin + win_size</span>
<span class="sd">    sub_pixel : bool, optional</span>
<span class="sd">        Enable sub-pixel location.</span>
<span class="sd">    method : {&quot;diff&quot;, &quot;poly_fit&quot;}</span>
<span class="sd">        Method for finding 1d sub-pixel position. Two options: a differential</span>
<span class="sd">        method or a polynomial method.</span>
<span class="sd">    size : int</span>
<span class="sd">        Window size around the integer location of the maximum value used for</span>
<span class="sd">        sub-pixel searching.</span>
<span class="sd">    gpu : bool, optional</span>
<span class="sd">        Use GPU for computing if True.</span>
<span class="sd">    block : tuple of two integer-values, optional</span>
<span class="sd">        Size of a GPU block. E.g. (4,4), (8, 8), ...</span>
<span class="sd">    pad : bool, optional</span>
<span class="sd">        Padding the result to the same as the original images.</span>
<span class="sd">    ncore : int or None</span>
<span class="sd">        Number of cpu-cores used for computing. Automatically selected if None.</span>
<span class="sd">    norm : bool, optional</span>
<span class="sd">        Normalize the input images if True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like:</span>
<span class="sd">        2D array. Shifting values associated with the pixel-positions of the</span>
<span class="sd">        2nd image. Starting index is at (margin + win_size // 2). Using the pad</span>
<span class="sd">        option to make it easier to find which value corresponding to which</span>
<span class="sd">        pixel-position.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inputs must be 3d arrays !!!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">direction</span> <span class="o">!=</span> <span class="s2">&quot;x&quot;</span> <span class="ow">and</span> <span class="n">direction</span> <span class="o">!=</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only two options: &#39;x&#39; or &#39;y&#39;&#39;&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">ncore</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ncore</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">f_alias</span> <span class="o">=</span> <span class="n">_get_1d_shift_single_row_2d_input</span>
    <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ncore</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                <span class="p">[</span><span class="n">f_alias</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">win_size</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span>
                         <span class="n">sub_pixel</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">gpu</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">norm</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">ncore</span><span class="p">)(</span>
                <span class="n">delayed</span><span class="p">(</span><span class="n">f_alias</span><span class="p">)(</span><span class="n">ref_mat</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">win_size</span><span class="p">,</span>
                                 <span class="n">margin</span><span class="p">,</span> <span class="n">sub_pixel</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span>
                                 <span class="n">pad</span><span class="p">,</span> <span class="n">norm</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ncore</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                <span class="p">[</span><span class="n">f_alias</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">mat</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">win_size</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span>
                         <span class="n">sub_pixel</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">gpu</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">norm</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">ncore</span><span class="p">)(</span>
                <span class="n">delayed</span><span class="p">(</span><span class="n">f_alias</span><span class="p">)(</span><span class="n">ref_mat</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">mat</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">win_size</span><span class="p">,</span>
                                 <span class="n">margin</span><span class="p">,</span> <span class="n">sub_pixel</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span>
                                 <span class="n">pad</span><span class="p">,</span> <span class="n">norm</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width</span><span class="p">)))</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">shifts</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shifts</span>


<span class="k">def</span> <span class="nf">_get_1d_shift_full_image_3d_input_cpu</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
                                          <span class="n">chunk_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">win_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                                          <span class="n">margin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">sub_pixel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">method</span><span class="o">=</span><span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ncore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                          <span class="n">norm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">norm_global</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CPU-function to find local 1d-shifts of the second 3d-image against the</span>
<span class="sd">    reference 3d-image where their shapes are the same and their size may be</span>
<span class="sd">    too big for memory. Each shifting value is associated with a row- or</span>
<span class="sd">    column-index of the image. The value is determined by selecting a slab of</span>
<span class="sd">    columns or rows across the axis-0 (stack) of the second image, defined by</span>
<span class="sd">    the &#39;win_size&#39; parameter, and sliding over a slightly larger area of the</span>
<span class="sd">    reference image, defined by the &#39;win_size&#39; and &#39;margin&#39; parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        3D array, can be a numpy array or hdf object. Reference image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        3D array, can be a numpy array or hdf object. The 2nd image. Must be</span>
<span class="sd">        the same size as the reference image.</span>
<span class="sd">    direction : {&quot;x&quot;, &quot;y&quot;}</span>
<span class="sd">        Select the direction for finding 1d-shift.</span>
<span class="sd">    chunk_size : int or None</span>
<span class="sd">        Size of each chunk extracted along the axis-1 (height) of the 3d-image.</span>
<span class="sd">    win_size : int</span>
<span class="sd">        To define the size of the area around the selected pixel of the 2nd</span>
<span class="sd">        image.</span>
<span class="sd">    margin : int</span>
<span class="sd">        To define the size of the area of the reference image for</span>
<span class="sd">        sliding, i.e. size = 2 * margin + win_size</span>
<span class="sd">    sub_pixel : bool, optional</span>
<span class="sd">        Enable sub-pixel location.</span>
<span class="sd">    method : {&quot;diff&quot;, &quot;poly_fit&quot;}</span>
<span class="sd">        Method for finding 1d sub-pixel position. Two options: a</span>
<span class="sd">        differential method or a polynomial method.</span>
<span class="sd">    size : int</span>
<span class="sd">        Window size around the integer location of the maximum value used for</span>
<span class="sd">        sub-pixel searching.</span>
<span class="sd">    ncore : int or None</span>
<span class="sd">        Number of cpu-cores used for computing. Automatically selected if None.</span>
<span class="sd">    norm : bool, optional</span>
<span class="sd">        Normalize the input images if True.</span>
<span class="sd">    norm_global : bool, optional</span>
<span class="sd">        Normalize by using the full size of the inputs if True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like:</span>
<span class="sd">        2D array. Shifting values along the x-direction or y-direction.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data shape must be the same !!!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inputs must be 3d-arrays !!!&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">chunk_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">height</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
    <span class="n">num_chunk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">height</span> <span class="o">//</span> <span class="n">chunk_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
    <span class="n">f_alias</span> <span class="o">=</span> <span class="n">_get_1d_shift_multi_rows_3d_input</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">edge</span> <span class="o">=</span> <span class="n">margin</span> <span class="o">+</span> <span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">norm_global</span><span class="p">:</span>
        <span class="n">ref_mat</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">)</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span>
        <span class="n">list_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">height</span><span class="p">),</span> <span class="n">num_chunk</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">list_index</span><span class="p">:</span>
            <span class="n">bindex</span><span class="p">,</span> <span class="n">eindex</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="p">[:,</span> <span class="n">bindex</span><span class="p">:</span><span class="n">eindex</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">mat1</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[:,</span> <span class="n">bindex</span><span class="p">:</span><span class="n">eindex</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">shift_chunk</span> <span class="o">=</span> <span class="n">f_alias</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">,</span> <span class="n">mat1</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">win_size</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span>
                                  <span class="n">sub_pixel</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="kc">True</span><span class="p">,</span> <span class="n">ncore</span><span class="p">,</span> <span class="n">norm</span><span class="p">)</span>
            <span class="n">shifts</span><span class="p">[</span><span class="n">bindex</span><span class="p">:</span><span class="n">eindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift_chunk</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">list_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">height</span> <span class="o">-</span> <span class="n">edge</span><span class="p">),</span> <span class="n">num_chunk</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">list_index</span><span class="p">:</span>
            <span class="n">bindex</span><span class="p">,</span> <span class="n">eindex</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="p">[:,</span> <span class="n">bindex</span> <span class="o">-</span> <span class="n">edge</span><span class="p">:</span><span class="n">eindex</span> <span class="o">+</span> <span class="n">edge</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">mat1</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[:,</span> <span class="n">bindex</span> <span class="o">-</span> <span class="n">edge</span><span class="p">:</span><span class="n">eindex</span> <span class="o">+</span> <span class="n">edge</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">shift_chunk</span> <span class="o">=</span> <span class="n">f_alias</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">,</span> <span class="n">mat1</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">win_size</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span>
                                  <span class="n">sub_pixel</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="kc">False</span><span class="p">,</span> <span class="n">ncore</span><span class="p">,</span> <span class="n">norm</span><span class="p">)</span>
            <span class="n">shifts</span><span class="p">[</span><span class="n">bindex</span><span class="p">:</span><span class="n">eindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift_chunk</span>
    <span class="k">return</span> <span class="n">shifts</span>


<span class="k">def</span> <span class="nf">_get_2d_shift_full_image_2d_input</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">win_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                      <span class="n">sub_pixel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                      <span class="n">gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">ncore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                      <span class="n">norm</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    To find local (y,x)-shifts of the second image against the reference</span>
<span class="sd">    image where their shapes are the same. Each (y,x)-shifting value is</span>
<span class="sd">    associated with a pixel-location of the second image. The value is</span>
<span class="sd">    determined by selecting a small area of the second image, defined by</span>
<span class="sd">    the &#39;win_size&#39; parameter, and sliding (y,x-direction) over a slightly</span>
<span class="sd">    larger area of the reference image, defined by the &#39;win_size&#39; and &#39;margin&#39;</span>
<span class="sd">    parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        2D array. Reference image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        2D array. The 2nd image. Must be the same size as the reference image.</span>
<span class="sd">    win_size : int</span>
<span class="sd">        To define the size of the area around the selected pixel of the 2nd</span>
<span class="sd">        image.</span>
<span class="sd">    margin : int</span>
<span class="sd">        To define the size of the area of the reference image for sliding,</span>
<span class="sd">        i.e. size = 2 * margin + win_size</span>
<span class="sd">    sub_pixel : bool, optional</span>
<span class="sd">        Enable sub-pixel location.</span>
<span class="sd">    method : {&quot;diff&quot;, &quot;poly_fit&quot;}</span>
<span class="sd">        Method for finding sub-pixel shift. Two options: a differential</span>
<span class="sd">        method (Ref. [1]) or a polynomial method (Ref. [2]).</span>
<span class="sd">    size : int</span>
<span class="sd">        Window size around the integer location of the maximum value used for</span>
<span class="sd">        sub-pixel searching.</span>
<span class="sd">    gpu : bool, optional</span>
<span class="sd">        Use GPU for computing if True.</span>
<span class="sd">    block : tuple of two integer-values, optional</span>
<span class="sd">        Size of a GPU block. E.g. (4,4), (8, 8), ...</span>
<span class="sd">    ncore : int or None</span>
<span class="sd">        Number of cpu-cores used for computing. Automatically selected if None.</span>
<span class="sd">    norm : bool, optional</span>
<span class="sd">        Normalizing the inputs.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of two 2d-arrays</span>
<span class="sd">        x-shift array and y-shift array. Zeros at the outer area of the size of</span>
<span class="sd">        (margin + win_size // 2)</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    [1] : https://doi.org/10.48550/arXiv.0712.4289</span>
<span class="sd">    [2] : https://doi.org/10.1088/0957-0233/17/6/045</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data shape must be the same !!!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inputs must be 2d-arrays !!!&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">win_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">radi</span> <span class="o">=</span> <span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">radi</span> <span class="o">+</span> <span class="n">margin</span>
    <span class="n">als_size</span> <span class="o">=</span> <span class="n">win_size</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span>
    <span class="k">if</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="n">als_size</span> <span class="ow">or</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="n">als_size</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Shapes of the inputs </span><span class="si">{0}</span><span class="s2"> are smaller than the &quot;</span>
                         <span class="s2">&quot;requested size (win_size + 2*margin) = &quot;</span>
                         <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">als_size</span><span class="p">))</span>
    <span class="n">stop_col</span><span class="p">,</span> <span class="n">stop_row</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">height</span> <span class="o">-</span> <span class="n">start</span>
    <span class="n">start1</span><span class="p">,</span> <span class="n">radi1</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">radi</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">norm</span><span class="p">:</span>
        <span class="n">ref_mat</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">)</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="n">f_alias</span> <span class="o">=</span> <span class="n">find_shift_based_correlation_map</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">gpu</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ncore</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">f_alias</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">start</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">start1</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">start</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="n">start1</span><span class="p">],</span>
                     <span class="n">mat</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">radi</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">radi1</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">radi</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="n">radi1</span><span class="p">],</span>
                     <span class="n">margin</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sub_pixel</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">gpu</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop_col</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop_row</span><span class="p">)]</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">shifts</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ncore</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ncore</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">ncore</span><span class="p">)(</span>
            <span class="n">delayed</span><span class="p">(</span><span class="n">f_alias</span><span class="p">)(</span>
                <span class="n">ref_mat</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">start</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">start1</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">start</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="n">start1</span><span class="p">],</span>
                <span class="n">mat</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">radi</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">radi1</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">radi</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="n">radi1</span><span class="p">],</span>
                <span class="n">margin</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sub_pixel</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop_row</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop_col</span><span class="p">)))</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">shifts</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">stop_row</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop_col</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="p">(</span><span class="n">x_shifts</span><span class="p">,</span> <span class="n">y_shifts</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">x_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">x_shifts</span><span class="p">,</span> <span class="n">radi</span> <span class="o">+</span> <span class="n">margin</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span>
    <span class="n">y_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">y_shifts</span><span class="p">,</span> <span class="n">radi</span> <span class="o">+</span> <span class="n">margin</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x_shifts</span><span class="p">,</span> <span class="n">y_shifts</span>


<span class="k">def</span> <span class="nf">_get_2d_shift_multi_rows_3d_input</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">win_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                      <span class="n">sub_pixel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                      <span class="n">gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">pad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                      <span class="n">ncore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    To find local (y,x)-shifts of the second 3d-image against the reference</span>
<span class="sd">    3d-image where their shapes are the same. Each (y,x)-shifting value is</span>
<span class="sd">    associated with a pixel-location of the second image. The value is</span>
<span class="sd">    determined by selecting a small volume of the second image, defined by</span>
<span class="sd">    the &#39;win_size&#39; parameter, and sliding (y,x only) over a slightly larger</span>
<span class="sd">    volume of the reference image, defined by the &#39;win_size&#39; and &#39;margin&#39;</span>
<span class="sd">    parameters. Note that this function is computational expensive.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        3D array. Reference image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        3D array. The 2nd image. Must be the same size as the reference image.</span>
<span class="sd">    win_size : int</span>
<span class="sd">        To define the size of the image volume around the selected pixel of the</span>
<span class="sd">        2nd image.</span>
<span class="sd">    margin : int</span>
<span class="sd">        To define the size of the selected volume of the reference image for</span>
<span class="sd">        sliding i.e. size = 2 * margin + win_size</span>
<span class="sd">    sub_pixel : bool, optional</span>
<span class="sd">        Enable sub-pixel location.</span>
<span class="sd">    method : {&quot;diff&quot;, &quot;poly_fit&quot;}</span>
<span class="sd">        Method for finding sub-pixel shift. Two options: a differential</span>
<span class="sd">        method (Ref. [1]) or a polynomial method (Ref. [2]).</span>
<span class="sd">    size : int</span>
<span class="sd">        Window size around the integer location of the maximum value used for</span>
<span class="sd">        sub-pixel searching.</span>
<span class="sd">    gpu : bool, optional</span>
<span class="sd">        Use GPU for computing if True.</span>
<span class="sd">    block : tuple of two integer-values, optional</span>
<span class="sd">        Size of a GPU block. E.g. (4,4), (8, 8), ...</span>
<span class="sd">    pad : bool, optional</span>
<span class="sd">        Padding the result to the same as the original images.</span>
<span class="sd">    ncore : int or None</span>
<span class="sd">        Number of cpu-cores used for computing. Automatically selected if None.</span>
<span class="sd">    norm : bool, optional</span>
<span class="sd">        Normalizing the inputs.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of two 2d-arrays</span>
<span class="sd">        x-shift array and y-shift array, corresponding to the pixel-locations</span>
<span class="sd">        in the 2nd image where the starting location is at</span>
<span class="sd">        (margin + win_size/2, margin + win_size/2). Using the pad option to</span>
<span class="sd">        make it easier to find which value corresponding to which</span>
<span class="sd">        pixel-location.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    [1] : https://doi.org/10.48550/arXiv.0712.4289</span>
<span class="sd">    [2] : https://doi.org/10.1088/0957-0233/17/6/045</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data shape must be the same !!!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inputs must be 3d-arrays !!!&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">win_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">radi</span> <span class="o">=</span> <span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">radi</span> <span class="o">+</span> <span class="n">margin</span>
    <span class="n">als_size</span> <span class="o">=</span> <span class="n">win_size</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span>
    <span class="k">if</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="n">als_size</span> <span class="ow">or</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="n">als_size</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Shapes of the inputs </span><span class="si">{0}</span><span class="s2"> are smaller than the &quot;</span>
                         <span class="s2">&quot;requested size (win_size + 2*margin) = &quot;</span>
                         <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2"> x </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">als_size</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">norm</span><span class="p">:</span>
        <span class="n">ref_mat</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">)</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="n">stop_col</span><span class="p">,</span> <span class="n">stop_row</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">height</span> <span class="o">-</span> <span class="n">start</span>
    <span class="n">start1</span><span class="p">,</span> <span class="n">radi1</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">radi</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">f_alias</span> <span class="o">=</span> <span class="n">find_shift_based_correlation_map</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">gpu</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ncore</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">f_alias</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">start</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">start1</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">start</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="n">start1</span><span class="p">],</span>
                     <span class="n">mat</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">radi</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">radi1</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">radi</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="n">radi1</span><span class="p">],</span>
                     <span class="n">margin</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sub_pixel</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">gpu</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop_col</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop_row</span><span class="p">)]</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">shifts</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ncore</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ncore</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">ncore</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span>
            <span class="n">f_alias</span><span class="p">)(</span><span class="n">ref_mat</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">start</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">start1</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">start</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="n">start1</span><span class="p">],</span>
                     <span class="n">mat</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">radi</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">radi1</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">radi</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="n">radi1</span><span class="p">],</span> <span class="n">margin</span><span class="p">,</span>
                     <span class="kc">None</span><span class="p">,</span> <span class="n">sub_pixel</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                                                   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
                                                   <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop_row</span><span class="p">)</span>
                                                   <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span>
                                                   <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop_col</span><span class="p">)))</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">shifts</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">stop_row</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop_col</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="p">(</span><span class="n">x_shifts</span><span class="p">,</span> <span class="n">y_shifts</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pad</span><span class="p">:</span>
        <span class="n">x_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">x_shifts</span><span class="p">,</span> <span class="n">radi</span> <span class="o">+</span> <span class="n">margin</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span>
        <span class="n">y_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">y_shifts</span><span class="p">,</span> <span class="n">radi</span> <span class="o">+</span> <span class="n">margin</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x_shifts</span><span class="p">,</span> <span class="n">y_shifts</span>


<span class="k">def</span> <span class="nf">_get_2d_shift_full_image_3d_input_cpu</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                          <span class="n">win_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                          <span class="n">sub_pixel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;diff&quot;</span><span class="p">,</span>
                                          <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ncore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                          <span class="n">norm_global</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CPU function to find local (y,x)-shifts of the second 3d-image against the</span>
<span class="sd">    reference 3d-image where their shapes are the same and their size may be</span>
<span class="sd">    too big for memory. Each (y,x)-shifting value is associated with a</span>
<span class="sd">    pixel-location of the second image. The value is determined by selecting a</span>
<span class="sd">    small volume of the second image, defined by the &#39;win_size&#39; parameter, and</span>
<span class="sd">    sliding (y,x only) over a slightly larger volume of the reference image,</span>
<span class="sd">    defined by the &#39;win_size&#39; and &#39;margin&#39; parameters. Note that this function</span>
<span class="sd">    is computational expensive.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        3D array, can be a numpy array or hdf object. Reference image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        3D array, can be a numpy array or hdf object. The 2nd image. Must be</span>
<span class="sd">        the same size as the reference image.</span>
<span class="sd">    chunk_size : int or None</span>
<span class="sd">        Size of each chunk extracted along the axis-1 (height) of the 3d-image.</span>
<span class="sd">    win_size : int</span>
<span class="sd">        To define the size of the area around the selected pixel of the 2nd</span>
<span class="sd">        image.</span>
<span class="sd">    margin : int</span>
<span class="sd">        To define the size of the area of the reference image for</span>
<span class="sd">        sliding, i.e. size = 2 * margin + win_size</span>
<span class="sd">    sub_pixel : bool, optional</span>
<span class="sd">        Enable sub-pixel location.</span>
<span class="sd">    method : {&quot;diff&quot;, &quot;poly_fit&quot;}</span>
<span class="sd">        Method for finding sub-pixel position. Two options: a differential</span>
<span class="sd">        method or a polynomial method.</span>
<span class="sd">    size : int</span>
<span class="sd">        Window size around the integer location of the maximum value used for</span>
<span class="sd">        sub-pixel searching.</span>
<span class="sd">    ncore : int or None</span>
<span class="sd">        Number of cpu-cores used for computing. Automatically selected if None.</span>
<span class="sd">    norm : bool, optional</span>
<span class="sd">        Normalize the input images if True.</span>
<span class="sd">    norm_global : bool, optional</span>
<span class="sd">        Normalize by using the full size of the inputs if True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of two 2d-arrays</span>
<span class="sd">        x-shift array and y-shift array. Zeros at the outer area of the size of</span>
<span class="sd">        (margin + win_size // 2).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data shape must be the same !!!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inputs must be 3d-arrays !!!&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">chunk_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">height</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
    <span class="n">num_chunk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">height</span> <span class="o">//</span> <span class="n">chunk_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
    <span class="n">edge</span> <span class="o">=</span> <span class="n">margin</span> <span class="o">+</span> <span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">edge</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Height of the inputs </span><span class="si">{0}</span><span class="s2"> are smaller than the &quot;</span>
                         <span class="s2">&quot;requested size (win_size + 2*margin + 1) = &quot;</span>
                         <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2"> x </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">edge</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">list_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">height</span> <span class="o">-</span> <span class="n">edge</span><span class="p">),</span> <span class="n">num_chunk</span><span class="p">)</span>
    <span class="n">x_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">y_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">f_alias</span> <span class="o">=</span> <span class="n">_get_2d_shift_multi_rows_3d_input</span>
    <span class="k">if</span> <span class="n">norm_global</span><span class="p">:</span>
        <span class="n">ref_mat</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">)</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">list_index</span><span class="p">:</span>
        <span class="n">bindex</span><span class="p">,</span> <span class="n">eindex</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="p">[:,</span> <span class="n">bindex</span> <span class="o">-</span> <span class="n">edge</span><span class="p">:</span><span class="n">eindex</span> <span class="o">+</span> <span class="n">edge</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">mat1</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[:,</span> <span class="n">bindex</span> <span class="o">-</span> <span class="n">edge</span><span class="p">:</span><span class="n">eindex</span> <span class="o">+</span> <span class="n">edge</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">shift_chunk</span> <span class="o">=</span> <span class="n">f_alias</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">,</span> <span class="n">mat1</span><span class="p">,</span> <span class="n">win_size</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span> <span class="n">sub_pixel</span><span class="p">,</span>
                              <span class="n">method</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">ncore</span><span class="p">,</span> <span class="n">norm</span><span class="p">)</span>
        <span class="n">x_shifts</span><span class="p">[</span><span class="n">bindex</span><span class="p">:</span><span class="n">eindex</span><span class="p">,</span> <span class="n">edge</span><span class="p">:</span><span class="o">-</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift_chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_shifts</span><span class="p">[</span><span class="n">bindex</span><span class="p">:</span><span class="n">eindex</span><span class="p">,</span> <span class="n">edge</span><span class="p">:</span><span class="o">-</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift_chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">x_shifts</span><span class="p">,</span> <span class="n">y_shifts</span>


<span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">__gen_1d_corr_map_kernel</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">list_coef</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU-kernel function to generate a list of local correlation-coefficients</span>
<span class="sd">    between two images having the same height.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        2D array. The first image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        2D array. The second image.</span>
<span class="sd">    list_coef :  array_like</span>
<span class="sd">        list of zeros, passed from GPU global memory.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">        Calculated coefficients.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">height0</span><span class="p">,</span> <span class="n">width0</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="p">(</span><span class="n">height1</span><span class="p">,</span> <span class="n">width1</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">width2</span> <span class="o">=</span> <span class="n">width0</span> <span class="o">-</span> <span class="n">width1</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">mat_mean</span> <span class="o">=</span> <span class="n">__mean_2d</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="n">mat_sqr</span> <span class="o">=</span> <span class="n">__sum_square_2d</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">mat_mean</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width2</span><span class="p">):</span>
        <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="p">[:,</span> <span class="n">j</span><span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">width1</span><span class="p">]</span>
        <span class="n">ref_mean</span> <span class="o">=</span> <span class="n">__mean_2d</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">)</span>
        <span class="n">ref_sqr</span> <span class="o">=</span> <span class="n">__sum_square_2d</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">,</span> <span class="n">ref_mean</span><span class="p">)</span>
        <span class="n">sum_mul</span> <span class="o">=</span> <span class="n">__sum_multiply_2d</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">ref_mean</span><span class="p">,</span> <span class="n">mat_mean</span><span class="p">)</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ref_sqr</span> <span class="o">*</span> <span class="n">mat_sqr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">num_tmp</span> <span class="o">=</span> <span class="n">sum_mul</span> <span class="o">/</span> <span class="n">num</span>
        <span class="n">list_coef</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_tmp</span>
    <span class="k">return</span> <span class="n">list_coef</span>


<span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">__locate_1d_peak_kernel</span><span class="p">(</span><span class="n">list_data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU-kernel function to locate the position of the maximum value of a</span>
<span class="sd">    1d-array with sub-pixel accuracy.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    list_data : array_like</span>
<span class="sd">        1D array.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Sub-pixel position of the maximum value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_point</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_data</span><span class="p">)</span>
    <span class="n">pos_max</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">val_max</span> <span class="o">=</span> <span class="n">list_data</span><span class="p">[</span><span class="n">pos_max</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_point</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">list_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">val_max</span><span class="p">:</span>
            <span class="n">val_max</span> <span class="o">=</span> <span class="n">val</span>
            <span class="n">pos_max</span> <span class="o">=</span> <span class="n">i</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">num_point</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">pos_max</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">val1</span> <span class="o">=</span> <span class="n">list_data</span><span class="p">[</span><span class="n">pos_max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">val2</span> <span class="o">=</span> <span class="n">list_data</span><span class="p">[</span><span class="n">pos_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">d1fx</span> <span class="o">=</span> <span class="p">(</span><span class="n">val2</span> <span class="o">-</span> <span class="n">val1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">d2fx</span> <span class="o">=</span> <span class="p">(</span><span class="n">val2</span> <span class="o">+</span> <span class="n">val1</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">val_max</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d2fx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">x_off</span> <span class="o">=</span> <span class="o">-</span> <span class="n">d1fx</span> <span class="o">/</span> <span class="n">d2fx</span>
            <span class="n">pos_max</span> <span class="o">=</span> <span class="n">pos_max</span> <span class="o">+</span> <span class="n">x_off</span>
    <span class="k">return</span> <span class="n">pos_max</span>


<span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">_get_1d_shift_multi_rows_3d_input_kernel</span><span class="p">(</span><span class="n">shift_mat</span><span class="p">,</span> <span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span>
                                             <span class="n">list_coef</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">radi</span><span class="p">,</span>
                                             <span class="n">margin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU-CPU function to find local 1d-shifts of the second 3d-image against</span>
<span class="sd">    the reference 3d-image where their shapes are the same.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    shift_mat : array_like</span>
<span class="sd">        2D array of zeros, initialized at CPU.</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        3D array. Reference image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        3D array. The 2nd image. Must be the same size as the reference image.</span>
<span class="sd">    list_coef : array_like</span>
<span class="sd">        list of the list of zeros, initialized at CPU.</span>
<span class="sd">    height : int</span>
<span class="sd">        Height of the image.</span>
<span class="sd">    width : int</span>
<span class="sd">        Width of the image.</span>
<span class="sd">    radi : int</span>
<span class="sd">        Radius of the window to select a local area of the image.</span>
<span class="sd">    margin : int</span>
<span class="sd">        To define the size of the area of the reference image for</span>
<span class="sd">        sliding.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">        Update of the shifting image passed from CPU.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">x_index</span><span class="p">,</span> <span class="n">y_index</span><span class="p">)</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y_index</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x_index</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">):</span>
        <span class="n">edge</span> <span class="o">=</span> <span class="n">radi</span> <span class="o">+</span> <span class="n">margin</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">x_index</span> <span class="o">+</span> <span class="n">edge</span>
        <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="p">[</span><span class="n">y_index</span><span class="p">,</span> <span class="p">:,</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">edge</span><span class="p">:</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">edge</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">mat1</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">y_index</span><span class="p">,</span> <span class="p">:,</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">radi</span><span class="p">:</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">radi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">list_coef1</span> <span class="o">=</span> <span class="n">list_coef</span><span class="p">[</span><span class="n">y_index</span><span class="p">,</span> <span class="n">x_index</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">list_coef1</span> <span class="o">=</span> <span class="n">__gen_1d_corr_map_kernel</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">,</span> <span class="n">mat1</span><span class="p">,</span> <span class="n">list_coef1</span><span class="p">)</span>
        <span class="n">pos_max</span> <span class="o">=</span> <span class="n">__locate_1d_peak_kernel</span><span class="p">(</span><span class="n">list_coef1</span><span class="p">)</span>
        <span class="n">shift_mat</span><span class="p">[</span><span class="n">y_index</span><span class="p">,</span> <span class="n">x_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_max</span> <span class="o">-</span> <span class="n">margin</span>


<span class="k">def</span> <span class="nf">_get_1d_shift_multi_rows_3d_input_gpu</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
                                          <span class="n">win_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                          <span class="n">block</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">pad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU function to find local 1d-shifts of the second 3d-image against the</span>
<span class="sd">    reference 3d-image where their shapes are the same. Each shifting value is</span>
<span class="sd">    associated with a row- or column-index of the image. The value is</span>
<span class="sd">    determined by selecting a slab of columns or rows across the axis-0 (stack)</span>
<span class="sd">    of the second image, defined by the &#39;win_size&#39; parameter, and sliding over</span>
<span class="sd">    a slightly larger area of the reference image, defined by the &#39;win_size&#39;</span>
<span class="sd">    and &#39;margin&#39; parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        3D array. Reference image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        3D array. The 2nd image. Must be the same size as the reference image.</span>
<span class="sd">    direction : {&quot;x&quot;, &quot;y&quot;}</span>
<span class="sd">        Select the direction for finding 1d-shift.</span>
<span class="sd">    win_size : int</span>
<span class="sd">        To define the size of the area around the selected pixel of the 2nd</span>
<span class="sd">        image.</span>
<span class="sd">    margin : int</span>
<span class="sd">        To define the size of the area of the reference image for</span>
<span class="sd">        sliding, i.e. size = 2 * margin + win_size</span>
<span class="sd">    block : tuple of two integer-values, optional</span>
<span class="sd">        Size of a GPU block. E.g. (4,4), (8, 8), ...</span>
<span class="sd">    pad : bool, optional</span>
<span class="sd">        Padding the result to the same as the original images.</span>
<span class="sd">    norm : bool, optional</span>
<span class="sd">        Normalize the inputs if True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like:</span>
<span class="sd">        2D array. Shifting values associated with the pixel-positions of the</span>
<span class="sd">        2nd image. Starting index is at (margin + win_size // 2). Using the pad</span>
<span class="sd">        option to make it easier to find which value corresponding to which</span>
<span class="sd">        pixel-position.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data shape must be the same !!!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">ref_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inputs must be 3d arrays !!!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">direction</span> <span class="o">!=</span> <span class="s2">&quot;x&quot;</span> <span class="ow">and</span> <span class="n">direction</span> <span class="o">!=</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only two options: &#39;x&#39; or &#39;y&#39;&#39;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">direction</span> <span class="o">!=</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span>
        <span class="n">ref_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">ref_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">norm</span><span class="p">:</span>
        <span class="n">ref_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
            <span class="p">[</span><span class="n">normalize_image</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height</span><span class="p">)])</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">normalize_image</span><span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height</span><span class="p">)])</span>
    <span class="n">win_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">radi</span> <span class="o">=</span> <span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">edge</span> <span class="o">=</span> <span class="n">radi</span> <span class="o">+</span> <span class="n">margin</span>
    <span class="n">width1</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">edge</span>
    <span class="k">if</span> <span class="n">width1</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Width </span><span class="si">{0}</span><span class="s2"> of the inputs is smaller than the &quot;</span>
                         <span class="s2">&quot;requested size (win_size + 2*margin) = &quot;</span>
                         <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">win_size</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span><span class="p">))</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">width1</span> <span class="o">/</span> <span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">height</span> <span class="o">/</span> <span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
    <span class="n">f_alias</span> <span class="o">=</span> <span class="n">_get_1d_shift_multi_rows_3d_input_kernel</span>
    <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">))</span>
    <span class="n">mat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span>
    <span class="n">list_coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">f_alias</span><span class="p">[</span><span class="n">grid</span><span class="p">,</span> <span class="n">block</span><span class="p">](</span><span class="n">shifts</span><span class="p">,</span> <span class="n">ref_mat1</span><span class="p">,</span> <span class="n">mat1</span><span class="p">,</span> <span class="n">list_coef</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">height</span><span class="p">),</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">width1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">radi</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">margin</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">pad</span><span class="p">:</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">edge</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">direction</span> <span class="o">!=</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">shifts</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shifts</span>


<span class="k">def</span> <span class="nf">_get_1d_shift_full_image_3d_input_gpu</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
                                          <span class="n">chunk_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">win_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                                          <span class="n">margin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">norm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">norm_global</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU function to find local 1d-shifts of the second 3d-image against the</span>
<span class="sd">    reference 3d-image where their shapes are the same and their size may be</span>
<span class="sd">    too big for memory. Each shifting value is associated with a row- or</span>
<span class="sd">    column-index of the image. The value is determined by selecting a slab of</span>
<span class="sd">    columns or rows across the axis-0 (stack) of the second image, defined by</span>
<span class="sd">    the &#39;win_size&#39; parameter, and sliding over a slightly larger area of the</span>
<span class="sd">    reference image, defined by the &#39;win_size&#39; and &#39;margin&#39; parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        3D array, can be a numpy array or hdf object. Reference image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        3D array, can be a numpy array or hdf object. The 2nd image. Must be</span>
<span class="sd">        the same size as the reference image.</span>
<span class="sd">    direction : {&quot;x&quot;, &quot;y&quot;}</span>
<span class="sd">        Select the direction for finding 1d-shift.</span>
<span class="sd">    chunk_size : int or None</span>
<span class="sd">        Size of each chunk extracted along the axis-1 (height) of the 3d-image.</span>
<span class="sd">    win_size : int</span>
<span class="sd">        To define the size of the area around the selected pixel of the 2nd</span>
<span class="sd">        image.</span>
<span class="sd">    margin : int</span>
<span class="sd">        To define the size of the area of the reference image for sliding,</span>
<span class="sd">        i.e. size = 2 * margin + win_size.</span>
<span class="sd">    block : tuple of two integer-values, optional</span>
<span class="sd">        Size of a GPU block. E.g. (4,4), (8, 8), ...</span>
<span class="sd">    norm : bool, optional</span>
<span class="sd">        Normalize the input images if True.</span>
<span class="sd">    norm_global : bool, optional</span>
<span class="sd">        Normalize by using the full size of the inputs if True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like:</span>
<span class="sd">        2D array. Shifting values along the x-direction or y-direction.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data shape must be the same !!!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inputs must be 3d-arrays !!!&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">chunk_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">height</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
    <span class="n">num_chunk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">height</span> <span class="o">//</span> <span class="n">chunk_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
    <span class="n">f_alias</span> <span class="o">=</span> <span class="n">_get_1d_shift_multi_rows_3d_input_gpu</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">edge</span> <span class="o">=</span> <span class="n">margin</span> <span class="o">+</span> <span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">norm_global</span><span class="p">:</span>
        <span class="n">ref_mat</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">)</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span>
        <span class="n">list_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">height</span><span class="p">),</span> <span class="n">num_chunk</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">list_index</span><span class="p">:</span>
            <span class="n">bindex</span><span class="p">,</span> <span class="n">eindex</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="p">[:,</span> <span class="n">bindex</span><span class="p">:</span><span class="n">eindex</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">mat1</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[:,</span> <span class="n">bindex</span><span class="p">:</span><span class="n">eindex</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">shift_chunk</span> <span class="o">=</span> <span class="n">f_alias</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">,</span> <span class="n">mat1</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">win_size</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span>
                                  <span class="n">block</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">norm</span><span class="p">)</span>
            <span class="n">shifts</span><span class="p">[</span><span class="n">bindex</span><span class="p">:</span><span class="n">eindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift_chunk</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">list_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">height</span> <span class="o">-</span> <span class="n">edge</span><span class="p">),</span> <span class="n">num_chunk</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">list_index</span><span class="p">:</span>
            <span class="n">bindex</span><span class="p">,</span> <span class="n">eindex</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="p">[:,</span> <span class="n">bindex</span> <span class="o">-</span> <span class="n">edge</span><span class="p">:</span><span class="n">eindex</span> <span class="o">+</span> <span class="n">edge</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">mat1</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[:,</span> <span class="n">bindex</span> <span class="o">-</span> <span class="n">edge</span><span class="p">:</span><span class="n">eindex</span> <span class="o">+</span> <span class="n">edge</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">shift_chunk</span> <span class="o">=</span> <span class="n">f_alias</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">,</span> <span class="n">mat1</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">win_size</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span>
                                  <span class="n">block</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">norm</span><span class="p">)</span>
            <span class="n">shifts</span><span class="p">[</span><span class="n">bindex</span><span class="p">:</span><span class="n">eindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift_chunk</span>
    <span class="k">return</span> <span class="n">shifts</span>


<span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">__gen_2d_corr_map_2d_input</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">coef_mat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU-kernel function to generate a correlation map between two images where</span>
<span class="sd">    the second image is smaller than the first image.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        2D array. The first image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        2D array. The second image.</span>
<span class="sd">    coef_mat : array_like</span>
<span class="sd">        2D array of zeros, loaded from GPU global memory</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">        2D array. Calculated coefficient map.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">height0</span><span class="p">,</span> <span class="n">width0</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="p">(</span><span class="n">height1</span><span class="p">,</span> <span class="n">width1</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">height2</span><span class="p">,</span> <span class="n">width2</span> <span class="o">=</span> <span class="n">height0</span> <span class="o">-</span> <span class="n">height1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">width0</span> <span class="o">-</span> <span class="n">width1</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">mat_mean</span> <span class="o">=</span> <span class="n">__mean_2d</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="n">mat_sqr</span> <span class="o">=</span> <span class="n">__sum_square_2d</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">mat_mean</span><span class="p">)</span>
    <span class="c1"># coef_mat is at GPU global memory with the size of (height2, width2)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width2</span><span class="p">):</span>
            <span class="n">row0</span><span class="p">,</span> <span class="n">row1</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">height1</span>
            <span class="n">col0</span><span class="p">,</span> <span class="n">col1</span> <span class="o">=</span> <span class="n">j</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="n">width1</span>
            <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="p">[</span><span class="n">row0</span><span class="p">:</span><span class="n">row1</span><span class="p">,</span> <span class="n">col0</span><span class="p">:</span><span class="n">col1</span><span class="p">]</span>
            <span class="n">ref_mean</span> <span class="o">=</span> <span class="n">__mean_2d</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">)</span>
            <span class="n">ref_sqr</span> <span class="o">=</span> <span class="n">__sum_square_2d</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">,</span> <span class="n">ref_mean</span><span class="p">)</span>
            <span class="n">sum_mul</span> <span class="o">=</span> <span class="n">__sum_multiply_2d</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">ref_mean</span><span class="p">,</span> <span class="n">mat_mean</span><span class="p">)</span>
            <span class="n">num</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ref_sqr</span> <span class="o">*</span> <span class="n">mat_sqr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">coef_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_mul</span> <span class="o">/</span> <span class="n">num</span>
    <span class="k">return</span> <span class="n">coef_mat</span>


<span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">__gen_2d_corr_map_3d_input</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">coef_mat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU-kernel function to generate a correlation map between two stacks of</span>
<span class="sd">    images where the number of images are the same but the image size of the</span>
<span class="sd">    second stack is smaller than the first one.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        3D array. The first image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        3D array. The second image.</span>
<span class="sd">    coef_mat : array_like</span>
<span class="sd">        2D array, loaded from GPU global memory.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">        2D array. Calculated coefficient map.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">height0</span><span class="p">,</span> <span class="n">width0</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">height1</span><span class="p">,</span> <span class="n">width1</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">height2</span><span class="p">,</span> <span class="n">width2</span> <span class="o">=</span> <span class="n">height0</span> <span class="o">-</span> <span class="n">height1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">width0</span> <span class="o">-</span> <span class="n">width1</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">mat_mean</span> <span class="o">=</span> <span class="n">__mean_3d</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="n">mat_sqr</span> <span class="o">=</span> <span class="n">__sum_square_3d</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">mat_mean</span><span class="p">)</span>
    <span class="c1"># coef_mat is at GPU global memory with the size of (height2, width2)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width2</span><span class="p">):</span>
            <span class="n">row0</span><span class="p">,</span> <span class="n">row1</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">height1</span>
            <span class="n">col0</span><span class="p">,</span> <span class="n">col1</span> <span class="o">=</span> <span class="n">j</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="n">width1</span>
            <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="p">[:,</span> <span class="n">row0</span><span class="p">:</span><span class="n">row1</span><span class="p">,</span> <span class="n">col0</span><span class="p">:</span><span class="n">col1</span><span class="p">]</span>
            <span class="n">ref_mean</span> <span class="o">=</span> <span class="n">__mean_3d</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">)</span>
            <span class="n">ref_sqr</span> <span class="o">=</span> <span class="n">__sum_square_3d</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">,</span> <span class="n">ref_mean</span><span class="p">)</span>
            <span class="n">sum_mul</span> <span class="o">=</span> <span class="n">__sum_multiply_3d</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">ref_mean</span><span class="p">,</span> <span class="n">mat_mean</span><span class="p">)</span>
            <span class="n">num</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ref_sqr</span> <span class="o">*</span> <span class="n">mat_sqr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">coef_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_mul</span> <span class="o">/</span> <span class="n">num</span>
    <span class="k">return</span> <span class="n">coef_mat</span>


<span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">__locate_max_value</span><span class="p">(</span><span class="n">mat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU-kernel function to find the indices of the maximum value of a 2D array.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        2D array.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of two floats.</span>
<span class="sd">        (column-index, row-index)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">x_max</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">y_max</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">val_max</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">y_max</span><span class="p">,</span> <span class="n">x_max</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">val_max</span><span class="p">:</span>
                <span class="n">y_max</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">x_max</span> <span class="o">=</span> <span class="n">j</span>
                <span class="n">val_max</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">return</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span>


<span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">__get_max_value</span><span class="p">(</span><span class="n">mat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU-kernel function to find the maximum value of a 2D array.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        2D array.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of two floats.</span>
<span class="sd">        (column-index, row-index)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">val_max</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">val_max</span><span class="p">:</span>
                <span class="n">val_max</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">return</span> <span class="n">val_max</span>


<span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">__inverse_values</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">val_max</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU-kernel function to inverse values of a 2D array.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        2D array.</span>
<span class="sd">    val_mat : float</span>
<span class="sd">        Maximum value of the array.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width</span><span class="p">):</span>
            <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_max</span> <span class="o">-</span> <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">mat</span>


<span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">__locate_2d_peak_kernel</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU-kernel function to locate the position of the maximum value of a</span>
<span class="sd">    2d-array with sub-pixel accuracy (Ref. [1]).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        2D array.</span>
<span class="sd">    x0 : int</span>
<span class="sd">        Column index of the maximum value.</span>
<span class="sd">    y0 : int</span>
<span class="sd">        Row index of the maximum value.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of two floats</span>
<span class="sd">        Sub-pixel position (x, y), i.e. (column, row), of the maximum value.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    [1] : https://doi.org/10.48550/arXiv.0712.4289</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">height1</span> <span class="o">=</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">width1</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">d1fx</span><span class="p">,</span> <span class="n">d2fx</span><span class="p">,</span> <span class="n">d1fy</span><span class="p">,</span> <span class="n">d2fy</span><span class="p">,</span> <span class="n">d1fxy</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
    <span class="n">x_pos</span> <span class="o">=</span> <span class="n">x0</span>
    <span class="n">y_pos</span> <span class="o">=</span> <span class="n">y0</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">x0</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">x0</span> <span class="o">==</span> <span class="n">width1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">height1</span> <span class="o">&gt;</span> <span class="n">y0</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">d1fy</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">y0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x0</span><span class="p">]</span> <span class="o">-</span> <span class="n">mat</span><span class="p">[</span><span class="n">y0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">d2fy</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">y0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x0</span><span class="p">]</span> <span class="o">+</span> <span class="n">mat</span><span class="p">[</span><span class="n">y0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mat</span><span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span><span class="p">])</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y0</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">y0</span> <span class="o">==</span> <span class="n">height1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">width1</span> <span class="o">&gt;</span> <span class="n">x0</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">d1fx</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mat</span><span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">d2fx</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">mat</span><span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mat</span><span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span><span class="p">])</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">height1</span> <span class="o">&gt;</span> <span class="n">y0</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">width1</span> <span class="o">&gt;</span> <span class="n">x0</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">d1fx</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mat</span><span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">d1fy</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">y0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x0</span><span class="p">]</span> <span class="o">-</span> <span class="n">mat</span><span class="p">[</span><span class="n">y0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x0</span><span class="p">])</span>
        <span class="n">d2fx</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">mat</span><span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mat</span><span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span><span class="p">])</span>
        <span class="n">d2fy</span> <span class="o">=</span> <span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">y0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x0</span><span class="p">]</span> <span class="o">+</span> <span class="n">mat</span><span class="p">[</span><span class="n">y0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mat</span><span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">x0</span><span class="p">])</span>
        <span class="n">d1fxy</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">y0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">mat</span><span class="p">[</span><span class="n">y0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mat</span><span class="p">[</span>
            <span class="n">y0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mat</span><span class="p">[</span><span class="n">y0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">d1fxy</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">d2fx</span> <span class="o">*</span> <span class="n">d2fy</span>
    <span class="k">if</span> <span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">x_off</span> <span class="o">=</span> <span class="p">(</span><span class="n">d2fy</span> <span class="o">*</span> <span class="n">d1fx</span> <span class="o">-</span> <span class="n">d1fxy</span> <span class="o">*</span> <span class="n">d1fy</span><span class="p">)</span> <span class="o">/</span> <span class="n">num</span>
        <span class="n">y_off</span> <span class="o">=</span> <span class="p">(</span><span class="n">d2fx</span> <span class="o">*</span> <span class="n">d1fy</span> <span class="o">-</span> <span class="n">d1fxy</span> <span class="o">*</span> <span class="n">d1fx</span><span class="p">)</span> <span class="o">/</span> <span class="n">num</span>
        <span class="k">if</span> <span class="mf">1.0</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x_off</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">x_pos</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">x_off</span>
        <span class="k">if</span> <span class="mf">1.0</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y_off</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">y_pos</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">y_off</span>
    <span class="k">return</span> <span class="n">x_pos</span><span class="p">,</span> <span class="n">y_pos</span>


<span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">_get_2d_shift_multi_rows_2d_input_kernel</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span> <span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">coef_4d</span><span class="p">,</span>
                                             <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">radi</span><span class="p">,</span> <span class="n">margin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU-CPU function to find local (y,x)-shifts of the second image against</span>
<span class="sd">    the reference image.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    shifts : array_like</span>
<span class="sd">        Two of 2D arrays of zeros, initialized at CPU.</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        2D array. Reference image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        2D array. The 2nd image. Must be the same size as the reference image.</span>
<span class="sd">    coef_4d : array_like</span>
<span class="sd">        4D array of zeros, initialized at CPU.</span>
<span class="sd">    height : int</span>
<span class="sd">        Height of the image.</span>
<span class="sd">    width : int</span>
<span class="sd">        Width of the image.</span>
<span class="sd">    radi : int</span>
<span class="sd">        Radius of the window to select a local area of the image.</span>
<span class="sd">    margin : int</span>
<span class="sd">        To define the size of the area of the reference image for sliding.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">        Update of the (y,x)-shifting images passed from CPU.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">x_index</span><span class="p">,</span> <span class="n">y_index</span><span class="p">)</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y_index</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x_index</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">):</span>
        <span class="n">radi_ref</span> <span class="o">=</span> <span class="n">radi</span> <span class="o">+</span> <span class="n">margin</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">x_index</span> <span class="o">+</span> <span class="n">radi_ref</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">y_index</span> <span class="o">+</span> <span class="n">radi_ref</span>
        <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">radi_ref</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">radi_ref</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                           <span class="n">j</span> <span class="o">-</span> <span class="n">radi_ref</span><span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">radi_ref</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">mat1</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">radi</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">radi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">radi</span><span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">radi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">coef_mat1</span> <span class="o">=</span> <span class="n">coef_4d</span><span class="p">[</span><span class="n">y_index</span><span class="p">,</span> <span class="n">x_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">coef_mat1</span> <span class="o">=</span> <span class="n">__gen_2d_corr_map_2d_input</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">,</span> <span class="n">mat1</span><span class="p">,</span> <span class="n">coef_mat1</span><span class="p">)</span>
        <span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">__locate_max_value</span><span class="p">(</span><span class="n">coef_mat1</span><span class="p">)</span>
        <span class="n">x_pos</span><span class="p">,</span> <span class="n">y_pos</span> <span class="o">=</span> <span class="n">__locate_2d_peak_kernel</span><span class="p">(</span><span class="n">coef_mat1</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span>
        <span class="n">shifts</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_index</span><span class="p">,</span> <span class="n">x_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_pos</span> <span class="o">-</span> <span class="n">margin</span>
        <span class="n">shifts</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">y_index</span><span class="p">,</span> <span class="n">x_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_pos</span> <span class="o">-</span> <span class="n">margin</span>


<span class="k">def</span> <span class="nf">_get_2d_shift_multi_rows_2d_input_gpu</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">win_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                          <span class="n">block</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">pad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">norm</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Using gpu to find local (y,x)-shifts of the second image against the</span>
<span class="sd">    reference image where their shapes are the same. Each (y,x)-shifting value</span>
<span class="sd">    is associated with a pixel-location of the second image. The value is</span>
<span class="sd">    determined by selecting a small area of the second image, defined by the</span>
<span class="sd">    &#39;win_size&#39; parameter, and sliding (y,x-direction) over a slightly larger</span>
<span class="sd">    area of the reference image, defined by the &#39;win_size&#39; and &#39;margin&#39;</span>
<span class="sd">    parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        2D array. Reference image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        2D array. The 2nd image. Must be the same size as the reference image.</span>
<span class="sd">    win_size : int</span>
<span class="sd">        To define the size of the area around the selected pixel of the 2nd</span>
<span class="sd">        image.</span>
<span class="sd">    margin : int</span>
<span class="sd">        To define the size of the area of the reference image for sliding,</span>
<span class="sd">        i.e. size = 2 * margin + win_size</span>
<span class="sd">    block : tuple of two integer-values, optional</span>
<span class="sd">        Size of a GPU block. E.g. (4,4), (8, 8), ...</span>
<span class="sd">    pad : bool, optional</span>
<span class="sd">        Pad the result to the same as the original images.</span>
<span class="sd">    norm : bool, optional</span>
<span class="sd">        Normalize the input images if True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of two 2d-arrays</span>
<span class="sd">        x-shift array and y-shift array. Zeros at the outer area of the size of</span>
<span class="sd">        (margin + win_size // 2) if using the pad option.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data shape must be the same !!!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inputs must be 2d-arrays !!!&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">win_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">radi</span> <span class="o">=</span> <span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">edge</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">radi</span> <span class="o">+</span> <span class="n">margin</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">height1</span><span class="p">,</span> <span class="n">width1</span> <span class="o">=</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">edge</span><span class="p">,</span> <span class="n">width</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">edge</span>
    <span class="k">if</span> <span class="n">width1</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">height1</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Shapes of the inputs </span><span class="si">{0}</span><span class="s2"> are smaller than the &quot;</span>
                         <span class="s2">&quot;requested size (win_size + 2*margin) = &quot;</span>
                         <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">edge</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">norm</span><span class="p">:</span>
        <span class="n">ref_mat</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">)</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">height1</span><span class="p">,</span> <span class="n">width1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">width1</span> <span class="o">/</span> <span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">height1</span> <span class="o">/</span> <span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
    <span class="n">f_alias</span> <span class="o">=</span> <span class="n">_get_2d_shift_multi_rows_2d_input_kernel</span>
    <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">))</span>
    <span class="n">mat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span>
    <span class="n">coef_4d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height1</span><span class="p">,</span> <span class="n">width1</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">f_alias</span><span class="p">[</span><span class="n">grid</span><span class="p">,</span> <span class="n">block</span><span class="p">](</span><span class="n">shifts</span><span class="p">,</span> <span class="n">ref_mat1</span><span class="p">,</span> <span class="n">mat1</span><span class="p">,</span> <span class="n">coef_4d</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">height1</span><span class="p">),</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">width1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">radi</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">margin</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">pad</span><span class="p">:</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">edge</span><span class="p">),</span> <span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">edge</span><span class="p">)),</span>
                        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shifts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shifts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_get_2d_shift_full_image_2d_input_gpu</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                          <span class="n">win_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                          <span class="n">block</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                          <span class="n">norm_global</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU function to find local (y,x)-shifts of the second image against the</span>
<span class="sd">    reference image where their shapes are the same and their size may be</span>
<span class="sd">    too big for GPU memory. Each (y,x)-shifting value is associated with a</span>
<span class="sd">    pixel-location of the second image. The value is determined by selecting</span>
<span class="sd">    a small area of the second image, defined by the &#39;win_size&#39; parameter, and</span>
<span class="sd">    sliding (y,x-direction) over a slightly larger area of the reference image,</span>
<span class="sd">    defined by the &#39;win_size&#39; and &#39;margin&#39; parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        2D array, can be a numpy array or hdf object. Reference image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        2D array, can be a numpy array or hdf object. The 2nd image. Must be</span>
<span class="sd">        the same size as the reference image.</span>
<span class="sd">    chunk_size : int or None</span>
<span class="sd">        Size of each chunk extracted along the height of the image.</span>
<span class="sd">    win_size : int</span>
<span class="sd">        To define the size of the area around the selected pixel of the 2nd</span>
<span class="sd">        image.</span>
<span class="sd">    margin : int</span>
<span class="sd">        To define the size of the area of the reference image for</span>
<span class="sd">        sliding, i.e. size = 2 * margin + win_size</span>
<span class="sd">    block : tuple of two integer-values, optional</span>
<span class="sd">        Size of a GPU block. E.g. (4,4), (8, 8), ...</span>
<span class="sd">    norm : bool, optional</span>
<span class="sd">        Normalize the input images if True.</span>
<span class="sd">    norm_global : bool, optional</span>
<span class="sd">        Normalize by using the full size of the inputs if True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of two 2d-arrays</span>
<span class="sd">        x-shift array and y-shift array. Zeros at the outer area of the size of</span>
<span class="sd">        (margin + win_size // 2).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data shape must be the same !!!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inputs must be 2d-arrays !!!&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">chunk_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">height</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
    <span class="n">num_chunk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">height</span> <span class="o">//</span> <span class="n">chunk_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
    <span class="n">edge</span> <span class="o">=</span> <span class="n">margin</span> <span class="o">+</span> <span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">edge</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Height of the inputs </span><span class="si">{0}</span><span class="s2"> are smaller than the &quot;</span>
                         <span class="s2">&quot;requested size (win_size + 2*margin + 1) = &quot;</span>
                         <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2"> x </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">edge</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">list_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">height</span> <span class="o">-</span> <span class="n">edge</span><span class="p">),</span> <span class="n">num_chunk</span><span class="p">)</span>
    <span class="n">x_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">y_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">f_alias</span> <span class="o">=</span> <span class="n">_get_2d_shift_multi_rows_2d_input_gpu</span>
    <span class="k">if</span> <span class="n">norm_global</span><span class="p">:</span>
        <span class="n">ref_mat</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">)</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">list_index</span><span class="p">:</span>
        <span class="n">bindex</span><span class="p">,</span> <span class="n">eindex</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="p">[</span><span class="n">bindex</span> <span class="o">-</span> <span class="n">edge</span><span class="p">:</span><span class="n">eindex</span> <span class="o">+</span> <span class="n">edge</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">mat1</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">bindex</span> <span class="o">-</span> <span class="n">edge</span><span class="p">:</span><span class="n">eindex</span> <span class="o">+</span> <span class="n">edge</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">shift_chunk</span> <span class="o">=</span> <span class="n">f_alias</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">,</span> <span class="n">mat1</span><span class="p">,</span> <span class="n">win_size</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span>
                              <span class="kc">False</span><span class="p">,</span> <span class="n">norm</span><span class="p">)</span>
        <span class="n">x_shifts</span><span class="p">[</span><span class="n">bindex</span><span class="p">:</span><span class="n">eindex</span><span class="p">,</span> <span class="n">edge</span><span class="p">:</span><span class="o">-</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift_chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_shifts</span><span class="p">[</span><span class="n">bindex</span><span class="p">:</span><span class="n">eindex</span><span class="p">,</span> <span class="n">edge</span><span class="p">:</span><span class="o">-</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift_chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">x_shifts</span><span class="p">,</span> <span class="n">y_shifts</span>


<span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">_get_2d_shift_multi_rows_3d_input_kernel</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span> <span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">coef_4d</span><span class="p">,</span>
                                             <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">radi</span><span class="p">,</span> <span class="n">margin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU-CPU function to find local (y,x)-shifts of the second 3d-image against</span>
<span class="sd">    the reference 3d-image.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    shifts : array_like</span>
<span class="sd">        Two of 2D arrays of zeros, initialized at CPU.</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        3D array. Reference image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        3D array. The 2nd image. Must be the same size as the reference image.</span>
<span class="sd">    coef_4d : array_like</span>
<span class="sd">        4D array of zeros, initialized at CPU.</span>
<span class="sd">    height : int</span>
<span class="sd">        Height of the image.</span>
<span class="sd">    width : int</span>
<span class="sd">        Width of the image.</span>
<span class="sd">    radi : int</span>
<span class="sd">        Radius of the window to select a local area of the image.</span>
<span class="sd">    margin : int</span>
<span class="sd">        To define the size of the area of the reference image for sliding.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">        Update of the (y,x)-shifting images passed from CPU.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">x_index</span><span class="p">,</span> <span class="n">y_index</span><span class="p">)</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y_index</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x_index</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">):</span>
        <span class="n">radi_ref</span> <span class="o">=</span> <span class="n">margin</span> <span class="o">+</span> <span class="n">radi</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">x_index</span> <span class="o">+</span> <span class="n">radi_ref</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">y_index</span> <span class="o">+</span> <span class="n">radi_ref</span>
        <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">radi_ref</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">radi_ref</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                           <span class="n">j</span> <span class="o">-</span> <span class="n">radi_ref</span><span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">radi_ref</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">mat1</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">radi</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">radi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">radi</span><span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">radi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">coef_mat1</span> <span class="o">=</span> <span class="n">coef_4d</span><span class="p">[</span><span class="n">y_index</span><span class="p">,</span> <span class="n">x_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">coef_mat1</span> <span class="o">=</span> <span class="n">__gen_2d_corr_map_3d_input</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">,</span> <span class="n">mat1</span><span class="p">,</span> <span class="n">coef_mat1</span><span class="p">)</span>
        <span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">__locate_max_value</span><span class="p">(</span><span class="n">coef_mat1</span><span class="p">)</span>
        <span class="n">x_pos</span><span class="p">,</span> <span class="n">y_pos</span> <span class="o">=</span> <span class="n">__locate_2d_peak_kernel</span><span class="p">(</span><span class="n">coef_mat1</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span>
        <span class="n">shifts</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_index</span><span class="p">,</span> <span class="n">x_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_pos</span> <span class="o">-</span> <span class="n">margin</span>
        <span class="n">shifts</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">y_index</span><span class="p">,</span> <span class="n">x_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_pos</span> <span class="o">-</span> <span class="n">margin</span>


<span class="k">def</span> <span class="nf">_get_2d_shift_multi_rows_3d_input_gpu</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">win_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                          <span class="n">block</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">pad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">norm</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU function to find local (y,x)-shifts of the second 3d-image against the</span>
<span class="sd">    reference 3d-image where their shapes are the same. Each (y,x)-shifting</span>
<span class="sd">    value is associated with a pixel-location of the second image. The value is</span>
<span class="sd">    determined by selecting a small volume of the second image, defined by</span>
<span class="sd">    the &#39;win_size&#39; parameter, and sliding (y,x only) over a slightly larger</span>
<span class="sd">    volume of the reference image, defined by the &#39;win_size&#39; and &#39;margin&#39;</span>
<span class="sd">    parameters. This function may be computational expensive.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        3D array. Reference image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        3D array. The 2nd image. Must be the same size as the reference image.</span>
<span class="sd">    win_size : int</span>
<span class="sd">        To define the size of the image volume around the selected pixel of the</span>
<span class="sd">        2nd image.</span>
<span class="sd">    margin : int</span>
<span class="sd">        To define the size of the selected volume of the reference image for</span>
<span class="sd">        sliding i.e. size = 2 * margin + win_size</span>
<span class="sd">    block : tuple of two integer-values, optional</span>
<span class="sd">        Size of a GPU block. E.g. (4,4), (8, 8), ...</span>
<span class="sd">    pad : bool, optional</span>
<span class="sd">        Padding the result to the same as the original images.</span>
<span class="sd">    norm : bool, optional</span>
<span class="sd">        Normalizing the inputs.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of two 2d-arrays</span>
<span class="sd">        x-shift array and y-shift array, corresponding to the pixel-locations</span>
<span class="sd">        in the 2nd image where the starting location is at</span>
<span class="sd">        (margin + win_size/2, margin + win_size/2). Using the pad option to</span>
<span class="sd">        make it easier to find which value corresponding to</span>
<span class="sd">        which pixel-location.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data shape must be the same !!!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inputs must be 3d-arrays !!!&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">win_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">radi</span> <span class="o">=</span> <span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">edge</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">radi</span> <span class="o">+</span> <span class="n">margin</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">height1</span><span class="p">,</span> <span class="n">width1</span> <span class="o">=</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">edge</span><span class="p">,</span> <span class="n">width</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">edge</span>
    <span class="k">if</span> <span class="n">width1</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">height1</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">width1</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">height1</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Shapes of the inputs </span><span class="si">{0}</span><span class="s2"> are smaller than the &quot;</span>
                             <span class="s2">&quot;requested size (win_size + 2*margin) = &quot;</span>
                             <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">edge</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">norm</span><span class="p">:</span>
        <span class="n">ref_mat</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">)</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">height1</span><span class="p">,</span> <span class="n">width1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">width1</span> <span class="o">/</span> <span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">height1</span> <span class="o">/</span> <span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
    <span class="n">f_alias</span> <span class="o">=</span> <span class="n">_get_2d_shift_multi_rows_3d_input_kernel</span>
    <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">))</span>
    <span class="n">mat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span>
    <span class="n">coef_4d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height1</span><span class="p">,</span> <span class="n">width1</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">f_alias</span><span class="p">[</span><span class="n">grid</span><span class="p">,</span> <span class="n">block</span><span class="p">](</span><span class="n">shifts</span><span class="p">,</span> <span class="n">ref_mat1</span><span class="p">,</span> <span class="n">mat1</span><span class="p">,</span> <span class="n">coef_4d</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">height1</span><span class="p">),</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">width1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">radi</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">margin</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">pad</span><span class="p">:</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">edge</span><span class="p">),</span> <span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">edge</span><span class="p">)),</span>
                        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shifts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shifts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_get_2d_shift_full_image_3d_input_gpu</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                          <span class="n">win_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                          <span class="n">block</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                          <span class="n">norm_global</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU function to find local (y,x)-shifts of the second 3d-image against the</span>
<span class="sd">    reference 3d-image where their shapes are the same and their size may be</span>
<span class="sd">    too big for memory. Each (y,x)-shifting value is associated with a</span>
<span class="sd">    pixel-location of the second image. The value is determined by selecting a</span>
<span class="sd">    small volume of the second image, defined by the &#39;win_size&#39; parameter, and</span>
<span class="sd">    sliding (y,x only) over a slightly larger volume of the reference image,</span>
<span class="sd">    defined by the &#39;win_size&#39; and &#39;margin&#39; parameters. This function may be</span>
<span class="sd">    computational expensive.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        3D array, can be a numpy array or hdf object. Reference image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        3D array, can be a numpy array or hdf object. The 2nd image. Must be</span>
<span class="sd">        the same size as the reference image.</span>
<span class="sd">    chunk_size : int or None</span>
<span class="sd">        Size of each chunk extracted along the height of the image.</span>
<span class="sd">    win_size : int</span>
<span class="sd">        To define the size of the area around the selected pixel of the 2nd</span>
<span class="sd">        image.</span>
<span class="sd">    margin : int</span>
<span class="sd">        To define the size of the area of the reference image for</span>
<span class="sd">        sliding, i.e. size = 2 * margin + win_size</span>
<span class="sd">    block : tuple of two integer-values, optional</span>
<span class="sd">        Size of a GPU block. E.g. (4,4), (8, 8), ...</span>
<span class="sd">    norm : bool, optional</span>
<span class="sd">        Normalize the input images if True.</span>
<span class="sd">    norm_global : bool, optional</span>
<span class="sd">        Normalize by using the full size of the inputs if True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of two 2d-arrays</span>
<span class="sd">        x-shift array and y-shift array. Zeros at the outer area of the size of</span>
<span class="sd">        (margin + win_size // 2).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data shape must be the same !!!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inputs must be 3d-arrays !!!&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">chunk_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">height</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
    <span class="n">num_chunk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">height</span> <span class="o">//</span> <span class="n">chunk_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
    <span class="n">edge</span> <span class="o">=</span> <span class="n">margin</span> <span class="o">+</span> <span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">edge</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Height of the inputs </span><span class="si">{0}</span><span class="s2"> are smaller than the &quot;</span>
                         <span class="s2">&quot;requested size (win_size + 2*margin + 1) = &quot;</span>
                         <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2"> x </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">edge</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">list_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">height</span> <span class="o">-</span> <span class="n">edge</span><span class="p">),</span> <span class="n">num_chunk</span><span class="p">)</span>
    <span class="n">x_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">y_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">f_alias</span> <span class="o">=</span> <span class="n">_get_2d_shift_multi_rows_3d_input_gpu</span>
    <span class="k">if</span> <span class="n">norm_global</span><span class="p">:</span>
        <span class="n">ref_mat</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">)</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">list_index</span><span class="p">:</span>
        <span class="n">bindex</span><span class="p">,</span> <span class="n">eindex</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="p">[:,</span> <span class="n">bindex</span> <span class="o">-</span> <span class="n">edge</span><span class="p">:</span><span class="n">eindex</span> <span class="o">+</span> <span class="n">edge</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">mat1</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[:,</span> <span class="n">bindex</span> <span class="o">-</span> <span class="n">edge</span><span class="p">:</span><span class="n">eindex</span> <span class="o">+</span> <span class="n">edge</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">shift_chunk</span> <span class="o">=</span> <span class="n">f_alias</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">,</span> <span class="n">mat1</span><span class="p">,</span> <span class="n">win_size</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span>
                              <span class="kc">False</span><span class="p">,</span> <span class="n">norm</span><span class="p">)</span>
        <span class="n">x_shifts</span><span class="p">[</span><span class="n">bindex</span><span class="p">:</span><span class="n">eindex</span><span class="p">,</span> <span class="n">edge</span><span class="p">:</span><span class="o">-</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift_chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_shifts</span><span class="p">[</span><span class="n">bindex</span><span class="p">:</span><span class="n">eindex</span><span class="p">,</span> <span class="n">edge</span><span class="p">:</span><span class="o">-</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift_chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">x_shifts</span><span class="p">,</span> <span class="n">y_shifts</span>


<span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">_generate_4d_correlation_map_3d_input_kernel</span><span class="p">(</span><span class="n">coef_4d</span><span class="p">,</span> <span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span>
                                                 <span class="n">width</span><span class="p">,</span> <span class="n">radi</span><span class="p">,</span> <span class="n">margin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU-CPU function to calculate 2D correlation maps for each pixel location</span>
<span class="sd">    in height and width -&gt; 4D array.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    coef_4d : array_like</span>
<span class="sd">        4D array of zeros, initialized at CPU.</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        3D array. Reference image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        3D array. The 2nd image. Must be the same size as the reference image.</span>
<span class="sd">    height : int</span>
<span class="sd">        Height of the image.</span>
<span class="sd">    width : int</span>
<span class="sd">        Width of the image.</span>
<span class="sd">    radi : int</span>
<span class="sd">        Radius of the window to select a local area of the image.</span>
<span class="sd">    margin : int</span>
<span class="sd">        To define the size of the area of the reference image for sliding.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">        Updated of 4D correlation map.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">x_index</span><span class="p">,</span> <span class="n">y_index</span><span class="p">)</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y_index</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x_index</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">):</span>
        <span class="n">radi_ref</span> <span class="o">=</span> <span class="n">margin</span> <span class="o">+</span> <span class="n">radi</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">x_index</span> <span class="o">+</span> <span class="n">radi_ref</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">y_index</span> <span class="o">+</span> <span class="n">radi_ref</span>
        <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">radi_ref</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">radi_ref</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                           <span class="n">j</span> <span class="o">-</span> <span class="n">radi_ref</span><span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">radi_ref</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">mat1</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">radi</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">radi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">radi</span><span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">radi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">coef_mat1</span> <span class="o">=</span> <span class="n">coef_4d</span><span class="p">[</span><span class="n">y_index</span><span class="p">,</span> <span class="n">x_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">coef_mat1</span> <span class="o">=</span> <span class="n">__gen_2d_corr_map_3d_input</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">,</span> <span class="n">mat1</span><span class="p">,</span> <span class="n">coef_mat1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
                <span class="n">coef_4d</span><span class="p">[</span><span class="n">y_index</span><span class="p">,</span> <span class="n">x_index</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">coef_mat1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_get_2d_shift_multi_rows_3d_input_cpu_gpu</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">win_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                                              <span class="n">margin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                              <span class="n">block</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">pad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                              <span class="n">ncore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combine GPU and CPU to find local (y,x)-shifts of the second 3d-image</span>
<span class="sd">    against the reference 3d-image where their shapes are the same.</span>
<span class="sd">    Each (y,x)-shifting value is associated with a pixel-location of the second</span>
<span class="sd">    image. The value is determined by selecting a small volume of the second</span>
<span class="sd">    image, defined by the &#39;win_size&#39; parameter, and sliding (y,x only) over a</span>
<span class="sd">    slightly larger volume of the reference image, defined by the &#39;win_size&#39;</span>
<span class="sd">    and &#39;margin&#39; parameters. This function may be computational expensive.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        3D array. Reference image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        3D array. The 2nd image. Must be the same size as the reference image.</span>
<span class="sd">    win_size : int</span>
<span class="sd">        To define the size of the image volume around the selected pixel of the</span>
<span class="sd">        2nd image.</span>
<span class="sd">    margin : int</span>
<span class="sd">        To define the size of the selected volume of the reference image for</span>
<span class="sd">        sliding i.e. size = 2 * margin + win_size</span>
<span class="sd">    method : {&quot;diff&quot;, &quot;poly_fit&quot;}</span>
<span class="sd">        Method for finding sub-pixel shift. Two options: a differential</span>
<span class="sd">        method (Ref. [1]) or a polynomial method (Ref. [2]).</span>
<span class="sd">    size : int</span>
<span class="sd">        Window size around the integer location of the maximum value used for</span>
<span class="sd">        sub-pixel searching.</span>
<span class="sd">    block : tuple of two integer-values, optional</span>
<span class="sd">        Size of a GPU block. E.g. (4,4), (8, 8), ...</span>
<span class="sd">    pad : bool, optional</span>
<span class="sd">        Padding the result to the same as the original images.</span>
<span class="sd">    ncore : int or None</span>
<span class="sd">        Number of cpu-cores used for computing. Automatically selected if None.</span>
<span class="sd">    norm : bool, optional</span>
<span class="sd">        Normalizing the inputs.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of two 2d-arrays</span>
<span class="sd">        x-shift array and y-shift array, corresponding to the pixel-locations</span>
<span class="sd">        in the 2nd image where the starting location is at</span>
<span class="sd">        (margin + win_size/2, margin + win_size/2). Using the pad option to</span>
<span class="sd">        make it easier to find which value corresponding to</span>
<span class="sd">        which pixel-location.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    [1] : https://doi.org/10.48550/arXiv.0712.4289</span>
<span class="sd">    [2] : https://doi.org/10.1088/0957-0233/17/6/045</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data shape must be the same !!!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inputs must be 3d-arrays !!!&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">win_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">radi</span> <span class="o">=</span> <span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">edge</span><span class="p">,</span> <span class="n">size_mag</span> <span class="o">=</span> <span class="n">radi</span> <span class="o">+</span> <span class="n">margin</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">height1</span><span class="p">,</span> <span class="n">width1</span> <span class="o">=</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">edge</span><span class="p">,</span> <span class="n">width</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">edge</span>
    <span class="k">if</span> <span class="n">width1</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">height1</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">width1</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">height1</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Shapes of the inputs </span><span class="si">{0}</span><span class="s2"> are smaller than the &quot;</span>
                             <span class="s2">&quot;requested size (win_size + 2*margin) = &quot;</span>
                             <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">edge</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">norm</span><span class="p">:</span>
        <span class="n">ref_mat</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">)</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">width1</span> <span class="o">/</span> <span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">height1</span> <span class="o">/</span> <span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
    <span class="n">f_alias</span> <span class="o">=</span> <span class="n">_generate_4d_correlation_map_3d_input_kernel</span>
    <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">))</span>
    <span class="n">mat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span>
    <span class="n">coef_4d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height1</span><span class="p">,</span> <span class="n">width1</span><span class="p">,</span> <span class="n">size_mag</span><span class="p">,</span> <span class="n">size_mag</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">f_alias</span><span class="p">[</span><span class="n">grid</span><span class="p">,</span> <span class="n">block</span><span class="p">](</span><span class="n">coef_4d</span><span class="p">,</span> <span class="n">ref_mat1</span><span class="p">,</span> <span class="n">mat1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">height1</span><span class="p">),</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">width1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">radi</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">margin</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">ncore</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ncore</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">ncore</span><span class="p">)(</span>
        <span class="n">delayed</span><span class="p">(</span><span class="n">locate_peak</span><span class="p">)(</span><span class="n">coef_4d</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width1</span><span class="p">)))</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">shifts</span><span class="p">),</span> <span class="p">(</span><span class="n">height1</span><span class="p">,</span> <span class="n">width1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">margin</span>
    <span class="k">if</span> <span class="n">pad</span><span class="p">:</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">edge</span><span class="p">),</span> <span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">edge</span><span class="p">)),</span>
                        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shifts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shifts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_get_2d_shift_full_image_3d_input_cpu_gpu</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                              <span class="n">win_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                              <span class="n">method</span><span class="o">=</span><span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                              <span class="n">block</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">ncore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                              <span class="n">norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">norm_global</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combine GPU and CPU to find local (y,x)-shifts of the second 3d-image</span>
<span class="sd">    against the reference 3d-image where their shapes are the same and their</span>
<span class="sd">    size may be too big for memory. Each (y,x)-shifting value is</span>
<span class="sd">    associated with a pixel-location of the second image. The value is</span>
<span class="sd">    determined by selecting a small volume of the second image, defined by</span>
<span class="sd">    the &#39;win_size&#39; parameter, and sliding (y,x only) over a slightly larger</span>
<span class="sd">    volume of the reference image, defined by the &#39;win_size&#39; and &#39;margin&#39;</span>
<span class="sd">    parameters. This function may be computational expensive.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        3D array, can be a numpy array or hdf object. Reference image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        3D array, can be a numpy array or hdf object. The 2nd image. Must be</span>
<span class="sd">        the same size as the reference image.</span>
<span class="sd">    chunk_size : int or None</span>
<span class="sd">        Size of each chunk extracted along the height of the image.</span>
<span class="sd">    win_size : int</span>
<span class="sd">        To define the size of the area around the selected pixel of the 2nd</span>
<span class="sd">        image.</span>
<span class="sd">    margin : int</span>
<span class="sd">        To define the size of the area of the reference image for</span>
<span class="sd">        sliding, i.e. size = 2 * margin + win_size</span>
<span class="sd">    method : {&quot;diff&quot;, &quot;poly_fit&quot;}</span>
<span class="sd">        Method for finding sub-pixel shift. Two options: a differential</span>
<span class="sd">        method (Ref. [1]) or a polynomial method (Ref. [2]).</span>
<span class="sd">    size : int</span>
<span class="sd">        Window size around the integer location of the maximum value used for</span>
<span class="sd">        sub-pixel searching.</span>
<span class="sd">    block : tuple of two integer-values, optional</span>
<span class="sd">        Size of a GPU block. E.g. (4,4), (8, 8), ...</span>
<span class="sd">    pad : bool, optional</span>
<span class="sd">        Padding the result to the same as the original images.</span>
<span class="sd">    ncore : int or None</span>
<span class="sd">        Number of cpu-cores used for computing. Automatically selected if None.</span>
<span class="sd">    norm : bool, optional</span>
<span class="sd">        Normalizing the inputs if True.</span>
<span class="sd">    norm_global : bool, optional</span>
<span class="sd">        Normalize by using the full size of the inputs if True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of two 2d-arrays</span>
<span class="sd">        x-shift array and y-shift array. Zeros at the outer area of the size of</span>
<span class="sd">        (margin + win_size // 2).</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    [1] : https://doi.org/10.48550/arXiv.0712.4289</span>
<span class="sd">    [2] : https://doi.org/10.1088/0957-0233/17/6/045</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data shape must be the same !!!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inputs must be 3d-arrays !!!&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">chunk_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">height</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
    <span class="n">num_chunk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">height</span> <span class="o">//</span> <span class="n">chunk_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
    <span class="n">edge</span> <span class="o">=</span> <span class="n">margin</span> <span class="o">+</span> <span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">edge</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Height of the inputs </span><span class="si">{0}</span><span class="s2"> are smaller than the &quot;</span>
                         <span class="s2">&quot;requested size (win_size + 2*margin + 1) = &quot;</span>
                         <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2"> x </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">edge</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">list_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">height</span> <span class="o">-</span> <span class="n">edge</span><span class="p">),</span> <span class="n">num_chunk</span><span class="p">)</span>
    <span class="n">x_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">y_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">f_alias</span> <span class="o">=</span> <span class="n">_get_2d_shift_multi_rows_3d_input_cpu_gpu</span>
    <span class="k">if</span> <span class="n">norm_global</span><span class="p">:</span>
        <span class="n">ref_mat</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">)</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">list_index</span><span class="p">:</span>
        <span class="n">bindex</span><span class="p">,</span> <span class="n">eindex</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="p">[:,</span> <span class="n">bindex</span> <span class="o">-</span> <span class="n">edge</span><span class="p">:</span><span class="n">eindex</span> <span class="o">+</span> <span class="n">edge</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">mat1</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[:,</span> <span class="n">bindex</span> <span class="o">-</span> <span class="n">edge</span><span class="p">:</span><span class="n">eindex</span> <span class="o">+</span> <span class="n">edge</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">shift_chunk</span> <span class="o">=</span> <span class="n">f_alias</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">,</span> <span class="n">mat1</span><span class="p">,</span> <span class="n">win_size</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
                              <span class="n">block</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">ncore</span><span class="p">,</span> <span class="n">norm</span><span class="p">)</span>
        <span class="n">x_shifts</span><span class="p">[</span><span class="n">bindex</span><span class="p">:</span><span class="n">eindex</span><span class="p">,</span> <span class="n">edge</span><span class="p">:</span><span class="o">-</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift_chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_shifts</span><span class="p">[</span><span class="n">bindex</span><span class="p">:</span><span class="n">eindex</span><span class="p">,</span> <span class="n">edge</span><span class="p">:</span><span class="o">-</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift_chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">x_shifts</span><span class="p">,</span> <span class="n">y_shifts</span>


<div class="viewcode-block" id="find_local_shifts"><a class="viewcode-back" href="../../../toc/api/algotom.util.correlation.html#algotom.util.correlation.find_local_shifts">[docs]</a><span class="k">def</span> <span class="nf">find_local_shifts</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">win_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                      <span class="n">method</span><span class="o">=</span><span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
                      <span class="n">ncore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">norm_global</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">chunk_size</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    To find local shifts (in x and y direction) between two images by selecting</span>
<span class="sd">    a small area/volume of the second image and sliding over a slightly larger</span>
<span class="sd">    area/volume of the reference image.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        2D/3D array, can be a numpy array or hdf object. Reference image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        2D/3D array, can be a numpy array or hdf object. The second image, must</span>
<span class="sd">        be the same size as the reference image.</span>
<span class="sd">    dim : {1, 2}</span>
<span class="sd">        To find the shifts (in x and y) separately or together.</span>
<span class="sd">    win_size : int</span>
<span class="sd">        Size of local areas in the second image.</span>
<span class="sd">    margin : int</span>
<span class="sd">        To define the sliding range of the second image.</span>
<span class="sd">    method : {&quot;diff&quot;, &quot;poly_fit&quot;}</span>
<span class="sd">        Method for finding sub-pixel shift. Two options: a differential</span>
<span class="sd">        method (Ref. [1]) or a polynomial method (Ref. [2]). The &quot;poly_fit&quot;</span>
<span class="sd">        option is not available if using GPU.</span>
<span class="sd">    size : int</span>
<span class="sd">        Window size around the integer location of the maximum value used for</span>
<span class="sd">        sub-pixel location. Adjustable if using the polynomial method.</span>
<span class="sd">    gpu : {False, True, &quot;hybrid&quot;}</span>
<span class="sd">        Use GPU for computing if True or in &quot;hybrid&quot; mode.</span>
<span class="sd">    block : tuple of two integer-values, optional</span>
<span class="sd">        Size of a GPU block. E.g. (8, 8), (16, 16), (32, 32), ...</span>
<span class="sd">    ncore : int or None</span>
<span class="sd">        Number of cpu-cores used for computing. Automatically selected if None.</span>
<span class="sd">    norm : bool, optional</span>
<span class="sd">        Normalizing the inputs if True.</span>
<span class="sd">    norm_global : bool, optional</span>
<span class="sd">        Normalize by using the full size of the inputs if True.</span>
<span class="sd">    chunk_size : int or None</span>
<span class="sd">        Size of each chunk extracted along the height of the image.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of two 2d-arrays</span>
<span class="sd">        x-shift array and y-shift array. Zeros at the outer area of the size of</span>
<span class="sd">        (margin + win_size // 2).</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    [1] : https://doi.org/10.48550/arXiv.0712.4289</span>
<span class="sd">    [2] : https://doi.org/10.1088/0957-0233/17/6/045</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">gpu</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;!!! No Nvidia GPU found !!! Run with CPU instead !!!&quot;</span><span class="p">)</span>
            <span class="n">gpu</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">gpu</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">f_alias</span> <span class="o">=</span> <span class="n">_get_2d_shift_full_image_2d_input</span>
            <span class="p">(</span><span class="n">x_shifts</span><span class="p">,</span> <span class="n">y_shifts</span><span class="p">)</span> <span class="o">=</span> <span class="n">f_alias</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">win_size</span><span class="o">=</span><span class="n">win_size</span><span class="p">,</span>
                                           <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span> <span class="n">sub_pixel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                           <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                           <span class="n">ncore</span><span class="o">=</span><span class="n">ncore</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f_alias</span> <span class="o">=</span> <span class="n">_get_2d_shift_full_image_2d_input_gpu</span>
            <span class="p">(</span><span class="n">x_shifts</span><span class="p">,</span> <span class="n">y_shifts</span><span class="p">)</span> <span class="o">=</span> <span class="n">f_alias</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span>
                                           <span class="n">win_size</span><span class="o">=</span><span class="n">win_size</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span>
                                           <span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">gpu</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">f_alias</span> <span class="o">=</span> <span class="n">_get_1d_shift_full_image_3d_input_cpu</span>
                <span class="n">x_shifts</span> <span class="o">=</span> <span class="n">f_alias</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
                                   <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span> <span class="n">win_size</span><span class="o">=</span><span class="n">win_size</span><span class="p">,</span>
                                   <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span> <span class="n">sub_pixel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">ncore</span><span class="o">=</span><span class="n">ncore</span><span class="p">,</span>
                                   <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">norm_global</span><span class="o">=</span><span class="n">norm_global</span><span class="p">)</span>
                <span class="n">y_shifts</span> <span class="o">=</span> <span class="n">f_alias</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
                                   <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span> <span class="n">win_size</span><span class="o">=</span><span class="n">win_size</span><span class="p">,</span>
                                   <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span> <span class="n">sub_pixel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">ncore</span><span class="o">=</span><span class="n">ncore</span><span class="p">,</span>
                                   <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">norm_global</span><span class="o">=</span><span class="n">norm_global</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f_alias</span> <span class="o">=</span> <span class="n">_get_2d_shift_full_image_3d_input_cpu</span>
                <span class="p">(</span><span class="n">x_shifts</span><span class="p">,</span> <span class="n">y_shifts</span><span class="p">)</span> <span class="o">=</span> <span class="n">f_alias</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span>
                                               <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span>
                                               <span class="n">win_size</span><span class="o">=</span><span class="n">win_size</span><span class="p">,</span>
                                               <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span>
                                               <span class="n">sub_pixel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                                               <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">ncore</span><span class="o">=</span><span class="n">ncore</span><span class="p">,</span>
                                               <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
                                               <span class="n">norm_global</span><span class="o">=</span><span class="n">norm_global</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">gpu</span> <span class="o">==</span> <span class="s2">&quot;Hybrid&quot;</span> <span class="ow">or</span> <span class="n">gpu</span> <span class="o">==</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">:</span>
            <span class="n">f_alias</span> <span class="o">=</span> <span class="n">_get_2d_shift_full_image_3d_input_cpu_gpu</span>
            <span class="p">(</span><span class="n">x_shifts</span><span class="p">,</span> <span class="n">y_shifts</span><span class="p">)</span> <span class="o">=</span> <span class="n">f_alias</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span>
                                           <span class="n">win_size</span><span class="o">=</span><span class="n">win_size</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span>
                                           <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
                                           <span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">,</span> <span class="n">ncore</span><span class="o">=</span><span class="n">ncore</span><span class="p">,</span>
                                           <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">norm_global</span><span class="o">=</span><span class="n">norm_global</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">f_alias</span> <span class="o">=</span> <span class="n">_get_1d_shift_full_image_3d_input_gpu</span>
                <span class="n">x_shifts</span> <span class="o">=</span> <span class="n">f_alias</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
                                   <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span> <span class="n">win_size</span><span class="o">=</span><span class="n">win_size</span><span class="p">,</span>
                                   <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
                                   <span class="n">norm_global</span><span class="o">=</span><span class="n">norm_global</span><span class="p">)</span>
                <span class="n">y_shifts</span> <span class="o">=</span> <span class="n">f_alias</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
                                   <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span> <span class="n">win_size</span><span class="o">=</span><span class="n">win_size</span><span class="p">,</span>
                                   <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
                                   <span class="n">norm_global</span><span class="o">=</span><span class="n">norm_global</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f_alias</span> <span class="o">=</span> <span class="n">_get_2d_shift_full_image_3d_input_gpu</span>
                <span class="p">(</span><span class="n">x_shifts</span><span class="p">,</span> <span class="n">y_shifts</span><span class="p">)</span> <span class="o">=</span> <span class="n">f_alias</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span>
                                               <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span>
                                               <span class="n">win_size</span><span class="o">=</span><span class="n">win_size</span><span class="p">,</span>
                                               <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span>
                                               <span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
                                               <span class="n">norm_global</span><span class="o">=</span><span class="n">norm_global</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">x_shifts</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">y_shifts</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">__get_input_list</span><span class="p">(</span><span class="n">list_ij</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">gap</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Supplementary method for methods of finding global_shift based on</span>
<span class="sd">    local_shifts.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">input_format</span> <span class="o">=</span> <span class="s2">&quot;Please use the format of [i, j] for a single &quot;</span> \
                   <span class="s2">&quot;point or [list_i, list_j] for multiple points&quot;</span>
    <span class="n">box</span> <span class="o">=</span> <span class="p">[[</span><span class="n">gap</span><span class="p">,</span> <span class="n">height</span> <span class="o">-</span> <span class="n">gap</span><span class="p">],</span> <span class="p">[</span><span class="n">gap</span><span class="p">,</span> <span class="n">width</span> <span class="o">-</span> <span class="n">gap</span><span class="p">]]</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The given list of points are not inside the box: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">list_ij</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">list_ij</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> \
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">list_ij</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_ij</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">input_format</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">list_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">list_ij</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">list_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">list_ij</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">list_i</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)</span> <span class="ow">and</span> \
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">list_j</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">height</span> <span class="o">-</span> <span class="n">gap</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">list_i</span> <span class="o">&gt;</span> <span class="n">gap</span><span class="p">)</span> <span class="ow">and</span> \
                        <span class="p">((</span><span class="n">width</span> <span class="o">-</span> <span class="n">gap</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">list_j</span> <span class="o">&gt;</span> <span class="n">gap</span><span class="p">):</span>
                    <span class="n">list_i</span> <span class="o">=</span> <span class="p">[</span><span class="n">list_i</span><span class="p">]</span>
                    <span class="n">list_j</span> <span class="o">=</span> <span class="p">[</span><span class="n">list_j</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">list_i</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)</span> <span class="ow">or</span> \
                        <span class="nb">isinstance</span><span class="p">(</span><span class="n">list_j</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">input_format</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_i</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_j</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Size of each list of indices is not &quot;</span>
                                         <span class="s2">&quot;the same&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">i_tmp</span><span class="p">,</span> <span class="n">j_tmp</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">list_i</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="p">((</span><span class="n">height</span> <span class="o">-</span> <span class="n">gap</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">list_i</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">gap</span><span class="p">)</span> <span class="ow">and</span> \
                                    <span class="p">((</span><span class="n">width</span> <span class="o">-</span> <span class="n">gap</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">list_j</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">gap</span><span class="p">):</span>
                                <span class="n">i_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">list_i</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                                <span class="n">j_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">list_j</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i_tmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">list_i</span><span class="p">,</span> <span class="n">list_j</span> <span class="o">=</span> <span class="n">i_tmp</span><span class="p">,</span> <span class="n">j_tmp</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">input_format</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">list_i</span><span class="p">,</span> <span class="n">list_j</span>


<span class="k">def</span> <span class="nf">_find_global_shift_based_local_shifts_cpu</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">win_size</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span>
                                              <span class="n">list_ij</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_point</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                              <span class="n">global_value</span><span class="o">=</span><span class="s2">&quot;mixed&quot;</span><span class="p">,</span>
                                              <span class="n">sub_pixel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;diff&quot;</span><span class="p">,</span>
                                              <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ncore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                              <span class="n">return_list</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CPU function to find global shift between two images based on finding</span>
<span class="sd">    local shifts.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        2D array. Reference image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        2D array. The 2nd image. Must be the same size as the reference image.</span>
<span class="sd">    win_size : int</span>
<span class="sd">        To define the size of the area around the selected pixel of the 2nd</span>
<span class="sd">        image. E.g. 41, 61, ..</span>
<span class="sd">    margin : int</span>
<span class="sd">        To define the searching range (in pixel) for finding shift.</span>
<span class="sd">        E.g. 20, 30,...</span>
<span class="sd">    list_ij : list of lists of int or None</span>
<span class="sd">        List of indices of points used for local search. Accept the value of</span>
<span class="sd">        [i_index, j_index] for a single point or</span>
<span class="sd">        [[i_index0, i_index1,...], [j_index0, j_index1,...]]</span>
<span class="sd">        for multiple points. Automatically generated if None.</span>
<span class="sd">    num_point : int or None</span>
<span class="sd">        Number of points used for local search if list_ij is None.</span>
<span class="sd">    global_value : {&quot;median&quot;, &quot;mean&quot;, &quot;mixed&quot;}</span>
<span class="sd">        Method for calculating the global value from local values.</span>
<span class="sd">    sub_pixel : bool, optional</span>
<span class="sd">        Enable sub-pixel location.</span>
<span class="sd">    method : {&quot;diff&quot;, &quot;poly_fit&quot;}</span>
<span class="sd">        Method for finding 1d sub-pixel position. Two options: a differential</span>
<span class="sd">        method (Ref. [1]) or a polynomial method (Ref. [2]).</span>
<span class="sd">    size : int, optional</span>
<span class="sd">        Window size around the integer location of the maximum value used for</span>
<span class="sd">        sub-pixel searching.</span>
<span class="sd">    ncore : int or None</span>
<span class="sd">        Number of cpu-cores used for computing. Automatically selected if None.</span>
<span class="sd">    norm : bool, optional</span>
<span class="sd">        Normalize the input images if True.</span>
<span class="sd">    return_list : bool</span>
<span class="sd">        Return all local values if True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float or list of float</span>
<span class="sd">        Shift in x-direction. Return a list of float if return_list is True.</span>
<span class="sd">    float or list of float</span>
<span class="sd">        Shift in y-direction. Return a list of float if return_list is True.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    [1] : https://doi.org/10.48550/arXiv.0712.4289</span>
<span class="sd">    [2] : https://doi.org/10.1088/0957-0233/17/6/045</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data shape must be the same !!!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inputs must be 2d-arrays !!!&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">win_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">radi</span> <span class="o">=</span> <span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">radi</span> <span class="o">+</span> <span class="n">margin</span>
    <span class="n">als_size</span> <span class="o">=</span> <span class="n">win_size</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span>
    <span class="k">if</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="n">als_size</span> <span class="ow">or</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="n">als_size</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Shapes of the inputs </span><span class="si">{0}</span><span class="s2"> are smaller than the &quot;</span>
                         <span class="s2">&quot;requested size (win_size + 2*margin) = &quot;</span>
                         <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">als_size</span><span class="p">))</span>
    <span class="n">start1</span><span class="p">,</span> <span class="n">radi1</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">radi</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">norm</span><span class="p">:</span>
        <span class="n">ref_mat</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">)</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_point</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">num_point</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="k">if</span> <span class="n">list_ij</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">list_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">height</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_point</span><span class="p">)</span>
        <span class="n">list_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">width</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_point</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">list_i</span><span class="p">,</span> <span class="n">list_j</span> <span class="o">=</span> <span class="n">__get_input_list</span><span class="p">(</span><span class="n">list_ij</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
        <span class="n">num_point</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_i</span><span class="p">)</span>
    <span class="n">f_alias</span> <span class="o">=</span> <span class="n">find_shift_based_correlation_map</span>
    <span class="k">if</span> <span class="n">ncore</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="p">[</span><span class="n">f_alias</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">[</span><span class="n">list_i</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">start</span><span class="p">:</span><span class="n">list_i</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">start1</span><span class="p">,</span>
                          <span class="n">list_j</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">start</span><span class="p">:</span><span class="n">list_j</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">start1</span><span class="p">],</span>
                          <span class="n">mat</span><span class="p">[</span><span class="n">list_i</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">radi</span><span class="p">:</span><span class="n">list_i</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">radi1</span><span class="p">,</span>
                          <span class="n">list_j</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">radi</span><span class="p">:</span><span class="n">list_j</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">radi1</span><span class="p">],</span>
                          <span class="n">margin</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sub_pixel</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
                          <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_point</span><span class="p">)]</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">shifts</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ncore</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ncore</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">ncore</span><span class="p">)(</span>
            <span class="n">delayed</span><span class="p">(</span><span class="n">f_alias</span><span class="p">)(</span>
                <span class="n">ref_mat</span><span class="p">[</span><span class="n">list_i</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">start</span><span class="p">:</span><span class="n">list_i</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">start1</span><span class="p">,</span>
                        <span class="n">list_j</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">start</span><span class="p">:</span><span class="n">list_j</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">start1</span><span class="p">],</span>
                <span class="n">mat</span><span class="p">[</span><span class="n">list_i</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">radi</span><span class="p">:</span><span class="n">list_i</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">radi1</span><span class="p">,</span>
                    <span class="n">list_j</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">radi</span><span class="p">:</span><span class="n">list_j</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">radi1</span><span class="p">],</span>
                <span class="n">margin</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sub_pixel</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_point</span><span class="p">)))</span>
    <span class="n">x_shifts</span><span class="p">,</span> <span class="n">y_shifts</span> <span class="o">=</span> <span class="n">shifts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">shifts</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">return_list</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x_shifts</span><span class="p">,</span> <span class="n">y_shifts</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">global_value</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
            <span class="n">global_xshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">x_shifts</span><span class="p">)</span>
            <span class="n">global_yshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">y_shifts</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">global_value</span> <span class="o">==</span> <span class="s2">&quot;mixed&quot;</span><span class="p">:</span>
            <span class="n">mid</span> <span class="o">=</span> <span class="n">num_point</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">begin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">mid</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">mid</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">num_point</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">begin</span><span class="p">:</span>
                <span class="n">global_xshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">x_shifts</span><span class="p">)[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
                <span class="n">global_yshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">y_shifts</span><span class="p">)[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">global_xshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">x_shifts</span><span class="p">)</span>
                <span class="n">global_yshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">y_shifts</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">num_point</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">:</span>
                <span class="n">global_xshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">x_shifts</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">global_yshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">y_shifts</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">global_xshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x_shifts</span><span class="p">)</span>
                <span class="n">global_yshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_shifts</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">global_xshift</span><span class="p">,</span> <span class="n">global_yshift</span>


<span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">_get_local_shifts_gpu_kernel</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span> <span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">list_i</span><span class="p">,</span> <span class="n">list_j</span><span class="p">,</span>
                                 <span class="n">list_2d_coef</span><span class="p">,</span> <span class="n">radi</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span> <span class="n">num_point</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU-CPU function to find local (y,x)-shifts of the second image against</span>
<span class="sd">    the reference image.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    shifts : array_like</span>
<span class="sd">        2D array of zeros, initialized at CPU.</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        2D array. Reference image.</span>
<span class="sd">    list_i : array_like</span>
<span class="sd">        1D array. i-index of points using for search.</span>
<span class="sd">    list_j : array_like</span>
<span class="sd">        1D array. j-index of points using for search.</span>
<span class="sd">    list_2d_coef : array_like</span>
<span class="sd">        List of 2D array of zeros, initialized at CPU.</span>
<span class="sd">    radi : int</span>
<span class="sd">        Radius of the window to select a local area of the image.</span>
<span class="sd">    margin : int</span>
<span class="sd">        To define the size of the area of the reference image for sliding.</span>
<span class="sd">    num_point : int</span>
<span class="sd">        Number of points using for search.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">        Update of the (y,x)-shifting images passed from CPU.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">num_point</span><span class="p">:</span>
        <span class="n">radi_ref</span> <span class="o">=</span> <span class="n">radi</span> <span class="o">+</span> <span class="n">margin</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">list_i</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">list_j</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">radi_ref</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">radi_ref</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                           <span class="n">j</span> <span class="o">-</span> <span class="n">radi_ref</span><span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">radi_ref</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">mat1</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">radi</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">radi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">radi</span><span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">radi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">coef_mat1</span> <span class="o">=</span> <span class="n">list_2d_coef</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">coef_mat1</span> <span class="o">=</span> <span class="n">__gen_2d_corr_map_2d_input</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">,</span> <span class="n">mat1</span><span class="p">,</span> <span class="n">coef_mat1</span><span class="p">)</span>
        <span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">__locate_max_value</span><span class="p">(</span><span class="n">coef_mat1</span><span class="p">)</span>
        <span class="n">x_pos</span><span class="p">,</span> <span class="n">y_pos</span> <span class="o">=</span> <span class="n">__locate_2d_peak_kernel</span><span class="p">(</span><span class="n">coef_mat1</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span>
        <span class="n">shifts</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_pos</span> <span class="o">-</span> <span class="n">margin</span>
        <span class="n">shifts</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_pos</span> <span class="o">-</span> <span class="n">margin</span>


<span class="k">def</span> <span class="nf">_find_global_shift_based_local_shifts_gpu</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">win_size</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span>
                                              <span class="n">list_ij</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_point</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                              <span class="n">global_value</span><span class="o">=</span><span class="s2">&quot;mixed&quot;</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                                              <span class="n">norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_list</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU function to find global shift between two images based on finding</span>
<span class="sd">    local shifts.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        2D array. Reference image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        2D array. The 2nd image. Must be the same size as the reference image.</span>
<span class="sd">    win_size : int</span>
<span class="sd">        To define the size of the area around the selected pixel of the 2nd</span>
<span class="sd">        image. E.g. 41, 61, ..</span>
<span class="sd">    margin : int</span>
<span class="sd">        To define the searching range (in pixel) for finding shift.</span>
<span class="sd">        E.g. 20, 30,...</span>
<span class="sd">    list_ij : list of lists of int or None</span>
<span class="sd">        List of indices of points used for local search. Accept the value of</span>
<span class="sd">        [i_index, j_index] for a single point or</span>
<span class="sd">        [[i_index0, i_index1,...], [j_index0, j_index1,...]]</span>
<span class="sd">        for multiple points. Automatically generated if None.</span>
<span class="sd">    num_point : int or None</span>
<span class="sd">        Number of points used for local search if list_ij is None.</span>
<span class="sd">    global_value : {&quot;median&quot;, &quot;mean&quot;, &quot;mixed&quot;}</span>
<span class="sd">        Method for calculating the global value from local values.</span>
<span class="sd">    block : int</span>
<span class="sd">        Size of a GPU block. E.g. 16, 32, 64, ...</span>
<span class="sd">    norm : bool, optional</span>
<span class="sd">        Normalize the input images if True.</span>
<span class="sd">    return_list : bool</span>
<span class="sd">        Return all local values if True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float or list of float</span>
<span class="sd">        Shift in x-direction. Return a list of float if return_list is True.</span>
<span class="sd">    float or list of float</span>
<span class="sd">        Shift in y-direction. Return a list of float if return_list is True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data shape must be the same !!!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inputs must be 2d-arrays !!!&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">win_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">radi</span> <span class="o">=</span> <span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">edge</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">radi</span> <span class="o">+</span> <span class="n">margin</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">height1</span><span class="p">,</span> <span class="n">width1</span> <span class="o">=</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">edge</span><span class="p">,</span> <span class="n">width</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">edge</span>
    <span class="k">if</span> <span class="n">width1</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">height1</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Shapes of the inputs </span><span class="si">{0}</span><span class="s2"> are smaller than the &quot;</span>
                         <span class="s2">&quot;requested size (win_size + 2*margin) = &quot;</span>
                         <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">edge</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">norm</span><span class="p">:</span>
        <span class="n">ref_mat</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">)</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_point</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">num_point</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="k">if</span> <span class="n">list_ij</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">list_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">height</span> <span class="o">-</span> <span class="n">edge</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_point</span><span class="p">)</span>
        <span class="n">list_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">width</span> <span class="o">-</span> <span class="n">edge</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_point</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">list_i</span><span class="p">,</span> <span class="n">list_j</span> <span class="o">=</span> <span class="n">__get_input_list</span><span class="p">(</span><span class="n">list_ij</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">edge</span><span class="p">)</span>
        <span class="n">num_point</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_i</span><span class="p">)</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_point</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">num_point</span> <span class="o">/</span> <span class="n">block</span><span class="p">))</span>
    <span class="n">f_alias</span> <span class="o">=</span> <span class="n">_get_local_shifts_gpu_kernel</span>
    <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">))</span>
    <span class="n">mat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span>
    <span class="n">list_2d_coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_point</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">list_i</span><span class="p">,</span> <span class="n">list_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">list_i</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">list_j</span><span class="p">)</span>
    <span class="n">f_alias</span><span class="p">[</span><span class="n">grid</span><span class="p">,</span> <span class="n">block</span><span class="p">](</span><span class="n">shifts</span><span class="p">,</span> <span class="n">ref_mat1</span><span class="p">,</span> <span class="n">mat1</span><span class="p">,</span> <span class="n">list_i</span><span class="p">,</span> <span class="n">list_j</span><span class="p">,</span> <span class="n">list_2d_coef</span><span class="p">,</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">radi</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">margin</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">num_point</span><span class="p">))</span>
    <span class="n">x_shifts</span><span class="p">,</span> <span class="n">y_shifts</span> <span class="o">=</span> <span class="n">shifts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shifts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">return_list</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x_shifts</span><span class="p">,</span> <span class="n">y_shifts</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">global_value</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
            <span class="n">global_xshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">x_shifts</span><span class="p">)</span>
            <span class="n">global_yshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">y_shifts</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">global_value</span> <span class="o">==</span> <span class="s2">&quot;mixed&quot;</span><span class="p">:</span>
            <span class="n">mid</span> <span class="o">=</span> <span class="n">num_point</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">begin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">mid</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">mid</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">num_point</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">begin</span><span class="p">:</span>
                <span class="n">global_xshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">x_shifts</span><span class="p">)[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
                <span class="n">global_yshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">y_shifts</span><span class="p">)[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">global_xshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">x_shifts</span><span class="p">)</span>
                <span class="n">global_yshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">y_shifts</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">num_point</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">:</span>
                <span class="n">global_xshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">x_shifts</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">global_yshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">y_shifts</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">global_xshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x_shifts</span><span class="p">)</span>
                <span class="n">global_yshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_shifts</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">global_xshift</span><span class="p">,</span> <span class="n">global_yshift</span>


<div class="viewcode-block" id="find_global_shift_based_local_shifts"><a class="viewcode-back" href="../../../toc/api/algotom.util.correlation.html#algotom.util.correlation.find_global_shift_based_local_shifts">[docs]</a><span class="k">def</span> <span class="nf">find_global_shift_based_local_shifts</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">win_size</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span>
                                         <span class="n">list_ij</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_point</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                         <span class="n">global_value</span><span class="o">=</span><span class="s2">&quot;mixed&quot;</span><span class="p">,</span> <span class="n">gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                         <span class="n">block</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">sub_pixel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">method</span><span class="o">=</span><span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ncore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                         <span class="n">norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_list</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find global shift between two images based on finding local shifts.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        2D array. Reference image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        2D array. The 2nd image. Must be the same size as the reference image.</span>
<span class="sd">    win_size : int</span>
<span class="sd">        To define the size of the area around the selected pixel of the 2nd</span>
<span class="sd">        image. E.g. 41, 61, ..</span>
<span class="sd">    margin : int</span>
<span class="sd">        To define the searching range (in pixel) for finding shift.</span>
<span class="sd">        E.g. 20, 30,...</span>
<span class="sd">    list_ij : list of lists of int or None</span>
<span class="sd">        List of indices of points used for local search. Accept the value of</span>
<span class="sd">        [i_index, j_index] for a single point or</span>
<span class="sd">        [[i_index0, i_index1,...], [j_index0, j_index1,...]]</span>
<span class="sd">        for multiple points. Automatically generated if None.</span>
<span class="sd">    num_point : int or None</span>
<span class="sd">        Number of points used for local search if list_ij is None.</span>
<span class="sd">    global_value : {&quot;median&quot;, &quot;mean&quot;, &quot;mixed&quot;}</span>
<span class="sd">        Method for calculating the global value from local values.</span>
<span class="sd">    gpu : bool, optional</span>
<span class="sd">        Use GPU for computing if True. If win_size and image size is large</span>
<span class="sd">        (e.g. &gt; 201 x 2k x 2k), using CPU may be better.</span>
<span class="sd">    block : int, optional</span>
<span class="sd">        Size of a GPU block if using GPU. E.g. 16, 32, 64, ...</span>
<span class="sd">    sub_pixel : bool, optional</span>
<span class="sd">        Enable sub-pixel location.</span>
<span class="sd">    method : {&quot;diff&quot;, &quot;poly_fit&quot;}</span>
<span class="sd">        Method for finding sub-pixel shift. Two options: a differential</span>
<span class="sd">        method (Ref. [1]) or a polynomial method (Ref. [2]). The &quot;poly_fit&quot;</span>
<span class="sd">        option is not available if using GPU.</span>
<span class="sd">    size : int, optional</span>
<span class="sd">        Window size around the integer location of the maximum value used for</span>
<span class="sd">        sub-pixel searching.</span>
<span class="sd">    ncore : int or None</span>
<span class="sd">        Number of cpu-cores used for computing. Automatically selected if None.</span>
<span class="sd">    norm : bool, optional</span>
<span class="sd">        Normalize the input images if True.</span>
<span class="sd">    return_list : bool</span>
<span class="sd">        Return all local values if True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float or list of float</span>
<span class="sd">        Shift in x-direction. Return a list of float if return_list is True.</span>
<span class="sd">    float or list of float</span>
<span class="sd">        Shift in y-direction. Return a list of float if return_list is True.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    [1] : https://doi.org/10.48550/arXiv.0712.4289</span>
<span class="sd">    [2] : https://doi.org/10.1088/0957-0233/17/6/045</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">gpu</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;!!! No Nvidia GPU found !!! Run with CPU instead !!!&quot;</span><span class="p">)</span>
            <span class="n">gpu</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">gpu</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">f_alias</span> <span class="o">=</span> <span class="n">_find_global_shift_based_local_shifts_gpu</span>
        <span class="n">x_out</span><span class="p">,</span> <span class="n">y_out</span> <span class="o">=</span> <span class="n">f_alias</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">win_size</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span> <span class="n">list_ij</span><span class="o">=</span><span class="n">list_ij</span><span class="p">,</span>
                               <span class="n">num_point</span><span class="o">=</span><span class="n">num_point</span><span class="p">,</span> <span class="n">global_value</span><span class="o">=</span><span class="n">global_value</span><span class="p">,</span>
                               <span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">return_list</span><span class="o">=</span><span class="n">return_list</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">f_alias</span> <span class="o">=</span> <span class="n">_find_global_shift_based_local_shifts_cpu</span>
        <span class="n">x_out</span><span class="p">,</span> <span class="n">y_out</span> <span class="o">=</span> <span class="n">f_alias</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">win_size</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span> <span class="n">list_ij</span><span class="o">=</span><span class="n">list_ij</span><span class="p">,</span>
                               <span class="n">num_point</span><span class="o">=</span><span class="n">num_point</span><span class="p">,</span> <span class="n">global_value</span><span class="o">=</span><span class="n">global_value</span><span class="p">,</span>
                               <span class="n">sub_pixel</span><span class="o">=</span><span class="n">sub_pixel</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
                               <span class="n">ncore</span><span class="o">=</span><span class="n">ncore</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">return_list</span><span class="o">=</span><span class="n">return_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x_out</span><span class="p">,</span> <span class="n">y_out</span></div>


<span class="k">def</span> <span class="nf">__calc_shift_umpa</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t3</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t4</span><span class="p">,</span> <span class="n">t6</span><span class="p">,</span>
                      <span class="n">dark_signal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;poly_fit&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Supplementary CPU-function for finding local shifts using the UMPA</span>
<span class="sd">    approach.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">)):</span>
        <span class="n">t5</span> <span class="o">+=</span> <span class="n">correlate</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">window</span> <span class="o">*</span> <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dark_signal</span><span class="p">:</span>
        <span class="n">mat_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2</span> <span class="o">*</span> <span class="n">t3</span> <span class="o">-</span> <span class="n">t6</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">K</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2</span> <span class="o">*</span> <span class="n">t5</span> <span class="o">-</span> <span class="n">t4</span> <span class="o">*</span> <span class="n">t6</span><span class="p">)</span> <span class="o">/</span> <span class="n">mat_tmp</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="n">t3</span> <span class="o">*</span> <span class="n">t4</span> <span class="o">-</span> <span class="n">t5</span> <span class="o">*</span> <span class="n">t6</span><span class="p">)</span> <span class="o">/</span> <span class="n">mat_tmp</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">+</span> <span class="n">K</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">K</span> <span class="o">/</span> <span class="n">A</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">t5</span> <span class="o">/</span> <span class="n">t3</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">+</span> <span class="p">(</span><span class="n">beta</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">t2</span> <span class="o">+</span> <span class="p">(</span><span class="n">K</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">t3</span> \
        <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">t4</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">K</span> <span class="o">*</span> <span class="n">t5</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">K</span> <span class="o">*</span> <span class="n">t6</span>
    <span class="n">x_pos</span><span class="p">,</span> <span class="n">y_pos</span> <span class="o">=</span> <span class="n">locate_peak</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">sub_pixel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                               <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">max_peak</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">x_pos</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">y_pos</span><span class="p">))</span>
    <span class="n">x_shift</span><span class="p">,</span> <span class="n">y_shift</span> <span class="o">=</span> <span class="n">x_pos</span> <span class="o">-</span> <span class="n">margin</span><span class="p">,</span> <span class="n">y_pos</span> <span class="o">-</span> <span class="n">margin</span>
    <span class="k">if</span> <span class="n">dark_signal</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x_shift</span><span class="p">,</span> <span class="n">y_shift</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x_shift</span><span class="p">,</span> <span class="n">y_shift</span>


<span class="k">def</span> <span class="nf">__get_2d_shift_multi_rows_3d_input_umpa_cpu</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">win_size</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span>
                                                <span class="n">window</span><span class="p">,</span> <span class="n">L1</span><span class="p">,</span> <span class="n">L3</span><span class="p">,</span> <span class="n">L2</span><span class="p">,</span> <span class="n">L4</span><span class="p">,</span> <span class="n">L6</span><span class="p">,</span>
                                                <span class="n">method</span><span class="o">=</span><span class="s2">&quot;poly_fit&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                                <span class="n">ncore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dark_signal</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Supplementary CPU-function for finding local shifts using the UMPA</span>
<span class="sd">    approach.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">win_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">radi</span> <span class="o">=</span> <span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">radi</span> <span class="o">+</span> <span class="n">margin</span>
    <span class="n">stop_col</span><span class="p">,</span> <span class="n">stop_row</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">height</span> <span class="o">-</span> <span class="n">start</span>
    <span class="n">start1</span><span class="p">,</span> <span class="n">radi1</span><span class="p">,</span> <span class="n">margin1</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">radi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">margin</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">f_alias</span> <span class="o">=</span> <span class="n">__calc_shift_umpa</span>
    <span class="k">if</span> <span class="n">ncore</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ncore</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dark_signal</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
            <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">ncore</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="n">f_alias</span><span class="p">)(</span>
                <span class="n">ref_mat</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">start</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">start1</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">start</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="n">start1</span><span class="p">],</span>
                <span class="n">mat</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">radi</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">radi1</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">radi</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="n">radi1</span><span class="p">],</span> <span class="n">window</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span>
                <span class="n">L1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">L3</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">margin</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">margin1</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">margin</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="n">margin1</span><span class="p">],</span>
                <span class="n">L2</span><span class="p">,</span> <span class="n">L4</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span>
                <span class="n">L6</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">margin</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">margin1</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">margin</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="n">margin1</span><span class="p">],</span>
                <span class="n">dark_signal</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
                                   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop_row</span><span class="p">)</span>
                                   <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop_col</span><span class="p">)))</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
                             <span class="p">(</span><span class="n">stop_row</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop_col</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">x_shifts</span><span class="p">,</span> <span class="n">y_shifts</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">results</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">trans</span><span class="p">,</span> <span class="n">dark</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">results</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
            <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">ncore</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="n">f_alias</span><span class="p">)(</span>
                <span class="n">ref_mat</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">start</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">start1</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">start</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="n">start1</span><span class="p">],</span>
                <span class="n">mat</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">radi</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">radi1</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">radi</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="n">radi1</span><span class="p">],</span> <span class="n">window</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span>
                <span class="n">L1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">L3</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">margin</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">margin1</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">margin</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="n">margin1</span><span class="p">],</span>
                <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">dark_signal</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
                                   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop_row</span><span class="p">)</span>
                                   <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop_col</span><span class="p">)))</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
                             <span class="p">(</span><span class="n">stop_row</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop_col</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">x_shifts</span><span class="p">,</span> <span class="n">y_shifts</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">results</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">dark_signal</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x_shifts</span><span class="p">,</span> <span class="n">y_shifts</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">dark</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x_shifts</span><span class="p">,</span> <span class="n">y_shifts</span>


<span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">__sum_multiply_no_norm_2d</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">window</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU-kernel function to calculate the sum of multiplies of 2d-arrays.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        2D array. The first image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        2D array. The second image.</span>
<span class="sd">    window : array_like</span>
<span class="sd">        2D array. Smoothing window.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">sum_mul</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">window</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">sum_mul</span> <span class="o">+=</span> <span class="n">val</span>
    <span class="k">return</span> <span class="n">sum_mul</span>


<span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">__accu_correlate</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">coef_mat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GPU-kernel function to calculate cross-correlation between two images.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        2D array. The first image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        2D array. The second image.</span>
<span class="sd">    window : array_like</span>
<span class="sd">        2D array. Smoothing window.</span>
<span class="sd">    coef_mat : array_like</span>
<span class="sd">        2D array. Resulting map.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">height0</span><span class="p">,</span> <span class="n">width0</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="p">(</span><span class="n">height1</span><span class="p">,</span> <span class="n">width1</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">height2</span><span class="p">,</span> <span class="n">width2</span> <span class="o">=</span> <span class="n">height0</span> <span class="o">-</span> <span class="n">height1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">width0</span> <span class="o">-</span> <span class="n">width1</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="c1"># coef_mat is at GPU global memory with the size of (height2, width2)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width2</span><span class="p">):</span>
            <span class="n">row0</span><span class="p">,</span> <span class="n">row1</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">height1</span>
            <span class="n">col0</span><span class="p">,</span> <span class="n">col1</span> <span class="o">=</span> <span class="n">j</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="n">width1</span>
            <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="p">[</span><span class="n">row0</span><span class="p">:</span><span class="n">row1</span><span class="p">,</span> <span class="n">col0</span><span class="p">:</span><span class="n">col1</span><span class="p">]</span>
            <span class="n">sum_mul</span> <span class="o">=</span> <span class="n">__sum_multiply_no_norm_2d</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">window</span><span class="p">)</span>
            <span class="n">coef_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sum_mul</span>
    <span class="k">return</span> <span class="n">coef_mat</span>


<span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">__calc_shift_umpa_gpu_kernel</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">dark</span><span class="p">,</span> <span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">coef_4d</span><span class="p">,</span>
                                 <span class="n">depth</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">radi</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span>
                                 <span class="n">L1</span><span class="p">,</span> <span class="n">L3</span><span class="p">,</span> <span class="n">L2</span><span class="p">,</span> <span class="n">L4</span><span class="p">,</span> <span class="n">L6</span><span class="p">,</span> <span class="n">A0</span><span class="p">,</span> <span class="n">V0</span><span class="p">,</span> <span class="n">D0</span><span class="p">,</span> <span class="n">get_dark</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Supplementary GPU-CPU function for finding local shifts using the UMPA</span>
<span class="sd">    approach.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">x_index</span><span class="p">,</span> <span class="n">y_index</span><span class="p">)</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y_index</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x_index</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">):</span>
        <span class="n">radi_ref</span> <span class="o">=</span> <span class="n">margin</span> <span class="o">+</span> <span class="n">radi</span>
        <span class="n">radi_ref1</span> <span class="o">=</span> <span class="n">radi_ref</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">margin1</span> <span class="o">=</span> <span class="n">margin</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">radi1</span> <span class="o">=</span> <span class="n">radi</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">x_index</span> <span class="o">+</span> <span class="n">radi_ref</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">y_index</span> <span class="o">+</span> <span class="n">radi_ref</span>
        <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">radi_ref</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">radi_ref1</span><span class="p">,</span>
                           <span class="n">j</span> <span class="o">-</span> <span class="n">radi_ref</span><span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">radi_ref1</span><span class="p">]</span>
        <span class="n">mat1</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">radi</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">radi1</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">radi</span><span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">radi1</span><span class="p">]</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">A0</span><span class="p">[</span><span class="n">y_index</span><span class="p">,</span> <span class="n">x_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">V0</span><span class="p">[</span><span class="n">y_index</span><span class="p">,</span> <span class="n">x_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">D0</span><span class="p">[</span><span class="n">y_index</span><span class="p">,</span> <span class="n">x_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">t5</span> <span class="o">=</span> <span class="n">coef_4d</span><span class="p">[</span><span class="n">y_index</span><span class="p">,</span> <span class="n">x_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
            <span class="n">__accu_correlate</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">mat1</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">window</span><span class="p">,</span> <span class="n">t5</span><span class="p">)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">L1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
        <span class="n">t3</span> <span class="o">=</span> <span class="n">L3</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">margin</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">margin1</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">margin</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="n">margin1</span><span class="p">]</span>
        <span class="n">t2</span><span class="p">,</span> <span class="n">t4</span> <span class="o">=</span> <span class="n">L2</span><span class="p">,</span> <span class="n">L4</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
        <span class="n">t6</span> <span class="o">=</span> <span class="n">L6</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">margin</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">margin1</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">margin</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="n">margin1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">get_dark</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">num</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">*</span> <span class="n">t3</span><span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">t6</span><span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
                    <span class="n">K</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2</span> <span class="o">*</span> <span class="n">t5</span><span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">t4</span> <span class="o">*</span> <span class="n">t6</span><span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">])</span> <span class="o">/</span> <span class="n">num</span>
                    <span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="n">t3</span><span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">t4</span> <span class="o">-</span> <span class="n">t5</span><span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">t6</span><span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">])</span> <span class="o">/</span> <span class="n">num</span>
                    <span class="n">A</span><span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">+</span> <span class="n">K</span>
                    <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">V</span><span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">K</span> <span class="o">/</span> <span class="n">A</span><span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span>
                    <span class="n">num1</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">+</span> <span class="p">(</span><span class="n">beta</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">t2</span> <span class="o">+</span> <span class="p">(</span><span class="n">K</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">t3</span><span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span> \
                           <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">t4</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">K</span> <span class="o">*</span> <span class="n">t5</span><span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span> \
                           <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">K</span> <span class="o">*</span> <span class="n">t6</span><span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">K</span> <span class="o">=</span> <span class="n">t5</span><span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span> <span class="o">/</span> <span class="n">t3</span><span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span>
                    <span class="n">num1</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">+</span> <span class="p">(</span><span class="n">K</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">t3</span><span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">K</span> <span class="o">*</span> <span class="n">t5</span><span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span>
                <span class="n">D</span><span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">num1</span>
        <span class="n">val_max</span> <span class="o">=</span> <span class="n">__get_max_value</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">__inverse_values</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">val_max</span><span class="p">)</span>
        <span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">__locate_max_value</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
        <span class="n">x_pos</span><span class="p">,</span> <span class="n">y_pos</span> <span class="o">=</span> <span class="n">__locate_2d_peak_kernel</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span>
        <span class="n">j1</span><span class="p">,</span> <span class="n">i1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">x_pos</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">y_pos</span><span class="p">))</span>
        <span class="n">shifts</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_index</span><span class="p">,</span> <span class="n">x_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_pos</span> <span class="o">-</span> <span class="n">margin</span>
        <span class="n">shifts</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">y_index</span><span class="p">,</span> <span class="n">x_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_pos</span> <span class="o">-</span> <span class="n">margin</span>
        <span class="k">if</span> <span class="n">get_dark</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">trans</span><span class="p">[</span><span class="n">y_index</span><span class="p">,</span> <span class="n">x_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">j1</span><span class="p">])</span>
            <span class="n">dark</span><span class="p">[</span><span class="n">y_index</span><span class="p">,</span> <span class="n">x_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">j1</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">__get_2d_shift_multi_rows_3d_input_umpa_gpu</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">win_size</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span>
                                                <span class="n">window</span><span class="p">,</span> <span class="n">L1</span><span class="p">,</span> <span class="n">L3</span><span class="p">,</span> <span class="n">L2</span><span class="p">,</span> <span class="n">L4</span><span class="p">,</span> <span class="n">L6</span><span class="p">,</span>
                                                <span class="n">block</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
                                                <span class="n">dark_signal</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Supplementary GPU-function for finding local shifts using the UMPA</span>
<span class="sd">    approach.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data shape must be the same !!!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inputs must be 3d-arrays !!!&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">win_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">radi</span> <span class="o">=</span> <span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">edge</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">radi</span> <span class="o">+</span> <span class="n">margin</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">height1</span><span class="p">,</span> <span class="n">width1</span> <span class="o">=</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">edge</span><span class="p">,</span> <span class="n">width</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">edge</span>
    <span class="k">if</span> <span class="n">width1</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">height1</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">width1</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">height1</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Shapes of the inputs </span><span class="si">{0}</span><span class="s2"> are smaller than the &quot;</span>
                             <span class="s2">&quot;requested size (win_size + 2*margin) = &quot;</span>
                             <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">edge</span><span class="p">))</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">height1</span><span class="p">,</span> <span class="n">width1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">height1</span><span class="p">,</span> <span class="n">width1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">dark</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span>
    <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">))</span>
    <span class="n">mat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span>
    <span class="n">coef_4d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height1</span><span class="p">,</span> <span class="n">width1</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">A0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height1</span><span class="p">,</span> <span class="n">width1</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">V0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height1</span><span class="p">,</span> <span class="n">width1</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">D0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height1</span><span class="p">,</span> <span class="n">width1</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">L1</span><span class="p">,</span> <span class="n">L3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">L1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">L3</span><span class="p">)</span>
    <span class="n">L2</span><span class="p">,</span> <span class="n">L4</span><span class="p">,</span> <span class="n">L6</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">L2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">L4</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">L6</span><span class="p">)</span>
    <span class="n">window</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">width1</span> <span class="o">/</span> <span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">height1</span> <span class="o">/</span> <span class="n">block</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
    <span class="n">f_alias</span> <span class="o">=</span> <span class="n">__calc_shift_umpa_gpu_kernel</span>
    <span class="k">if</span> <span class="n">dark_signal</span><span class="p">:</span>
        <span class="n">get_dark</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">get_dark</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">f_alias</span><span class="p">[</span><span class="n">grid</span><span class="p">,</span> <span class="n">block</span><span class="p">](</span><span class="n">shifts</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">dark</span><span class="p">,</span> <span class="n">ref_mat1</span><span class="p">,</span> <span class="n">mat1</span><span class="p">,</span> <span class="n">coef_4d</span><span class="p">,</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">depth</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">height1</span><span class="p">),</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">width1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">radi</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">margin</span><span class="p">),</span>
                         <span class="n">window</span><span class="p">,</span> <span class="n">L1</span><span class="p">,</span> <span class="n">L3</span><span class="p">,</span> <span class="n">L2</span><span class="p">,</span> <span class="n">L4</span><span class="p">,</span> <span class="n">L6</span><span class="p">,</span> <span class="n">A0</span><span class="p">,</span> <span class="n">V0</span><span class="p">,</span> <span class="n">D0</span><span class="p">,</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">get_dark</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">shifts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shifts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">trans</span><span class="p">,</span> <span class="n">dark</span>


<div class="viewcode-block" id="find_local_shifts_umpa"><a class="viewcode-back" href="../../../toc/api/algotom.util.correlation.html#algotom.util.correlation.find_local_shifts_umpa">[docs]</a><span class="k">def</span> <span class="nf">find_local_shifts_umpa</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">win_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                           <span class="n">method</span><span class="o">=</span><span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">gpu</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
                           <span class="n">ncore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">filter_name</span><span class="o">=</span><span class="s2">&quot;hamming&quot;</span><span class="p">,</span>
                           <span class="n">dark_signal</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    To find local shifts (in x and y direction) of each pixel between</span>
<span class="sd">    two 3d-images by selecting a small volume of the second image and sliding</span>
<span class="sd">    over a slightly larger volume of the reference image. The cost function</span>
<span class="sd">    uses the formula in Ref. [1], known as UMPA.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_mat : array_like</span>
<span class="sd">        3D array, can be a numpy array or hdf object. Reference image.</span>
<span class="sd">    mat : array_like</span>
<span class="sd">        3D array, can be a numpy array or hdf object. The second image, must</span>
<span class="sd">        be the same size as the reference image.</span>
<span class="sd">    win_size : int</span>
<span class="sd">        Size of local areas in the second image.</span>
<span class="sd">    margin : int</span>
<span class="sd">        To define the sliding range of the second image.</span>
<span class="sd">    method : {&quot;diff&quot;, &quot;poly_fit&quot;}</span>
<span class="sd">        Method for finding sub-pixel shift. Two options: a differential</span>
<span class="sd">        method (Ref. [2]) or a polynomial method (Ref. [3]). The &quot;poly_fit&quot;</span>
<span class="sd">        option is not available if using GPU.</span>
<span class="sd">    size : int</span>
<span class="sd">        Window size around the integer location of the maximum value used for</span>
<span class="sd">        sub-pixel location. Adjustable if using the polynomial method.</span>
<span class="sd">    gpu : bool</span>
<span class="sd">        Use GPU for computing if True.</span>
<span class="sd">    block : tuple of two integer-values, optional</span>
<span class="sd">        Size of a GPU block. E.g. (8, 8), (16, 16), (32, 32), ...</span>
<span class="sd">    ncore : int or None</span>
<span class="sd">        Number of cpu-cores used for computing. Automatically selected if None.</span>
<span class="sd">    chunk_size : int or None</span>
<span class="sd">        Size of each chunk extracted along the height of the image. Use to</span>
<span class="sd">        avoid the out of memory problem.</span>
<span class="sd">    filter_name : {None, &quot;hann&quot;, &quot;bartlett&quot;, &quot;blackman&quot;, &quot;hamming&quot;,\</span>
<span class="sd">                  &quot;nuttall&quot;, &quot;parzen&quot;, &quot;triang&quot;}</span>
<span class="sd">        To select a smoothing filter.</span>
<span class="sd">    dark_signal : bool</span>
<span class="sd">        Return both dark-signal image and transmission-signal image if True</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of two 2d-arrays or four 2d-arrays</span>
<span class="sd">        x-shift image and y-shift image. Zeros at the outer area of the size of</span>
<span class="sd">        (margin + win_size // 2). And/or dark-signal image and</span>
<span class="sd">        transmission-signal image If the &#39;dark_signal&#39; option is True.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    [1] : https://doi.org/10.1103/PhysRevLett.118.203903</span>
<span class="sd">    [2] : https://doi.org/10.48550/arXiv.0712.4289</span>
<span class="sd">    .. [3] https://doi.org/10.1088/0957-0233/17/6/045</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">gpu</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;!!! No Nvidia GPU found !!! Run with CPU instead !!!&quot;</span><span class="p">)</span>
            <span class="n">gpu</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data shape must be the same !!!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inputs must be 3d-arrays !!!&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">chunk_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">height</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
    <span class="n">num_chunk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">height</span> <span class="o">//</span> <span class="n">chunk_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
    <span class="n">win_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">edge</span> <span class="o">=</span> <span class="n">margin</span> <span class="o">+</span> <span class="n">win_size</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">als_size</span> <span class="o">=</span> <span class="n">win_size</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span>
    <span class="k">if</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="n">als_size</span> <span class="ow">or</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="n">als_size</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Shapes of the inputs </span><span class="si">{0}</span><span class="s2"> are smaller than the &quot;</span>
                         <span class="s2">&quot;requested size (win_size + 2*margin) = &quot;</span>
                         <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2"> x </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">als_size</span><span class="p">))</span>
    <span class="n">win_1d</span> <span class="o">=</span> <span class="n">make_smoothing_window</span><span class="p">(</span><span class="n">filter_name</span><span class="p">,</span> <span class="n">win_size</span><span class="p">)</span>
    <span class="n">window</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">win_1d</span><span class="p">,</span> <span class="n">win_1d</span><span class="p">)</span>
    <span class="n">window</span> <span class="o">=</span> <span class="n">window</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
    <span class="n">S2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mat</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">R2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ref_mat</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">L1</span> <span class="o">=</span> <span class="n">correlate</span><span class="p">(</span><span class="n">S2</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)</span>
    <span class="n">L3</span> <span class="o">=</span> <span class="n">correlate</span><span class="p">(</span><span class="n">R2</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)</span>
    <span class="n">S1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">R1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ref_mat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">Im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">R1</span><span class="p">)</span> <span class="o">/</span> <span class="n">depth</span>
    <span class="n">L2</span> <span class="o">=</span> <span class="p">(</span><span class="n">Im</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">depth</span>
    <span class="n">L4</span> <span class="o">=</span> <span class="n">Im</span> <span class="o">*</span> <span class="n">correlate</span><span class="p">(</span><span class="n">S1</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)</span>
    <span class="n">L6</span> <span class="o">=</span> <span class="n">Im</span> <span class="o">*</span> <span class="n">correlate</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)</span>
    <span class="n">x_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">y_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x_shifts</span><span class="p">)</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x_shifts</span><span class="p">)</span>
    <span class="n">dark</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x_shifts</span><span class="p">)</span>
    <span class="n">list_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">height</span> <span class="o">-</span> <span class="n">edge</span><span class="p">),</span> <span class="n">num_chunk</span><span class="p">)</span>
    <span class="n">f_alias1</span> <span class="o">=</span> <span class="n">__get_2d_shift_multi_rows_3d_input_umpa_gpu</span>
    <span class="n">f_alias2</span> <span class="o">=</span> <span class="n">__get_2d_shift_multi_rows_3d_input_umpa_cpu</span>
    <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">list_index</span><span class="p">:</span>
        <span class="n">b</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">b1</span><span class="p">,</span> <span class="n">e1</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">edge</span><span class="p">,</span> <span class="n">e</span> <span class="o">+</span> <span class="n">edge</span>
        <span class="n">ref_mat1</span> <span class="o">=</span> <span class="n">ref_mat</span><span class="p">[:,</span> <span class="n">b1</span><span class="p">:</span><span class="n">e1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">mat1</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[:,</span> <span class="n">b1</span><span class="p">:</span><span class="n">e1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">gpu</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">f_alias1</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">,</span> <span class="n">mat1</span><span class="p">,</span> <span class="n">win_size</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span>
                               <span class="n">L1</span><span class="p">[</span><span class="n">b1</span><span class="p">:</span><span class="n">e1</span><span class="p">],</span> <span class="n">L3</span><span class="p">[</span><span class="n">b1</span><span class="p">:</span><span class="n">e1</span><span class="p">],</span> <span class="n">L2</span><span class="p">,</span> <span class="n">L4</span><span class="p">[</span><span class="n">b1</span><span class="p">:</span><span class="n">e1</span><span class="p">],</span> <span class="n">L6</span><span class="p">[</span><span class="n">b1</span><span class="p">:</span><span class="n">e1</span><span class="p">],</span>
                               <span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">,</span> <span class="n">dark_signal</span><span class="o">=</span><span class="n">dark_signal</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dark_signal</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">f_alias2</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">,</span> <span class="n">mat1</span><span class="p">,</span> <span class="n">win_size</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span>
                                   <span class="n">L1</span><span class="p">[</span><span class="n">b1</span><span class="p">:</span><span class="n">e1</span><span class="p">],</span> <span class="n">L3</span><span class="p">[</span><span class="n">b1</span><span class="p">:</span><span class="n">e1</span><span class="p">],</span> <span class="n">L2</span><span class="p">,</span> <span class="n">L4</span><span class="p">[</span><span class="n">b1</span><span class="p">:</span><span class="n">e1</span><span class="p">],</span>
                                   <span class="n">L6</span><span class="p">[</span><span class="n">b1</span><span class="p">:</span><span class="n">e1</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
                                   <span class="n">ncore</span><span class="o">=</span><span class="n">ncore</span><span class="p">,</span> <span class="n">dark_signal</span><span class="o">=</span><span class="n">dark_signal</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">f_alias2</span><span class="p">(</span><span class="n">ref_mat1</span><span class="p">,</span> <span class="n">mat1</span><span class="p">,</span> <span class="n">win_size</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span>
                                   <span class="n">L1</span><span class="p">[</span><span class="n">b1</span><span class="p">:</span><span class="n">e1</span><span class="p">],</span> <span class="n">L3</span><span class="p">[</span><span class="n">b1</span><span class="p">:</span><span class="n">e1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
                                   <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">ncore</span><span class="o">=</span><span class="n">ncore</span><span class="p">,</span>
                                   <span class="n">dark_signal</span><span class="o">=</span><span class="n">dark_signal</span><span class="p">)</span>
        <span class="n">x_shifts</span><span class="p">[</span><span class="n">b</span><span class="p">:</span><span class="n">e</span><span class="p">,</span> <span class="n">edge</span><span class="p">:</span><span class="o">-</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_shifts</span><span class="p">[</span><span class="n">b</span><span class="p">:</span><span class="n">e</span><span class="p">,</span> <span class="n">edge</span><span class="p">:</span><span class="o">-</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dark_signal</span><span class="p">:</span>
            <span class="n">trans</span><span class="p">[</span><span class="n">b</span><span class="p">:</span><span class="n">e</span><span class="p">,</span> <span class="n">edge</span><span class="p">:</span><span class="o">-</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">dark</span><span class="p">[</span><span class="n">b</span><span class="p">:</span><span class="n">e</span><span class="p">,</span> <span class="n">edge</span><span class="p">:</span><span class="o">-</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">dark_signal</span><span class="p">:</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">trans</span><span class="p">[</span><span class="n">edge</span><span class="p">:</span><span class="o">-</span><span class="n">edge</span><span class="p">,</span> <span class="n">edge</span><span class="p">:</span><span class="o">-</span><span class="n">edge</span><span class="p">],</span> <span class="n">edge</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;edge&quot;</span><span class="p">)</span>
        <span class="n">dark</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">dark</span><span class="p">[</span><span class="n">edge</span><span class="p">:</span><span class="o">-</span><span class="n">edge</span><span class="p">,</span> <span class="n">edge</span><span class="p">:</span><span class="o">-</span><span class="n">edge</span><span class="p">],</span> <span class="n">edge</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;edge&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x_shifts</span><span class="p">,</span> <span class="n">y_shifts</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">dark</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x_shifts</span><span class="p">,</span> <span class="n">y_shifts</span></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, Nghia T. Vo.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> and ❤️  using a custom <a href="https://github.com/LinxiFan/Sphinx-theme">theme</a> based on <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'1.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/documentation_options.js"></script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>