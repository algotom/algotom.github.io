

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>1.5. Parallel processing in Python &mdash; Algotom&#39;s documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="Algotom&#39;s documentation" href="../../index.html"/>
        <link rel="up" title="1. Basic tutorials" href="../section1.html"/>
        <link rel="next" title="2. Features and capabilities" href="../section2.html"/>
        <link rel="prev" title="1.4. Basic workflow for processing tomographic data" href="section1_4.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Algotom
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../section1.html">1. Basic tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="section1_1.html">1.1. Python for tomography scientists as beginners</a></li>
<li class="toctree-l2"><a class="reference internal" href="section1_2.html">1.2. Common data format at synchrotron facilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="section1_3.html">1.3. Basic components of an X-ray tomography system</a></li>
<li class="toctree-l2"><a class="reference internal" href="section1_4.html">1.4. Basic workflow for processing tomographic data</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">1.5. Parallel processing in Python</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../section2.html">2. Features and capabilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../section3.html">3. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../section4.html">4. Demonstrations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../section5.html">5. Technical notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../section6.html">6. Update notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">7. API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../credits.html">8. Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../highlights.html">9. Highlights</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Algotom</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../section1.html"><span class="section-number">1. </span>Basic tutorials</a> &raquo;</li>
        
      <li><span class="section-number">1.5. </span>Parallel processing in Python</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/toc/section1/section1_5.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="parallel-processing-in-python">
<h1><span class="section-number">1.5. </span>Parallel processing in Python<a class="headerlink" href="#parallel-processing-in-python" title="Permalink to this heading">Â¶</a></h1>
<p>Having a multicore CPU, certainly we want to make use of it for parallel processing. This is
easily done using the <a class="reference external" href="https://joblib.readthedocs.io/en/latest/">Joblib</a> library.
Explanation of the functions is as follow</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>

<span class="c1"># Note the use of parentheses</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">prefer</span><span class="o">=</span><span class="s2">&quot;threads&quot;</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="n">func_name</span><span class="p">)(</span><span class="n">func_para1</span><span class="p">,</span> <span class="n">func_para2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i_start</span><span class="p">,</span> <span class="n">i_stop</span><span class="p">,</span> <span class="n">i_step</span><span class="p">))</span>
</pre></div>
</div>
</div></blockquote>
<p>The first part of the code, <code class="code docutils literal notranslate"><span class="pre">Parallel(n_jobs=8,</span> <span class="pre">prefer=&quot;threads&quot;)</span></code> , is to select the number of cores and a <a class="reference external" href="https://joblib.readthedocs.io/en/latest/generated/joblib.Parallel.html#examples-using-joblib-parallel">backend method</a>
for parallelization. The second part of the code, <code class="code docutils literal notranslate"><span class="pre">(delayed()()</span> <span class="pre">for</span> <span class="pre">...)</span></code> has 3 sub-sections: the name of a function,
its parameters, and the loop. We can also use nested loops</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">prefer</span><span class="o">=</span><span class="s2">&quot;threads&quot;</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="n">func_name</span><span class="p">)(</span><span class="n">func_para1</span><span class="p">,</span> <span class="n">func_para2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i_start</span><span class="p">,</span> <span class="n">i_stop</span><span class="p">,</span> <span class="n">i_step</span><span class="p">)</span> \
                                                                                         <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j_start</span><span class="p">,</span> <span class="n">j_stop</span><span class="p">,</span> <span class="n">j_step</span><span class="p">))</span>
</pre></div>
</div>
</div></blockquote>
<p>Note that <code class="code docutils literal notranslate"><span class="pre">results</span></code> is a list of the outputs of the function used. The order of the items in the list
corresponding to how the loops are defined. The following examples will make things more clear.</p>
<blockquote>
<div><ul>
<li><p>Example to show the output order of nested loops:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>

<span class="k">def</span> <span class="nf">print_order</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;i = </span><span class="si">{0}</span><span class="s2">; j = </span><span class="si">{1}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">prefer</span><span class="o">=</span><span class="s2">&quot;threads&quot;</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="n">print_order</span><span class="p">)(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> \
                                                                          <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Output = &quot;</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">&gt;&gt;&gt;</span>
<span class="go">i = 0; j = 2</span>
<span class="go">i = 0; j = 3</span>
<span class="go">i = 1; j = 2</span>
<span class="go">i = 1; j = 3</span>
<span class="go">Output =  [(0, 2), (0, 3), (1, 2), (1, 3)]</span>
</pre></div>
</div>
</li>
<li><p>Example to show how to apply a smoothing filter to multiple images in parallel</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">timeit</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.ndimage</span> <span class="k">as</span> <span class="nn">ndi</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>

<span class="c1"># Select number of cpu cores</span>
<span class="n">ncore</span> <span class="o">=</span> <span class="mi">16</span>
<span class="k">if</span> <span class="n">ncore</span> <span class="o">&gt;</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">():</span>
    <span class="n">ncore</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>

<span class="c1"># Create data for testing</span>
<span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">,</span> <span class="mi">5000</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">image</span><span class="p">[</span><span class="mi">1000</span><span class="p">:</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1500</span><span class="p">:</span><span class="mi">3500</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">n_slice</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">i</span> <span class="o">*</span> <span class="n">image</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_slice</span><span class="p">)]),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># &gt;&gt;&gt; (3000, 16, 5000)</span>

<span class="c1"># Using sequential computing for comparison</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_slice</span><span class="p">):</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">ndi</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time cost for sequential computing: &quot;</span><span class="p">,</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="c1"># &gt;&gt;&gt; 8.831482099999999</span>

<span class="c1"># Using parallel computing</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">prefer</span><span class="o">=</span><span class="s2">&quot;threads&quot;</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="n">ndi</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">)(</span><span class="n">data</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_slice</span><span class="p">))</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time cost for parallel computing: &quot;</span><span class="p">,</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span>   <span class="c1"># &gt;&gt;&gt; 0.8372323000000002</span>

<span class="c1"># As the output is a list we have to convert it to a numpy array</span>
<span class="c1"># and reshape to get back the original shape</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># &gt;&gt;&gt; (16, 3000, 5000)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># &gt;&gt;&gt; (3000, 16, 5000)</span>
</pre></div>
</div>
<p>There are several options for choosing the <a class="reference external" href="https://joblib.readthedocs.io/en/latest/parallel.html#thread-based-parallelism-vs-process-based-parallelism">backend methods</a>.
Depending on the problem and how input data are used, their performance can be significantly different. In the above
example, each slice of data can be processed independently; i.e. no sharing data between cores; so the âthreadsâ
option gives the best performance.
Note that we canât use the above approaches for parallel reading or writing data from/to a hdf file. There is a
<a class="reference external" href="https://docs.h5py.org/en/stable/mpi.html">different way</a> of doing these.</p>
</li>
<li><p>Users can also refer to how Algotom uses Joblib for different use-cases as shown <a class="reference external" href="https://github.com/algotom/algotom/blob/e4241fdce435ffeed512c657b25e07d9e9a1a45f/algotom/util/utility.py#L68">here</a>,
<a class="reference external" href="https://github.com/algotom/algotom/blob/e4241fdce435ffeed512c657b25e07d9e9a1a45f/algotom/prep/calculation.py#L176">here</a>,
or <a class="reference external" href="https://github.com/algotom/algotom/blob/e4241fdce435ffeed512c657b25e07d9e9a1a45f/algotom/util/correlation.py#L1155">here</a>.</p></li>
</ul>
</div></blockquote>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../section2.html" class="btn btn-neutral float-right" title="2. Features and capabilities" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="section1_4.html" class="btn btn-neutral" title="1.4. Basic workflow for processing tomographic data" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, Nghia T. Vo.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> and â¤ï¸  using a custom <a href="https://github.com/LinxiFan/Sphinx-theme">theme</a> based on <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/documentation_options.js"></script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>