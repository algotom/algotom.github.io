
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17: http://docutils.sourceforge.net/" />

    <title>4.5. Complete workflow for processing tomographic data &#8212; Algotom&#39;s documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic_mod.css?v=0.7.0-1" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <script src="../../_static/js/petite-vue.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="5. Technical notes" href="../section5.html" />
    <link rel="prev" title="4.4. Comparison of ring removal methods on challenging sinograms" href="section4_4.html" /> 
  </head><body data-dark_mode_code_blocks="true">

<div id="top_nav">
    

    <nav>
        
            
        

        <p id="toggle_sidebar">
            <a href="#" title="Toggle sidebar">|||</a>
        </p>
        <h1><a href="../../index.html" title="Go to homepage">Algotom's documentation</a></h1>

        <a id="mode_toggle" href="#" @click.prevent="handleClick" :title="mode">
    <template v-if="mode == 'light'">
        <svg width="100%" height="100%" viewBox="0 0 79 80" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><g id="mode_light"><rect id="Bounds" x="0" y="-0" width="78.623" height="79.049" style="fill:none;"/><circle cx="39.311" cy="39.524" r="15.734" style="fill:#fff;"/><g id="beams"><g id="beam"><path id="beam1" serif:id="beam" d="M44.212,4.901c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,-0 -4.9,2.196 -4.9,4.901l-0,9.614c-0,2.705 2.196,4.901 4.9,4.901c2.705,0 4.901,-2.196 4.901,-4.901l0,-9.614Z" style="fill:#fff;"/></g><g id="beam2" serif:id="beam"><path id="beam3" serif:id="beam" d="M67.48,18.073c1.913,-1.912 1.913,-5.018 0,-6.931c-1.912,-1.912 -5.018,-1.912 -6.931,0l-6.798,6.799c-1.912,1.912 -1.912,5.018 0,6.931c1.913,1.912 5.018,1.912 6.931,-0l6.798,-6.799Z" style="fill:#fff;"/></g><g id="beam4" serif:id="beam"><path id="beam5" serif:id="beam" d="M25.728,61.108c1.912,-1.913 1.912,-5.018 -0,-6.931c-1.913,-1.913 -5.019,-1.913 -6.931,-0l-6.799,6.798c-1.912,1.913 -1.912,5.019 0,6.931c1.913,1.913 5.019,1.913 6.931,0l6.799,-6.798Z" style="fill:#fff;"/></g><g id="beam6" serif:id="beam"><path id="beam7" serif:id="beam" d="M60.682,54.177c-1.913,-1.913 -5.018,-1.913 -6.931,-0c-1.912,1.913 -1.912,5.018 0,6.931l6.798,6.798c1.913,1.913 5.019,1.913 6.931,0c1.913,-1.912 1.913,-5.018 0,-6.931l-6.798,-6.798Z" style="fill:#fff;"/></g><g id="beam8" serif:id="beam"><path id="beam9" serif:id="beam" d="M4.901,34.623c-2.705,0 -4.901,2.196 -4.901,4.901c0,2.705 2.196,4.901 4.901,4.901l9.614,0c2.705,0 4.901,-2.196 4.901,-4.901c0,-2.705 -2.196,-4.901 -4.901,-4.901l-9.614,0Z" style="fill:#fff;"/></g><g id="beam10" serif:id="beam"><path id="beam11" serif:id="beam" d="M44.212,64.534c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,-0 -4.9,2.196 -4.9,4.901l-0,9.614c-0,2.705 2.196,4.901 4.9,4.901c2.705,-0 4.901,-2.196 4.901,-4.901l0,-9.614Z" style="fill:#fff;"/></g><g id="beam12" serif:id="beam"><path id="beam13" serif:id="beam" d="M18.929,11.142c-1.912,-1.912 -5.018,-1.912 -6.931,0c-1.912,1.913 -1.912,5.019 0,6.931l6.799,6.799c1.912,1.912 5.018,1.912 6.931,-0c1.912,-1.913 1.912,-5.019 -0,-6.931l-6.799,-6.799Z" style="fill:#fff;"/></g><g id="beam14" serif:id="beam"><path id="beam15" serif:id="beam" d="M64.108,34.623c-2.705,0 -4.901,2.196 -4.901,4.901c-0,2.705 2.196,4.901 4.901,4.901l9.614,0c2.705,0 4.901,-2.196 4.901,-4.901c-0,-2.705 -2.196,-4.901 -4.901,-4.901l-9.614,0Z" style="fill:#fff;"/></g></g></g></svg>
    </template>

    <template v-if="mode == 'dark'">
        <svg width="100%" height="100%" viewBox="0 0 79 80" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><g id="mode_dark"><rect id="Bounds" x="0" y="-0" width="78.623" height="79.049" style="fill:none;"/><circle cx="39.311" cy="39.524" r="15.734" style="fill:#fff;"/><g id="beams"><g id="beam"><path id="beam1" serif:id="beam" d="M44.212,14.515c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,0 -4.901,2.196 -4.901,4.901c0,2.705 2.197,4.901 4.901,4.901c2.705,0 4.901,-2.196 4.901,-4.901Z" style="fill:#fff;"/></g><g id="beam2" serif:id="beam"><path id="beam3" serif:id="beam" d="M60.662,24.892c1.902,-1.902 1.902,-4.99 0,-6.892l-0.04,-0.039c-1.901,-1.902 -4.989,-1.902 -6.891,-0c-1.901,1.901 -1.901,4.989 0,6.891l0.04,0.04c1.902,1.901 4.989,1.901 6.891,-0Z" style="fill:#fff;"/></g><g id="beam4" serif:id="beam"><path id="beam5" serif:id="beam" d="M25.732,61.103c1.91,-1.91 1.91,-5.011 0,-6.921l-0.009,-0.01c-1.91,-1.91 -5.012,-1.91 -6.921,-0c-1.91,1.91 -1.91,5.011 -0,6.921l0.01,0.01c1.909,1.91 5.011,1.91 6.92,-0Z" style="fill:#fff;"/></g><g id="beam6" serif:id="beam"><path id="beam7" serif:id="beam" d="M60.672,54.167c-1.907,-1.907 -5.004,-1.907 -6.911,0l-0.02,0.02c-1.907,1.907 -1.907,5.004 0,6.911c1.907,1.907 5.004,1.907 6.911,-0l0.02,-0.02c1.907,-1.907 1.907,-5.004 0,-6.911Z" style="fill:#fff;"/></g><g id="beam8" serif:id="beam"><path id="beam9" serif:id="beam" d="M14.52,34.623c-2.702,0 -4.896,2.194 -4.896,4.896l0,0.01c0,2.702 2.194,4.896 4.896,4.896c2.702,0 4.896,-2.194 4.896,-4.896l-0,-0.01c-0,-2.702 -2.194,-4.896 -4.896,-4.896Z" style="fill:#fff;"/></g><g id="beam10" serif:id="beam"><path id="beam11" serif:id="beam" d="M44.212,64.534c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,-0 -4.901,2.196 -4.901,4.901c0,2.704 2.197,4.9 4.901,4.9c2.705,0 4.901,-2.196 4.901,-4.9Z" style="fill:#fff;"/></g><g id="beam12" serif:id="beam"><path id="beam13" serif:id="beam" d="M25.73,17.943c-1.911,-1.911 -5.015,-1.911 -6.926,0l-0.005,0.005c-1.911,1.911 -1.911,5.015 0,6.926c1.911,1.911 5.015,1.911 6.926,0l0.005,-0.005c1.911,-1.911 1.911,-5.014 -0,-6.926Z" style="fill:#fff;"/></g><g id="beam14" serif:id="beam"><path id="beam15" serif:id="beam" d="M64.098,34.623c-2.699,0 -4.891,2.192 -4.891,4.892l-0,0.019c-0,2.699 2.192,4.891 4.891,4.891c2.7,0 4.892,-2.192 4.892,-4.891l0,-0.019c0,-2.7 -2.192,-4.892 -4.892,-4.892Z" style="fill:#fff;"/></g></g></g></svg>
    </template>

    <template v-if="mode == 'darkest'">
        <svg width="100%" height="100%" viewBox="0 0 79 80" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><g id="mode_darkest"><rect id="Bounds" x="0" y="-0" width="78.623" height="79.049" style="fill:none;"/><path d="M39.315,23.791c8.684,-0 15.734,7.05 15.734,15.733c0,8.684 -7.05,15.734 -15.734,15.734c-8.683,0 -15.733,-7.05 -15.733,-15.734c-0,-8.683 7.05,-15.733 15.733,-15.733Zm0,4.737c6.069,0 10.997,4.927 10.997,10.996c-0,6.069 -4.928,10.996 -10.997,10.996c-6.068,0 -10.996,-4.927 -10.996,-10.996c0,-6.069 4.928,-10.996 10.996,-10.996Z" style="fill:#fff;"/><g id="beams"><g id="beam"><path id="beam1" serif:id="beam" d="M44.216,14.515c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,0 -4.9,2.196 -4.9,4.901c-0,2.705 2.196,4.901 4.9,4.901c2.705,0 4.901,-2.196 4.901,-4.901Z" style="fill:#fff;"/></g><g id="beam2" serif:id="beam"><path id="beam3" serif:id="beam" d="M60.666,24.892c1.902,-1.902 1.902,-4.99 0,-6.892l-0.04,-0.039c-1.901,-1.902 -4.989,-1.902 -6.891,-0c-1.901,1.901 -1.901,4.989 0,6.891l0.04,0.04c1.902,1.901 4.99,1.901 6.891,-0Z" style="fill:#fff;"/></g><g id="beam4" serif:id="beam"><path id="beam5" serif:id="beam" d="M25.737,61.103c1.909,-1.91 1.909,-5.011 -0,-6.921l-0.01,-0.01c-1.91,-1.91 -5.011,-1.91 -6.921,-0c-1.91,1.91 -1.91,5.011 -0,6.921l0.01,0.01c1.91,1.91 5.011,1.91 6.921,-0Z" style="fill:#fff;"/></g><g id="beam6" serif:id="beam"><path id="beam7" serif:id="beam" d="M60.676,54.167c-1.907,-1.907 -5.004,-1.907 -6.911,0l-0.02,0.02c-1.907,1.907 -1.907,5.004 0,6.911c1.907,1.907 5.004,1.907 6.911,-0l0.02,-0.02c1.907,-1.907 1.907,-5.004 0,-6.911Z" style="fill:#fff;"/></g><g id="beam8" serif:id="beam"><path id="beam9" serif:id="beam" d="M14.524,34.623c-2.702,0 -4.896,2.194 -4.896,4.896l0,0.01c0,2.702 2.194,4.896 4.896,4.896c2.702,0 4.896,-2.194 4.896,-4.896l0,-0.01c0,-2.702 -2.194,-4.896 -4.896,-4.896Z" style="fill:#fff;"/></g><g id="beam10" serif:id="beam"><path id="beam11" serif:id="beam" d="M44.216,64.534c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,-0 -4.9,2.196 -4.9,4.901c-0,2.704 2.196,4.9 4.9,4.9c2.705,0 4.901,-2.196 4.901,-4.9Z" style="fill:#fff;"/></g><g id="beam12" serif:id="beam"><path id="beam13" serif:id="beam" d="M25.734,17.943c-1.911,-1.911 -5.015,-1.911 -6.926,0l-0.005,0.005c-1.911,1.911 -1.911,5.015 0,6.926c1.911,1.911 5.015,1.911 6.926,0l0.005,-0.005c1.911,-1.911 1.911,-5.014 0,-6.926Z" style="fill:#fff;"/></g><g id="beam14" serif:id="beam"><path id="beam15" serif:id="beam" d="M64.103,34.623c-2.7,0 -4.892,2.192 -4.892,4.892l-0,0.019c-0,2.699 2.192,4.891 4.892,4.891c2.699,0 4.891,-2.192 4.891,-4.891l0,-0.019c0,-2.7 -2.192,-4.892 -4.891,-4.892Z" style="fill:#fff;"/></g></g></g></svg>
    </template>
</a>

<script>
(function() {
    const LOCAL_STORAGE_KEY = 'piccoloThemeMode'

    var initialMode = localStorage.getItem(LOCAL_STORAGE_KEY)

    if (initialMode) {
        // Make sure the value in local storage is valid
        if (['light', 'dark', 'darkest'].indexOf(initialMode) == -1) {
            initialMode = 'light'
            localStorage.setItem(LOCAL_STORAGE_KEY, initialMode)
        }
    } else {
        // Check if the client prefers dark mode
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            initialMode = 'dark'
        } else {
            initialMode = 'light'
        }
        localStorage.setItem(LOCAL_STORAGE_KEY, initialMode)
    }

    document.documentElement.dataset.mode = initialMode

    PetiteVue.createApp({
        'mode': initialMode,
        handleClick() {
            let currentMode = this.mode

            if (currentMode == 'light') {
                this.mode = 'dark'
            } else if (currentMode == 'dark') {
                this.mode = 'darkest'
            } else if (currentMode == 'darkest') {
                this.mode = 'light'
            }

            document.documentElement.dataset.mode = this.mode
            localStorage.setItem(LOCAL_STORAGE_KEY, this.mode)

            console.log(this.mode)
        }
    }).mount('#mode_toggle')
})()
</script>
            <p class="mobile_search_link">
                <a href="../../search.html" title="Search">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 65 64" fill-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2">
                        <path d="M14.873 40.009c-2.315-3.943-3.642-8.532-3.642-13.429C11.231 11.91 23.141 0 37.811 0s26.58 11.91 26.58 26.58-11.91 26.58-26.58 26.58a26.44 26.44 0 0 1-14.277-4.161L9.739 62.794a3.12 3.12 0 0 1-4.413 0L.913 58.382c-1.217-1.218-1.217-3.196 0-4.413l13.96-13.96zM37.811 8.054c10.225 0 18.526 8.301 18.526 18.526s-8.301 18.526-18.526 18.526-18.526-8.301-18.526-18.526S27.586 8.054 37.811 8.054z" fill="#fff" />
                    </svg>
                </a>
            </p>
        

        <div class="searchbox_wrapper">
            
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
    </nav>
</div>

    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../section1.html">1. Basic tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../section2.html">2. Features and capabilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../section3.html">3. Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../section4.html">4. Demonstrations</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="section4_1.html">4.1. Setting up a Python workspace</a></li>
<li class="toctree-l2"><a class="reference internal" href="section4_2.html">4.2. Exploring raw data and making use of the input-output module</a></li>
<li class="toctree-l2"><a class="reference internal" href="section4_3.html">4.3. Methods and tools for removing ring artifacts</a></li>
<li class="toctree-l2"><a class="reference internal" href="section4_4.html">4.4. Comparison of ring removal methods on challenging sinograms</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">4.5. Complete workflow for processing tomographic data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../section5.html">5. Technical notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../section6.html">6. Update notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">7. API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../credits.html">8. Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../highlights.html">9. Highlights</a></li>
</ul>

        </div>
      </div>


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="complete-workflow-for-processing-tomographic-data">
<h1><span class="section-number">4.5. </span>Complete workflow for processing tomographic data<a class="headerlink" href="#complete-workflow-for-processing-tomographic-data" title="Permalink to this heading">¶</a></h1>
<p>This guide presents a comprehensive workflow for processing tomographic data, starting from raw data. In addition,
it includes useful tips and explanations to users’ common mistakes.</p>
<section id="assessing-raw-data">
<h2><span class="section-number">4.5.1. </span>Assessing raw data<a class="headerlink" href="#assessing-raw-data" title="Permalink to this heading">¶</a></h2>
<p>A typical tomographic dataset includes:</p>
<ul class="simple">
<li><p>Raw data acquired by a detector which are: projection images, flat-field image, and dark-field images.</p></li>
<li><p>Metadata that provides information about the experimental setup, such as rotation angles, energy, pixel size,
sample-detector distance, and any other relevant parameters.</p></li>
</ul>
<p>Visual inspection (using ImageJ) can help determine whether raw data are of sufficient quality. Users may want to
perform the following checks:</p>
<ul>
<li><p>Verify that the first and the last projection are 180-degree apart:</p>
<blockquote>
<div><p>If raw data are in <a class="reference internal" href="../section1/section1_2.html#hdf-format"><span class="std std-ref">hdf/h5/nxs format</span></a>, the projections can be extracted and saved as
tif images as the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">algotom.io.loadersaver</span> <span class="k">as</span> <span class="nn">losa</span>

<span class="n">file_path</span> <span class="o">=</span> <span class="s2">&quot;E:/Tomo_data/scan_68067.hdf&quot;</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">&quot;E:/tmp/extract_tifs/&quot;</span>
<span class="n">proj_path</span> <span class="o">=</span> <span class="s2">&quot;entry/projections&quot;</span>  <span class="c1"># Refer section 1.2.1 to know how to get</span>
                                 <span class="c1"># path to a dataset in a hdf file.</span>
<span class="n">flat_path</span> <span class="o">=</span> <span class="s2">&quot;entry/flats&quot;</span>
<span class="n">flat_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">losa</span><span class="o">.</span><span class="n">load_hdf</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">flat_path</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">nmean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">flat_img</span><span class="p">)</span>
<span class="n">flat_img</span><span class="p">[</span><span class="n">flat_img</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nmean</span>  <span class="c1"># To avoid zero division</span>

<span class="n">proj_obj</span> <span class="o">=</span> <span class="n">losa</span><span class="o">.</span><span class="n">load_hdf</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">proj_path</span><span class="p">)</span>  <span class="c1"># hdf object</span>
<span class="n">proj_0</span> <span class="o">=</span> <span class="n">proj_obj</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">flat_img</span>
<span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/proj_0.tif&quot;</span><span class="p">,</span> <span class="n">proj_0</span><span class="p">)</span>
<span class="n">proj_180</span> <span class="o">=</span> <span class="n">proj_obj</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">flat_img</span>
<span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/proj_180.tif&quot;</span><span class="p">,</span> <span class="n">proj_180</span><span class="p">)</span>
</pre></div>
</div>
<p>If the first and last projection are 180-degree apart, the second image should be a mirror
reflection (left-right flip) of the first image.</p>
<a class="reference internal image-reference" href="../../_images/img_4_5_1.jpg" id="img-4-5-1"><img alt="../../_images/img_4_5_1.jpg" class="align-center" id="img-4-5-1" src="../../_images/img_4_5_1.jpg" style="width: 100%;" /></a>
</div></blockquote>
</li>
<li><p>If data were acquired using a <a class="reference external" href="https://doi.org/10.1364/OE.418448">360-degree scan with an offset rotation axis</a>,
it is important to verify that the rotation axis is positioned to one side of the field of view (FOV). This can be done
by checking for an overlap between the 0-degree projection and the left-right flipped 180-degree projection image.</p>
<blockquote>
<div><a class="reference internal image-reference" href="../../_images/img_4_5_2.jpg" id="img-4-5-2"><img alt="../../_images/img_4_5_2.jpg" class="align-center" id="img-4-5-2" src="../../_images/img_4_5_2.jpg" style="width: 100%;" /></a>
</div></blockquote>
</li>
<li><p>Check if the rotation axis is tilted. This can be done by calculating the difference/average between the
0-degree projection and the 180-degree projection, then examining the resulting image for a symmetric line.
If the x-location of the symmetric line is the same at the top and bottom of the image, the rotation axis
is properly aligned.</p>
<blockquote>
<div><a class="reference internal image-reference" href="../../_images/img_4_5_3.jpg" id="img-4-5-3"><img alt="../../_images/img_4_5_3.jpg" class="align-center" id="img-4-5-3" src="../../_images/img_4_5_3.jpg" style="width: 100%;" /></a>
<p>If a tilt is detected, the tilt angle can be accurately calculated by locating the <a class="reference external" href="https://algotom.readthedocs.io/en/latest/toc/api/algotom.prep.calculation.html#algotom.prep.calculation.find_center_vo">center of rotation</a>
using sinograms generated at the top, middle, and bottom of the FOV; then applying a linear fit to the results.
The resulting tilt angle can be used to correct the tilted tomographic images, as shown
<a class="reference external" href="https://github.com/algotom/algotom/blob/master/examples/example_09_generate_tilted_sinogram.py">here</a>.</p>
</div></blockquote>
</li>
<li><p>Ensure that projection images were acquired at evenly spaced angles and there was no stage jittering during
the scan by inspecting a sinogram image:</p>
<blockquote>
<div><a class="reference internal image-reference" href="../../_images/img_4_5_4.jpg" id="img-4-5-4"><img alt="../../_images/img_4_5_4.jpg" class="align-center" id="img-4-5-4" src="../../_images/img_4_5_4.jpg" style="width: 100%;" /></a>
<p>If raw data are in hdf/h5/nxs format, the sinogram can be extracted and saved as tif format as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">algotom.io.loadersaver</span> <span class="k">as</span> <span class="nn">losa</span>

<span class="n">file_path</span> <span class="o">=</span> <span class="s2">&quot;E:/Tomo_data/scan_68067.hdf&quot;</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">&quot;E:/tmp/extract_tifs/&quot;</span>
<span class="n">proj_path</span> <span class="o">=</span> <span class="s2">&quot;entry/projections&quot;</span>  <span class="c1"># Refer section 1.2.1 to know how to get</span>
                                 <span class="c1"># path to a dataset in a hdf file.</span>
<span class="n">flat_path</span> <span class="o">=</span> <span class="s2">&quot;entry/flats&quot;</span>
<span class="n">flat_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">losa</span><span class="o">.</span><span class="n">load_hdf</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">flat_path</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">nmean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">flat_img</span><span class="p">)</span>
<span class="n">flat_img</span><span class="p">[</span><span class="n">flat_img</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nmean</span>  <span class="c1"># To avoid zero division</span>

<span class="n">proj_obj</span> <span class="o">=</span> <span class="n">losa</span><span class="o">.</span><span class="n">load_hdf</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">proj_path</span><span class="p">)</span>  <span class="c1"># hdf object</span>
<span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">proj_obj</span><span class="o">.</span><span class="n">shape</span>
<span class="n">sino_idx</span> <span class="o">=</span> <span class="n">height</span> <span class="o">//</span> <span class="mi">2</span>
<span class="n">sinogram</span> <span class="o">=</span> <span class="n">proj_obj</span><span class="p">[:,</span> <span class="n">sino_idx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">flat_img</span><span class="p">[</span><span class="n">sino_idx</span><span class="p">]</span>
<span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/sinogram.tif&quot;</span><span class="p">,</span> <span class="n">sinogram</span><span class="p">)</span>
</pre></div>
</div>
<p>If input data are in tif format, we need to convert them to the hdf format for fast extracting
sinogram image:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">algotom.io.converter</span> <span class="k">as</span> <span class="nn">cvr</span>
<span class="kn">import</span> <span class="nn">algotom.io.loadersaver</span> <span class="k">as</span> <span class="nn">losa</span>

<span class="n">proj_path</span> <span class="o">=</span> <span class="s2">&quot;E:/Tomo_data/scan_68067/projections/&quot;</span>
<span class="n">flat_path</span> <span class="o">=</span> <span class="s2">&quot;E:/Tomo_data/scan_68067/flats/&quot;</span>

<span class="n">output_base</span> <span class="o">=</span> <span class="s2">&quot;E:/tmp/extract_tifs/&quot;</span>

<span class="n">flat_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
    <span class="p">[</span><span class="n">losa</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">losa</span><span class="o">.</span><span class="n">find_file</span><span class="p">(</span><span class="n">flat_path</span> <span class="o">+</span> <span class="s2">&quot;/*tif*&quot;</span><span class="p">)]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">nmean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">flat_img</span><span class="p">)</span>
<span class="n">flat_img</span><span class="p">[</span><span class="n">flat_img</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nmean</span>  <span class="c1"># To avoid zero division</span>

<span class="c1"># Convert data to hdf format for fast extracting sinograms.</span>
<span class="n">hdf_file_path</span> <span class="o">=</span> <span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/hdf_converted/&quot;</span> <span class="o">+</span> <span class="s2">&quot;tomo_data.hdf&quot;</span>
<span class="n">key_path</span> <span class="o">=</span> <span class="s2">&quot;entry/data&quot;</span>
<span class="n">cvr</span><span class="o">.</span><span class="n">convert_tif_to_hdf</span><span class="p">(</span><span class="n">proj_path</span><span class="p">,</span> <span class="n">hdf_file_path</span><span class="p">,</span> <span class="n">key_path</span><span class="o">=</span><span class="n">key_path</span><span class="p">)</span>
<span class="n">proj_obj</span><span class="p">,</span> <span class="n">hdf_obj</span> <span class="o">=</span> <span class="n">losa</span><span class="o">.</span><span class="n">load_hdf</span><span class="p">(</span><span class="n">hdf_file_path</span><span class="p">,</span> <span class="n">key_path</span><span class="p">,</span> <span class="n">return_file_obj</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">proj_obj</span><span class="o">.</span><span class="n">shape</span>

<span class="n">sino_idx</span> <span class="o">=</span> <span class="n">height</span> <span class="o">//</span> <span class="mi">2</span>
<span class="n">sinogram</span> <span class="o">=</span> <span class="n">proj_obj</span><span class="p">[:,</span> <span class="n">sino_idx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">flat_img</span><span class="p">[</span><span class="n">sino_idx</span><span class="p">]</span>
<span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/sinogram.tif&quot;</span><span class="p">,</span> <span class="n">sinogram</span><span class="p">)</span>
<span class="n">hdf_obj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="c1"># Remove the hdf file if needs to</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/hdf_converted/&quot;</span><span class="p">):</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/hdf_converted/&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</section>
<section id="reconstructing-several-slices">
<h2><span class="section-number">4.5.2. </span>Reconstructing several slices<a class="headerlink" href="#reconstructing-several-slices" title="Permalink to this heading">¶</a></h2>
<p>In high throughput tomographic systems, it’s common that users want to quickly reconstruct only
a few slices in order to verify the quality of the data or to locate the region of interest for
higher resolution scans. This can be achieved by following these steps:</p>
<ul>
<li><p>Load the raw data and the corresponding flat-field and dark-field images. It’s common to acquire
multiple flat and dark images (usually between 10 and 50) and average them to improve the
signal-to-noise (SNR) ratio. Once the flat and dark images have been averaged, they can be used for
<a class="reference internal" href="../section1/section1_4.html#flat-field-correction"><span class="std std-ref">flat-field correction</span></a>.</p>
<blockquote>
<div><p>If raw data are in tif format, we need to convert them to hdf format first:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">algotom.io.loadersaver</span> <span class="k">as</span> <span class="nn">losa</span>
<span class="kn">import</span> <span class="nn">algotom.io.converter</span> <span class="k">as</span> <span class="nn">cvr</span>
<span class="kn">import</span> <span class="nn">algotom.prep.correction</span> <span class="k">as</span> <span class="nn">corr</span>
<span class="kn">import</span> <span class="nn">algotom.prep.calculation</span> <span class="k">as</span> <span class="nn">calc</span>
<span class="kn">import</span> <span class="nn">algotom.prep.removal</span> <span class="k">as</span> <span class="nn">remo</span>
<span class="kn">import</span> <span class="nn">algotom.prep.filtering</span> <span class="k">as</span> <span class="nn">filt</span>
<span class="kn">import</span> <span class="nn">algotom.rec.reconstruction</span> <span class="k">as</span> <span class="nn">rec</span>


<span class="n">proj_path</span> <span class="o">=</span> <span class="s2">&quot;E:/Tomo_data/scan_68067_tif/projections/&quot;</span>
<span class="n">flat_path</span> <span class="o">=</span> <span class="s2">&quot;E:/Tomo_data/scan_68067_tif/flats/&quot;</span>
<span class="n">dark_path</span> <span class="o">=</span> <span class="s2">&quot;E:/Tomo_data/scan_68067_tif/darks/&quot;</span>

<span class="n">output_base</span> <span class="o">=</span> <span class="s2">&quot;E:/output/rec_few_slices/&quot;</span>

<span class="c1"># Load dark-field images and flat-field images.</span>
<span class="n">flats</span> <span class="o">=</span> <span class="n">losa</span><span class="o">.</span><span class="n">get_tif_stack</span><span class="p">(</span><span class="n">flat_path</span><span class="p">)</span>
<span class="n">darks</span> <span class="o">=</span> <span class="n">losa</span><span class="o">.</span><span class="n">get_tif_stack</span><span class="p">(</span><span class="n">dark_path</span><span class="p">)</span>

<span class="c1"># Convert tif images to hdf format for fast extracting sinograms.</span>
<span class="n">file_path</span> <span class="o">=</span> <span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/tmp_/&quot;</span> <span class="o">+</span> <span class="s2">&quot;tomo_data.hdf&quot;</span>
<span class="n">key_path</span> <span class="o">=</span> <span class="s2">&quot;entry/projections&quot;</span>
<span class="n">cvr</span><span class="o">.</span><span class="n">convert_tif_to_hdf</span><span class="p">(</span><span class="n">proj_path</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">key_path</span><span class="o">=</span><span class="n">key_path</span><span class="p">,</span>
                       <span class="n">option</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;entry/flats&quot;</span><span class="p">:</span> <span class="n">flats</span><span class="p">,</span> <span class="s2">&quot;entry/darks&quot;</span><span class="p">:</span> <span class="n">darks</span><span class="p">})</span>
</pre></div>
</div>
<p>Working with a hdf file is straightforward as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">algotom.io.loadersaver</span> <span class="k">as</span> <span class="nn">losa</span>
<span class="kn">import</span> <span class="nn">algotom.io.converter</span> <span class="k">as</span> <span class="nn">cvr</span>
<span class="kn">import</span> <span class="nn">algotom.prep.correction</span> <span class="k">as</span> <span class="nn">corr</span>
<span class="kn">import</span> <span class="nn">algotom.prep.calculation</span> <span class="k">as</span> <span class="nn">calc</span>
<span class="kn">import</span> <span class="nn">algotom.prep.removal</span> <span class="k">as</span> <span class="nn">remo</span>
<span class="kn">import</span> <span class="nn">algotom.prep.filtering</span> <span class="k">as</span> <span class="nn">filt</span>
<span class="kn">import</span> <span class="nn">algotom.rec.reconstruction</span> <span class="k">as</span> <span class="nn">rec</span>


<span class="n">file_path</span> <span class="o">=</span> <span class="s2">&quot;E:/Tomo_data/scan_68067.hdf&quot;</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">&quot;E:/output/rec_few_slices/&quot;</span>
<span class="n">proj_path</span> <span class="o">=</span> <span class="s2">&quot;entry/projections&quot;</span>  <span class="c1"># Refer section 1.2.1 to know how to get</span>
                                 <span class="c1"># path to a dataset in a hdf file.</span>
<span class="n">flat_path</span> <span class="o">=</span> <span class="s2">&quot;entry/flats&quot;</span>
<span class="n">dark_path</span> <span class="o">=</span> <span class="s2">&quot;entry/darks&quot;</span>

<span class="c1"># Load data, average flat and dark images</span>
<span class="n">proj_obj</span> <span class="o">=</span> <span class="n">losa</span><span class="o">.</span><span class="n">load_hdf</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">proj_path</span><span class="p">)</span>  <span class="c1"># hdf object</span>
<span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">proj_obj</span><span class="o">.</span><span class="n">shape</span>
<span class="n">flat_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">losa</span><span class="o">.</span><span class="n">load_hdf</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">flat_path</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">dark_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">losa</span><span class="o">.</span><span class="n">load_hdf</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">dark_path</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># If the rotation angles are not provided, e.g. from metadata of the HDF file,</span>
<span class="c1"># they can be generated automatically in a reconstruction method. Note that</span>
<span class="c1"># the rotation angles are in radians as requested by the reconstruction method.</span>
<span class="c1"># To rotate the reconstructed image, simply add an offset angle using the following method:</span>
<span class="n">offset_angle</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Degree</span>
<span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">offset_angle</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">180.0</span><span class="p">,</span> <span class="n">depth</span><span class="p">))</span>

<span class="c1"># Specify the range of slices to be reconstructed</span>
<span class="n">start_slice</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">stop_slice</span> <span class="o">=</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">100</span>
<span class="n">step_slice</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># Extract sinogram at the middle for calculating the center of rotation</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">height</span> <span class="o">//</span> <span class="mi">2</span>
<span class="n">sinogram</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">flat_field_correction</span><span class="p">(</span><span class="n">proj_obj</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">flat_field</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                                      <span class="n">dark_field</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
<span class="n">center</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">find_center_vo</span><span class="p">(</span><span class="n">sinogram</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Center of rotation: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">center</span><span class="p">))</span>

<span class="c1"># Extract sinograms and perform flat-field correction</span>
<span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_slice</span><span class="p">,</span> <span class="n">stop_slice</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step_slice</span><span class="p">):</span>
    <span class="n">sinogram</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">flat_field_correction</span><span class="p">(</span><span class="n">proj_obj</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">flat_field</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                                          <span class="n">dark_field</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
    <span class="c1"># Apply pre-processing methods</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Apply pre-processing methods: zinger removal, ring artifact removal, and/or denoising to sinograms.
Note that there are many choices for ring-removal methods, but for this step we may just want a
fast method.</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ...</span>
    <span class="c1"># Apply pre-processing methods</span>
    <span class="n">sinogram</span> <span class="o">=</span> <span class="n">remo</span><span class="o">.</span><span class="n">remove_zinger</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">)</span>
    <span class="n">sinogram</span> <span class="o">=</span> <span class="n">remo</span><span class="o">.</span><span class="n">remove_stripe_based_normalization</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
    <span class="n">sinogram</span> <span class="o">=</span> <span class="n">filt</span><span class="o">.</span><span class="n">fresnel_filter</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="c1"># Perform reconstruction</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Perform reconstruction and save the results to tif. Algotom provides reconstruction methods
that can run on either CPU or GPU. It also provides the wrappers of the <em>gridrec</em> method, available
in Tomopy, which is very fast for CPU-only computers; and iterative methods available in Astra
Toolbox. Note that if users want to use these additional wrappers, Tomopy and Astra will need to
be installed along with Algotom.</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ...</span>
    <span class="c1"># Perform reconstruction</span>
    <span class="c1"># Using a cpu method</span>
    <span class="n">rec_img</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">dfi_reconstruction</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="n">angles</span><span class="p">,</span>
                                     <span class="n">apply_log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># # Other options:</span>
    <span class="c1"># # Using a gpu method</span>
    <span class="c1"># rec_img = rec.fbp_reconstruction(sinogram, center, angles=angles,</span>
    <span class="c1">#                                  apply_log=True, gpu=True)</span>
    <span class="c1"># # Using a cpu method, available in Tomopy</span>
    <span class="c1"># rec_img = rec.gridrec_reconstruction(sinogram, center, angles=angles,</span>
    <span class="c1">#                                  apply_log=True)</span>
    <span class="c1"># # Using a gpu method, available in Astra Toolbox</span>
    <span class="c1"># rec_img = rec.astra_reconstruction(sinogram, center, angles=angles,</span>
    <span class="c1">#                                    method=&quot;SIRT_CUDA&quot;, num_iter=150,</span>
    <span class="c1">#                                    apply_log=True)</span>
    <span class="n">out_file</span> <span class="o">=</span> <span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/rec_&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;00000&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="o">+</span> <span class="s2">&quot;.tif&quot;</span>
    <span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">rec_img</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</section>
<section id="finding-the-center-of-rotation">
<h2><span class="section-number">4.5.3. </span>Finding the center of rotation<a class="headerlink" href="#finding-the-center-of-rotation" title="Permalink to this heading">¶</a></h2>
<p>Algotom offers several methods for automatically calculating the center of rotation (COR),
which refers to the rotation axis of the sample stage with respect to the FOV. These methods
work on different processing spaces (<a class="reference internal" href="#fig-4-5-1"><span class="std std-numref">Fig. 4.5.1</span></a>) and can be selected according to specific
types of input images.</p>
<blockquote>
<div><figure class="align-center" id="fig-4-5-1" style="width: 100%">
<img alt="../../_images/fig_4_5_1.png" src="../../_images/fig_4_5_1.png" />
<figcaption>
<p><span class="caption-number">Fig. 4.5.1 </span><span class="caption-text">Different processing spaces can be used for finding the center of rotation.</span><a class="headerlink" href="#fig-4-5-1" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</div></blockquote>
<ul>
<li><p>Methods that work in the <a class="reference external" href="https://algotom.readthedocs.io/en/latest/toc/api/algotom.prep.calculation.html#algotom.prep.calculation.find_shift_based_phase_correlation">projection space</a>
are the fastest and simplest, but they are also the least reliable.</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">timeit</span>
<span class="kn">import</span> <span class="nn">algotom.prep.calculation</span> <span class="k">as</span> <span class="nn">calc</span>

<span class="c1"># Data is at: https://doi.org/10.5281/zenodo.1443567</span>
<span class="c1"># Steps for loading data are similar to above sections</span>

<span class="n">proj_0</span> <span class="o">=</span> <span class="n">proj_obj</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">flat_field</span>
<span class="n">proj_180</span> <span class="o">=</span> <span class="n">proj_obj</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">flat_field</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Image size: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flat_field</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="n">center</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">find_center_based_phase_correlation</span><span class="p">(</span><span class="n">proj_0</span><span class="p">,</span> <span class="n">proj_180</span><span class="p">)</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using phase correlation. Center: </span><span class="si">{0}</span><span class="s2">. Time: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">t1</span> <span class="o">-</span><span class="n">t0</span><span class="p">))</span>

<span class="n">t0</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="n">center</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">find_center_projection</span><span class="p">(</span><span class="n">proj_0</span><span class="p">,</span> <span class="n">proj_180</span><span class="p">,</span> <span class="n">chunk_height</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using image correlation. Center: </span><span class="si">{0}</span><span class="s2">. Time: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">t1</span> <span class="o">-</span><span class="n">t0</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">&gt;&gt;&gt;</span>
<span class="go">Image size: (2160, 2560)</span>
<span class="go">Using phase correlation. Center: 1272.8564415436447. Time: 1.6949839999999998</span>
<span class="go">Using image correlation. Center: 1272.8176879882812. Time: 15.652110699999998</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>The most reliable method for automatically calculating the center of rotation is a <a class="reference external" href="https://algotom.readthedocs.io/en/latest/toc/api/algotom.prep.calculation.html#algotom.prep.calculation.find_center_vo">method</a>
that works on a 180-degree sinogram image, as proposed in <span id="id1">[<a class="reference internal" href="../credits.html#id5" title="Nghia T. Vo, Michael Drakopoulos, Robert C. Atwood, and Christina Reinhard. Reliable method for calculating the center of rotation in parallel-beam tomography. Opt. Express, 22(16):19078–19086, Aug 2014. URL: http://www.opticsexpress.org/abstract.cfm?URI=oe-22-16-19078, doi:10.1364/OE.22.019078.">R21</a>]</span>. This method has been
extensively tested on <a class="reference external" href="https://tomobank.readthedocs.io/en/latest/index.html">2,000 micro-tomography datasets</a>,
achieving a success rate of 98%. A visual explanation of how the method works is provided in <a class="reference internal" href="#fig-4-5-2"><span class="std std-numref">Fig. 4.5.2</span></a>.</p>
<blockquote>
<div><figure class="align-center" id="fig-4-5-2" style="width: 100%">
<img alt="../../_images/fig_4_5_2.png" src="../../_images/fig_4_5_2.png" />
<figcaption>
<p><span class="caption-number">Fig. 4.5.2 </span><span class="caption-text">Explanation of how the autocentering method in the sinogram space works.</span><a class="headerlink" href="#fig-4-5-2" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">idx</span> <span class="o">=</span> <span class="n">height</span> <span class="o">//</span> <span class="mi">2</span>
<span class="n">sinogram</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">flat_field_correction</span><span class="p">(</span><span class="n">proj_obj</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">flat_field</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                                      <span class="n">dark_field</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="n">radius</span> <span class="o">=</span> <span class="n">width</span> <span class="o">//</span> <span class="mi">16</span>
<span class="n">mid</span> <span class="o">=</span> <span class="n">width</span> <span class="o">//</span> <span class="mi">2</span>
<span class="c1"># Enable parallel computing using the &quot;ncore&quot; option.</span>
<span class="n">center</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">find_center_vo</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">mid</span> <span class="o">-</span> <span class="n">radius</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">mid</span> <span class="o">+</span> <span class="n">radius</span><span class="p">,</span>
                             <span class="n">ncore</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using sinogram metric. Center: </span><span class="si">{0}</span><span class="s2">. Time: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">&gt;&gt;&gt;</span>
<span class="go">Using sinogram metric. Center: 1272.75. Time: 8.0966264</span>
</pre></div>
</div>
<p>The method’s default parameters work for most X-ray microtomography datasets, as extensively tested. However,
users can adjust these parameters, such as the <em>ratio</em> and <em>ver_drop</em> parameters, to suit their data. A unique
feature of this method is the ability to average multiple sinograms to improve the signal-to-noise ratio and use
the result as input for the method. Note that strongly smoothed or blurry sinograms resulting from denoising methods
or phase-retrieval methods can impact the performance of this method.</p>
</div></blockquote>
</li>
<li><p>Another method, available from Algotom 1.3, works in the <a class="reference external" href="https://algotom.readthedocs.io/en/latest/toc/api/algotom.rec.reconstruction.html#algotom.rec.reconstruction.find_center_based_slice_metric">reconstruction space</a>
and evaluates a slice metric to determine the best center of rotation. This method is slower than the other methods
and is most suitable for performing small, fine searching ranges around the coarse center found by previous methods.
It may not be suitable for use on low SNR data.</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">algotom.rec.reconstruction</span> <span class="k">as</span> <span class="nn">rec</span>

<span class="n">t0</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="n">center</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">find_center_based_slice_metric</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">mid</span><span class="o">-</span><span class="n">radius</span><span class="p">,</span> <span class="n">mid</span> <span class="o">+</span> <span class="n">radius</span><span class="p">,</span>
                                            <span class="n">zoom</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;fbp&#39;</span><span class="p">,</span> <span class="n">gpu</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                            <span class="n">apply_log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using slice metric. Reconstruction method: FBP. Center: </span><span class="si">{0}</span><span class="s2">. Time: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>

<span class="n">t0</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="n">center</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">find_center_based_slice_metric</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">mid</span><span class="o">-</span><span class="n">radius</span><span class="p">,</span> <span class="n">mid</span> <span class="o">+</span> <span class="n">radius</span><span class="p">,</span>
                                            <span class="n">zoom</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;dfi&#39;</span><span class="p">,</span>
                                            <span class="n">apply_log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using slice metric. Reconstruction method: DFI. Center: </span><span class="si">{0}</span><span class="s2">. Time: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>

<span class="n">t0</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="n">center</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">find_center_based_slice_metric</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">mid</span><span class="o">-</span><span class="n">radius</span><span class="p">,</span> <span class="n">mid</span> <span class="o">+</span> <span class="n">radius</span><span class="p">,</span>
                                            <span class="n">zoom</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;gridrec&#39;</span><span class="p">,</span>
                                            <span class="n">apply_log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using slice metric. Reconstruction method: Gridrec. Center: </span><span class="si">{0}</span><span class="s2">. Time: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">&gt;&gt;&gt;</span>
<span class="go">Using slice metric. Reconstruction method: FBP. Center: 1272.5. Time: 104.3659703</span>
<span class="go">Using slice metric. Reconstruction method: DFI. Center: 1272.5. Time: 85.9248028</span>
<span class="go">Using slice metric. Reconstruction method: Gridrec. Center: 1272.5. Time: 14.54944309999999</span>
</pre></div>
</div>
<p>If users would like to apply a customized function for calculating a slice metric, it can be done as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">measure_metric</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">mat</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]))</span> <span class="o">**</span> <span class="n">n</span>
    <span class="k">return</span> <span class="n">metric</span>
<span class="n">center</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">find_center_based_slice_metric</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">mid</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="n">mid</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span>
                                            <span class="n">zoom</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;fbp&#39;</span><span class="p">,</span> <span class="n">gpu</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                            <span class="n">apply_log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                            <span class="n">metric_function</span><span class="o">=</span><span class="n">measure_metric</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>If the automated methods fail to find the center of rotation, users can rely on the following manual methods
(available from Algotom 1.3) to locate it:</p>
<blockquote>
<div><ul>
<li><p>The first <a class="reference external" href="https://algotom.readthedocs.io/en/latest/toc/api/algotom.util.utility.html#algotom.util.utility.find_center_visual_sinograms">manual method</a>
involves generating a list of 360-degree sinograms created from the input 180-degree sinogram using a list
of estimated CORs. Users can find the best COR by identifying the generated sinogram that has a continuous
transition between the two halves of the sinogram, as illustrated in the figure below.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">algotom.util.utility</span> <span class="k">as</span> <span class="nn">util</span>

<span class="n">output_base</span> <span class="o">=</span> <span class="s2">&quot;E:/tmp/manual_finding/using_sinograms/&quot;</span>
<span class="n">util</span><span class="o">.</span><span class="n">find_center_visual_sinograms</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">output_base</span><span class="p">,</span> <span class="n">width</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">20</span><span class="p">,</span> <span class="n">width</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span>
                                  <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/img_4_5_5.jpg" id="img-4-5-5"><img alt="../../_images/img_4_5_5.jpg" class="align-center" id="img-4-5-5" src="../../_images/img_4_5_5.jpg" style="width: 100%;" /></a>
</li>
<li><p>The second manual method involves reconstructing a list of slices using a list of estimated CORs. Users
can find the best COR by visually inspecting the reconstructed slices and selecting the one with the least
streak artifacts.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">output_base</span> <span class="o">=</span> <span class="s2">&quot;E:/tmp/manual_finding/using_slices/&quot;</span>
<span class="n">util</span><span class="o">.</span><span class="n">find_center_visual_slices</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">output_base</span><span class="p">,</span> <span class="n">width</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">20</span><span class="p">,</span>
                               <span class="n">width</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;fbp&quot;</span><span class="p">,</span> <span class="n">gpu</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/img_4_5_6.jpg" id="img-4-5-6"><img alt="../../_images/img_4_5_6.jpg" class="align-center" id="img-4-5-6" src="../../_images/img_4_5_6.jpg" style="width: 100%;" /></a>
</li>
</ul>
</div></blockquote>
</li>
</ul>
</section>
<section id="tweaking-parameters-of-preprocessing-methods">
<h2><span class="section-number">4.5.4. </span>Tweaking parameters of preprocessing methods<a class="headerlink" href="#tweaking-parameters-of-preprocessing-methods" title="Permalink to this heading">¶</a></h2>
<p>When reconstructing synchrotron-based X-ray microtomography data, users often spend most of time tweaking
parameters of preprocessing methods such as ring artifact removal or contrast-enhancement methods.
We can setup different workflows to test methods as below:</p>
<ul>
<li><p>To compare different ring removal methods; note that in Algotom, some well-known methods are improved
and have additional options for customization:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Steps for loading data are similar to above sections</span>

<span class="c1"># To create new output-folder for each time of running the script.</span>
<span class="n">output_base0</span> <span class="o">=</span> <span class="s2">&quot;E:/tmp/compare_ring_removal_methods/&quot;</span>
<span class="n">folder_name</span> <span class="o">=</span> <span class="n">losa</span><span class="o">.</span><span class="n">make_folder_name</span><span class="p">(</span><span class="n">output_base0</span><span class="p">,</span> <span class="n">name_prefix</span><span class="o">=</span><span class="s2">&quot;Ring_removal&quot;</span><span class="p">,</span> <span class="n">zero_prefix</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="n">output_base0</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">folder_name</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>

<span class="n">idx</span> <span class="o">=</span> <span class="n">height</span> <span class="o">//</span> <span class="mi">2</span>
<span class="n">sinogram</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">flat_field_correction</span><span class="p">(</span><span class="n">proj_obj</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">flat_field</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                                      <span class="n">dark_field</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
<span class="n">center</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">find_center_vo</span><span class="p">(</span><span class="n">sinogram</span><span class="p">)</span>

<span class="c1"># Using the combination of algorithms</span>
<span class="n">sinogram1</span> <span class="o">=</span> <span class="n">remo</span><span class="o">.</span><span class="n">remove_all_stripe</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">snr</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">la_size</span><span class="o">=</span><span class="mi">51</span><span class="p">,</span> <span class="n">sm_size</span><span class="o">=</span><span class="mi">21</span><span class="p">)</span>
<span class="n">rec_img</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">fbp_reconstruction</span><span class="p">(</span><span class="n">sinogram1</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
<span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/remove_all_stripe.tif&quot;</span><span class="p">,</span> <span class="n">rec_img</span><span class="p">)</span>

<span class="c1"># Using the sorting-based method</span>
<span class="n">sinogram2</span> <span class="o">=</span> <span class="n">remo</span><span class="o">.</span><span class="n">remove_stripe_based_sorting</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">rec_img</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">fbp_reconstruction</span><span class="p">(</span><span class="n">sinogram2</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
<span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/remove_stripe_based_sorting.tif&quot;</span><span class="p">,</span> <span class="n">rec_img</span><span class="p">)</span>

<span class="c1"># Using the fitting-based method</span>
<span class="n">sinogram3</span> <span class="o">=</span> <span class="n">remo</span><span class="o">.</span><span class="n">remove_stripe_based_fitting</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">rec_img</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">fbp_reconstruction</span><span class="p">(</span><span class="n">sinogram3</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
<span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/remove_stripe_based_fitting.tif&quot;</span><span class="p">,</span> <span class="n">rec_img</span><span class="p">)</span>

<span class="c1"># Using the filtering-based method</span>
<span class="n">sinogram4</span> <span class="o">=</span> <span class="n">remo</span><span class="o">.</span><span class="n">remove_stripe_based_filtering</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                               <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">rec_img</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">fbp_reconstruction</span><span class="p">(</span><span class="n">sinogram4</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
<span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/remove_stripe_based_filtering.tif&quot;</span><span class="p">,</span> <span class="n">rec_img</span><span class="p">)</span>

<span class="c1"># Using the 2d filtering and sorting-based method</span>
<span class="n">sinogram5</span> <span class="o">=</span> <span class="n">remo</span><span class="o">.</span><span class="n">remove_stripe_based_2d_filtering_sorting</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                                          <span class="n">size</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">rec_img</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">fbp_reconstruction</span><span class="p">(</span><span class="n">sinogram5</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
<span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/remove_stripe_based_2d_filtering_sorting.tif&quot;</span><span class="p">,</span> <span class="n">rec_img</span><span class="p">)</span>

<span class="c1"># Using the interpolation-based method</span>
<span class="n">sinogram6</span> <span class="o">=</span> <span class="n">remo</span><span class="o">.</span><span class="n">remove_stripe_based_interpolation</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">snr</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">51</span><span class="p">)</span>
<span class="n">rec_img</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">fbp_reconstruction</span><span class="p">(</span><span class="n">sinogram6</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
<span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/remove_stripe_based_interpolation.tif&quot;</span><span class="p">,</span> <span class="n">rec_img</span><span class="p">)</span>

<span class="c1"># Using the normalization-based method</span>
<span class="n">sinogram7</span> <span class="o">=</span> <span class="n">remo</span><span class="o">.</span><span class="n">remove_stripe_based_normalization</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">rec_img</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">fbp_reconstruction</span><span class="p">(</span><span class="n">sinogram7</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
<span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/remove_stripe_based_normalization.tif&quot;</span><span class="p">,</span> <span class="n">rec_img</span><span class="p">)</span>

<span class="c1"># Using the regularization-based method</span>
<span class="n">sinogram8</span> <span class="o">=</span> <span class="n">remo</span><span class="o">.</span><span class="n">remove_stripe_based_regularization</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">,</span>
                                                    <span class="n">num_chunk</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">apply_log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                    <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">rec_img</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">fbp_reconstruction</span><span class="p">(</span><span class="n">sinogram8</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
<span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/remove_stripe_based_regularization.tif&quot;</span><span class="p">,</span> <span class="n">rec_img</span><span class="p">)</span>

<span class="c1"># Using the fft-based method</span>
<span class="n">sinogram9</span> <span class="o">=</span> <span class="n">remo</span><span class="o">.</span><span class="n">remove_stripe_based_fft</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">rec_img</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">fbp_reconstruction</span><span class="p">(</span><span class="n">sinogram9</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
<span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/remove_stripe_based_fft.tif&quot;</span><span class="p">,</span> <span class="n">rec_img</span><span class="p">)</span>

<span class="c1"># Using the wavelet-fft-based method</span>
<span class="n">sinogram10</span> <span class="o">=</span> <span class="n">remo</span><span class="o">.</span><span class="n">remove_stripe_based_wavelet_fft</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                 <span class="n">wavelet_name</span><span class="o">=</span><span class="s1">&#39;db9&#39;</span><span class="p">,</span>
                                                 <span class="n">window_name</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">rec_img</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">fbp_reconstruction</span><span class="p">(</span><span class="n">sinogram10</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
<span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/remove_stripe_based_wavelet_fft.tif&quot;</span><span class="p">,</span> <span class="n">rec_img</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>To perform scanning a parameter of a ring removal method</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># To create new output-folder for each time of running the script.</span>
<span class="n">output_base0</span> <span class="o">=</span> <span class="s2">&quot;E:/tmp/scan_parameters/&quot;</span>
<span class="n">folder_name</span> <span class="o">=</span> <span class="n">losa</span><span class="o">.</span><span class="n">make_folder_name</span><span class="p">(</span><span class="n">output_base0</span><span class="p">,</span> <span class="n">name_prefix</span><span class="o">=</span><span class="s2">&quot;Scan_ratio&quot;</span><span class="p">,</span> <span class="n">zero_prefix</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="n">output_base0</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">folder_name</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>

<span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mi">20</span><span class="p">):</span>
    <span class="n">sinogram1</span> <span class="o">=</span> <span class="n">remo</span><span class="o">.</span><span class="n">remove_all_stripe</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">snr</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">la_size</span><span class="o">=</span><span class="mi">51</span><span class="p">,</span> <span class="n">sm_size</span><span class="o">=</span><span class="mi">21</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;snr_</span><span class="si">{0:2.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">rec_img</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">fbp_reconstruction</span><span class="p">(</span><span class="n">sinogram1</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
    <span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/scan_value_&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="n">rec_img</span><span class="p">)</span>
</pre></div>
</div>
<p>or a contrast-enhancement method</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1600</span><span class="p">,</span> <span class="mi">400</span><span class="p">):</span>
    <span class="n">sinogram1</span> <span class="o">=</span> <span class="n">filt</span><span class="o">.</span><span class="n">fresnel_filter</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;snr_</span><span class="si">{0:4.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
    <span class="n">rec_img</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">fbp_reconstruction</span><span class="p">(</span><span class="n">sinogram1</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
    <span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/scan_value_&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="n">rec_img</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/img_4_5_7.jpg" id="img-4-5-7"><img alt="../../_images/img_4_5_7.jpg" class="align-center" id="img-4-5-7" src="../../_images/img_4_5_7.jpg" style="width: 100%;" /></a>
</li>
</ul>
</section>
<section id="choosing-a-reconstruction-method">
<h2><span class="section-number">4.5.5. </span>Choosing a reconstruction method<a class="headerlink" href="#choosing-a-reconstruction-method" title="Permalink to this heading">¶</a></h2>
<p>The quality of reconstructed data in synchrotron-based X-ray microtomography depends heavily on the
preprocessing methods applied. If the number of acquired projections is standard and the data are properly cleaned,
the choice of reconstruction method will have less impact on the quality of the final results. Therefore, users can
choose a reconstruction method based on the availability of computing resources.</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">output_base</span> <span class="o">=</span> <span class="s2">&quot;E:/tmp/compare_reconstruction_methods/&quot;</span>

<span class="c1"># Using the direct Fourier inversion method (CPU)</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="n">rec_img</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">dfi_reconstruction</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reconstructed image size: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rec_img</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/DFI_method_cpu.tif&quot;</span><span class="p">,</span> <span class="n">rec_img</span><span class="p">)</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using the DFI method (CPU). Time: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>

<span class="c1"># Using the filtered back-projection method (CPU)</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="n">rec_img</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">fbp_reconstruction</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/FBP_method_cpu.tif&quot;</span><span class="p">,</span> <span class="n">rec_img</span><span class="p">)</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using the FBP method (CPU). Time: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>

<span class="c1"># Using the filtered back-projection method (GPU)</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="n">rec_img</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">fbp_reconstruction</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">gpu</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/FBP_method_gpu.tif&quot;</span><span class="p">,</span> <span class="n">rec_img</span><span class="p">)</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using the FBP method (GPU). Time: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>

<span class="c1"># Using the gridrec method (CPU)</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="n">rec_img</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">gridrec_reconstruction</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">ncore</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/gridrec_method_cpu.tif&quot;</span><span class="p">,</span> <span class="n">rec_img</span><span class="p">)</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using the gridrec method (CPU). Time: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">&gt;&gt;&gt;</span>
<span class="go">Reconstructed image size: (2560, 2560)</span>
<span class="go">Using the DFI method (CPU). Time: 12.7383788</span>
<span class="go">Using the FBP method (CPU). Time: 5.827241100000002</span>
<span class="go">Using the FBP method (GPU). Time: 3.001648600000003</span>
<span class="go">Using the gridrec method (CPU). Time: 1.7366413999999963</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/img_4_5_8.jpg" id="img-4-5-8"><img alt="../../_images/img_4_5_8.jpg" class="align-center" id="img-4-5-8" src="../../_images/img_4_5_8.jpg" style="width: 100%;" /></a>
</div></blockquote>
<p>When dealing with undersampled sinogram, iterative reconstruction methods like SIRT <a class="reference external" href="https://doi.org/10.1016/0022-5193(72)90180-4">(Simultaneous iterative reconstruction technique)</a>
can be advantageous over Fourier-based methods. However, iterative methods are computationally
expensive. A workaround is to improve the Fourier-based methods by applying denoising and
<a class="reference external" href="https://algotom.readthedocs.io/en/latest/toc/api/algotom.prep.correction.html#algotom.prep.correction.upsample_sinogram">upsampling methods</a> (Algotom &gt;=1.3)
to the sinogram.</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">output_base</span> <span class="o">=</span> <span class="s2">&quot;E:/tmp/improve_fft_method/&quot;</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sinogram size </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sinogram</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="c1"># Using FBP method</span>
<span class="n">rec_img1</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">fbp_reconstruction</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">filter_name</span><span class="o">=</span><span class="s2">&quot;hann&quot;</span><span class="p">)</span>
<span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/fbp_recon.tif&quot;</span><span class="p">,</span> <span class="n">rec_img1</span><span class="p">)</span>

<span class="c1"># Using SIRT method with 150 number of iterations</span>
<span class="n">rec_img2</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">astra_reconstruction</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;SIRT_CUDA&quot;</span><span class="p">,</span> <span class="n">num_iter</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
<span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/sirt_recon.tif&quot;</span><span class="p">,</span> <span class="n">rec_img2</span><span class="p">)</span>

<span class="c1"># Denosing + upsampling sinogram + FBP reconstruction</span>
<span class="n">sinogram</span> <span class="o">=</span> <span class="n">filt</span><span class="o">.</span><span class="n">fresnel_filter</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">sinogram</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">upsample_sinogram</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Upsampled sinogram size </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sinogram</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="n">rec_img3</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">fbp_reconstruction</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">filter_name</span><span class="o">=</span><span class="s2">&quot;hann&quot;</span><span class="p">)</span>
<span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/fbp_denoising_upsampling.tif&quot;</span><span class="p">,</span> <span class="n">rec_img3</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/img_4_5_9.jpg" id="img-4-5-9"><img alt="../../_images/img_4_5_9.jpg" class="align-center" id="img-4-5-9" src="../../_images/img_4_5_9.jpg" style="width: 100%;" /></a>
</div></blockquote>
</section>
<section id="performing-full-reconstruction">
<h2><span class="section-number">4.5.6. </span>Performing full reconstruction<a class="headerlink" href="#performing-full-reconstruction" title="Permalink to this heading">¶</a></h2>
<p>After completing all the steps for selecting parameters and testing methods, we can proceed with the
full reconstruction process. The main difference compared to the previous steps is that
sinograms are processed in chunks, which reduces I/O overhead and utilizes parallel processing.
The following codes are available <a class="reference external" href="https://github.com/algotom/algotom/tree/master/examples/common_data_processing_workflow/full_reconstruction">here</a>
for both tif and hdf input formats, but we can break down the workflow and provide detailed explanations:</p>
<ul>
<li><p>Import the necessary modules from Algotom, specify the input and output paths, and add
options to make it easier to modify the workflow later on.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">timeit</span>
<span class="kn">import</span> <span class="nn">algotom.io.loadersaver</span> <span class="k">as</span> <span class="nn">losa</span>
<span class="kn">import</span> <span class="nn">algotom.prep.correction</span> <span class="k">as</span> <span class="nn">corr</span>
<span class="kn">import</span> <span class="nn">algotom.prep.calculation</span> <span class="k">as</span> <span class="nn">calc</span>
<span class="kn">import</span> <span class="nn">algotom.rec.reconstruction</span> <span class="k">as</span> <span class="nn">rec</span>
<span class="kn">import</span> <span class="nn">algotom.prep.removal</span> <span class="k">as</span> <span class="nn">remo</span>
<span class="kn">import</span> <span class="nn">algotom.prep.filtering</span> <span class="k">as</span> <span class="nn">filt</span>
<span class="kn">import</span> <span class="nn">algotom.util.utility</span> <span class="k">as</span> <span class="nn">util</span>

<span class="c1"># Input file</span>
<span class="n">file_path</span> <span class="o">=</span> <span class="s2">&quot;E:/Tomo_data/scan_68067.hdf&quot;</span>

<span class="c1"># Specify output path, create new folder each time of running to avoid overwriting data.</span>
<span class="n">output_base0</span> <span class="o">=</span> <span class="s2">&quot;E:/full_reconstruction/&quot;</span>
<span class="n">folder_name</span> <span class="o">=</span> <span class="n">losa</span><span class="o">.</span><span class="n">make_folder_name</span><span class="p">(</span><span class="n">output_base0</span><span class="p">,</span> <span class="n">name_prefix</span><span class="o">=</span><span class="s2">&quot;recon&quot;</span><span class="p">,</span> <span class="n">zero_prefix</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="n">output_base0</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">folder_name</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>

<span class="c1"># Optional parameters</span>
<span class="n">start_slice</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">stop_slice</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">chunk</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># Number of slices to be reconstructed in one go. Adjust to suit RAM or GPU memory.</span>
<span class="n">ncore</span> <span class="o">=</span> <span class="mi">16</span>  <span class="c1"># Number of cpu-core for parallel processing. Set to None for autoselecting.</span>
<span class="n">output_format</span> <span class="o">=</span> <span class="s2">&quot;tif&quot;</span>  <span class="c1"># &quot;tif&quot; or &quot;hdf&quot;.</span>
<span class="n">preprocessing</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Clean data before reconstruction.</span>

<span class="c1"># Give alias to a reconstruction method which is convenient for later change</span>
<span class="c1"># recon_method = rec.dfi_reconstruction</span>
<span class="c1"># recon_method = rec.fbp_reconstruction</span>
<span class="n">recon_method</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">gridrec_reconstruction</span> <span class="c1"># Fast cpu-method. Must install Tomopy.</span>
<span class="c1"># recon_method = rec.astra_reconstruction # To use iterative methods. Must install Astra.</span>

<span class="c1"># Provide metadata for loading hdf file, get data shape and rotation angles.</span>
<span class="n">proj_path</span> <span class="o">=</span> <span class="s2">&quot;/entry/projections&quot;</span>
<span class="n">flat_path</span> <span class="o">=</span> <span class="s2">&quot;/entry/flats&quot;</span>
<span class="n">dark_path</span> <span class="o">=</span> <span class="s2">&quot;/entry/darks&quot;</span>
<span class="n">angle_path</span> <span class="o">=</span> <span class="s2">&quot;/entry/rotation_angle&quot;</span>
</pre></div>
</div>
</li>
<li><p>Load dark-field images, flat-field images, rotation angles; and calculate the center of rotation.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">t_start</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------------------------&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----------------------------Start-----------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;1 -&gt; Load dark-field and flat-field images, average each result&quot;</span><span class="p">)</span>
<span class="c1"># Load data, average flat and dark images, get data shape and rotation angles.</span>
<span class="n">proj_obj</span> <span class="o">=</span> <span class="n">losa</span><span class="o">.</span><span class="n">load_hdf</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">proj_path</span><span class="p">)</span>  <span class="c1"># hdf object</span>
<span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">proj_obj</span><span class="o">.</span><span class="n">shape</span>
<span class="n">flat_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">losa</span><span class="o">.</span><span class="n">load_hdf</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">flat_path</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">dark_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">losa</span><span class="o">.</span><span class="n">load_hdf</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">dark_path</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">losa</span><span class="o">.</span><span class="n">load_hdf</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">angle_path</span><span class="p">))))</span>
<span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">proj_obj</span><span class="o">.</span><span class="n">shape</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2 -&gt; Calculate the center-of-rotation&quot;</span><span class="p">)</span>
<span class="c1"># Extract sinogram at the middle for calculating the center of rotation</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">height</span> <span class="o">//</span> <span class="mi">2</span>
<span class="n">sinogram</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">flat_field_correction</span><span class="p">(</span><span class="n">proj_obj</span><span class="p">[:,</span> <span class="n">index</span><span class="p">,</span> <span class="p">:],</span> <span class="n">flat_field</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:],</span>
                                      <span class="n">dark_field</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:])</span>
<span class="n">center</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">find_center_vo</span><span class="p">(</span><span class="n">sinogram</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Center-of-rotation is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">center</span><span class="p">))</span>
</pre></div>
</div>
</li>
<li><p>Loop through the sinograms chunk-by-chunk, apply the selected pre-processing methods in parallel,
and perform the reconstruction.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">stop_slice</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">stop_slice</span> <span class="o">&gt;</span> <span class="n">height</span><span class="p">):</span>
    <span class="n">stop_slice</span> <span class="o">=</span> <span class="n">height</span>
<span class="n">total_slice</span> <span class="o">=</span> <span class="n">stop_slice</span> <span class="o">-</span> <span class="n">start_slice</span>
<span class="k">if</span> <span class="n">output_format</span> <span class="o">==</span> <span class="s2">&quot;hdf&quot;</span><span class="p">:</span>
    <span class="c1"># Note about the change of data-shape</span>
    <span class="n">recon_hdf</span> <span class="o">=</span> <span class="n">losa</span><span class="o">.</span><span class="n">open_hdf_stream</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/recon_data.hdf&quot;</span><span class="p">,</span>
                                     <span class="p">(</span><span class="n">total_slice</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span>
                                     <span class="n">key_path</span><span class="o">=</span><span class="s1">&#39;entry/data&#39;</span><span class="p">,</span>
                                     <span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">t_load</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">t_prep</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">t_rec</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">t_save</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">chunk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">total_slice</span><span class="p">)</span>
<span class="n">last_chunk</span> <span class="o">=</span> <span class="n">total_slice</span> <span class="o">-</span> <span class="n">chunk</span> <span class="o">*</span> <span class="p">(</span><span class="n">total_slice</span> <span class="o">//</span> <span class="n">chunk</span><span class="p">)</span>

<span class="c1"># Perform full reconstruction</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start_slice</span><span class="p">,</span> <span class="n">start_slice</span> <span class="o">+</span> <span class="n">total_slice</span> <span class="o">-</span> <span class="n">last_chunk</span><span class="p">,</span> <span class="n">chunk</span><span class="p">):</span>
    <span class="n">start_sino</span> <span class="o">=</span> <span class="n">i</span>
    <span class="n">stop_sino</span> <span class="o">=</span> <span class="n">start_sino</span> <span class="o">+</span> <span class="n">chunk</span>
    <span class="c1"># Load data, perform flat-field correction</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
    <span class="n">sinograms</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">flat_field_correction</span><span class="p">(</span>
        <span class="n">proj_obj</span><span class="p">[:,</span> <span class="n">start_sino</span><span class="p">:</span><span class="n">stop_sino</span><span class="p">,</span> <span class="p">:],</span>
        <span class="n">flat_field</span><span class="p">[</span><span class="n">start_sino</span><span class="p">:</span><span class="n">stop_sino</span><span class="p">,</span> <span class="p">:],</span>
        <span class="n">dark_field</span><span class="p">[</span><span class="n">start_sino</span><span class="p">:</span><span class="n">stop_sino</span><span class="p">,</span> <span class="p">:])</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
    <span class="n">t_load</span> <span class="o">=</span> <span class="n">t_load</span> <span class="o">+</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span>

    <span class="c1"># Perform pre-processing</span>
    <span class="k">if</span> <span class="n">preprocessing</span><span class="p">:</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
        <span class="n">sinograms</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">apply_method_to_multiple_sinograms</span><span class="p">(</span><span class="n">sinograms</span><span class="p">,</span>
                                                            <span class="s2">&quot;remove_zinger&quot;</span><span class="p">,</span>
                                                            <span class="p">[</span><span class="mf">0.08</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                                            <span class="n">ncore</span><span class="o">=</span><span class="n">ncore</span><span class="p">,</span>
                                                            <span class="n">prefer</span><span class="o">=</span><span class="s2">&quot;threads&quot;</span><span class="p">)</span>
        <span class="n">sinograms</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">apply_method_to_multiple_sinograms</span><span class="p">(</span><span class="n">sinograms</span><span class="p">,</span>
                                                            <span class="s2">&quot;remove_all_stripe&quot;</span><span class="p">,</span>
                                                            <span class="p">[</span><span class="mf">3.0</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">21</span><span class="p">],</span>
                                                            <span class="n">ncore</span><span class="o">=</span><span class="n">ncore</span><span class="p">,</span>
                                                            <span class="n">prefer</span><span class="o">=</span><span class="s2">&quot;threads&quot;</span><span class="p">)</span>
        <span class="n">sinograms</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">apply_method_to_multiple_sinograms</span><span class="p">(</span><span class="n">sinograms</span><span class="p">,</span>
                                                            <span class="s2">&quot;fresnel_filter&quot;</span><span class="p">,</span>
                                                            <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                                            <span class="n">ncore</span><span class="o">=</span><span class="n">ncore</span><span class="p">,</span>
                                                            <span class="n">prefer</span><span class="o">=</span><span class="s2">&quot;threads&quot;</span><span class="p">)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
        <span class="n">t_prep</span> <span class="o">=</span> <span class="n">t_prep</span> <span class="o">+</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span>

    <span class="c1"># Perform reconstruction</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
    <span class="n">recon_imgs</span> <span class="o">=</span> <span class="n">recon_method</span><span class="p">(</span><span class="n">sinograms</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="n">angles</span><span class="p">,</span> <span class="n">ncore</span><span class="o">=</span><span class="n">ncore</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
    <span class="n">t_rec</span> <span class="o">=</span> <span class="n">t_rec</span> <span class="o">+</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span>

    <span class="c1"># Save output</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">output_format</span> <span class="o">==</span> <span class="s2">&quot;hdf&quot;</span><span class="p">:</span>
        <span class="n">recon_hdf</span><span class="p">[</span><span class="n">start_sino</span> <span class="o">-</span> <span class="n">start_slice</span><span class="p">:</span><span class="n">stop_sino</span> <span class="o">-</span> <span class="n">start_slice</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">recon_imgs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_sino</span><span class="p">,</span> <span class="n">stop_sino</span><span class="p">):</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/rec_&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;0000&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">))[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="o">+</span> <span class="s2">&quot;.tif&quot;</span>
            <span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">recon_imgs</span><span class="p">[:,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">start_sino</span><span class="p">,</span> <span class="p">:])</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
    <span class="n">t_save</span> <span class="o">=</span> <span class="n">t_save</span> <span class="o">+</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span>
    <span class="n">t_stop</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done slice: </span><span class="si">{0}</span><span class="s2"> - </span><span class="si">{1}</span><span class="s2"> . Time </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start_sino</span><span class="p">,</span> <span class="n">stop_sino</span><span class="p">,</span>
                                                    <span class="n">t_stop</span> <span class="o">-</span> <span class="n">t_start</span><span class="p">))</span>
<span class="k">if</span> <span class="n">last_chunk</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">start_sino</span> <span class="o">=</span> <span class="n">start_slice</span> <span class="o">+</span> <span class="n">total_slice</span> <span class="o">-</span> <span class="n">last_chunk</span>
    <span class="n">stop_sino</span> <span class="o">=</span> <span class="n">start_sino</span> <span class="o">+</span> <span class="n">last_chunk</span>

    <span class="c1"># Load data, perform flat-field correction</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
    <span class="n">sinograms</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">flat_field_correction</span><span class="p">(</span>
        <span class="n">proj_obj</span><span class="p">[:,</span> <span class="n">start_sino</span><span class="p">:</span><span class="n">stop_sino</span><span class="p">,</span> <span class="p">:],</span>
        <span class="n">flat_field</span><span class="p">[</span><span class="n">start_sino</span><span class="p">:</span><span class="n">stop_sino</span><span class="p">,</span> <span class="p">:],</span>
        <span class="n">dark_field</span><span class="p">[</span><span class="n">start_sino</span><span class="p">:</span><span class="n">stop_sino</span><span class="p">,</span> <span class="p">:])</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
    <span class="n">t_load</span> <span class="o">=</span> <span class="n">t_load</span> <span class="o">+</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span>

    <span class="c1"># Perform pre-processing</span>
    <span class="k">if</span> <span class="n">preprocessing</span><span class="p">:</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
        <span class="n">sinograms</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">apply_method_to_multiple_sinograms</span><span class="p">(</span><span class="n">sinograms</span><span class="p">,</span>
                                                            <span class="s2">&quot;remove_zinger&quot;</span><span class="p">,</span>
                                                            <span class="p">[</span><span class="mf">0.08</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                                            <span class="n">ncore</span><span class="o">=</span><span class="n">ncore</span><span class="p">,</span>
                                                            <span class="n">prefer</span><span class="o">=</span><span class="s2">&quot;threads&quot;</span><span class="p">)</span>
        <span class="n">sinograms</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">apply_method_to_multiple_sinograms</span><span class="p">(</span><span class="n">sinograms</span><span class="p">,</span>
                                                            <span class="s2">&quot;remove_all_stripe&quot;</span><span class="p">,</span>
                                                            <span class="p">[</span><span class="mf">3.0</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">21</span><span class="p">],</span>
                                                            <span class="n">ncore</span><span class="o">=</span><span class="n">ncore</span><span class="p">,</span>
                                                            <span class="n">prefer</span><span class="o">=</span><span class="s2">&quot;threads&quot;</span><span class="p">)</span>
        <span class="n">sinograms</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">apply_method_to_multiple_sinograms</span><span class="p">(</span><span class="n">sinograms</span><span class="p">,</span>
                                                            <span class="s2">&quot;fresnel_filter&quot;</span><span class="p">,</span>
                                                            <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                                            <span class="n">ncore</span><span class="o">=</span><span class="n">ncore</span><span class="p">)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
        <span class="n">t_prep</span> <span class="o">=</span> <span class="n">t_prep</span> <span class="o">+</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span>

    <span class="c1"># Perform reconstruction</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
    <span class="n">recon_imgs</span> <span class="o">=</span> <span class="n">recon_method</span><span class="p">(</span><span class="n">sinograms</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="n">angles</span><span class="p">,</span> <span class="n">ncore</span><span class="o">=</span><span class="n">ncore</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
    <span class="n">t_rec</span> <span class="o">=</span> <span class="n">t_rec</span> <span class="o">+</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span>

    <span class="c1"># Save output</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">output_format</span> <span class="o">==</span> <span class="s2">&quot;hdf&quot;</span><span class="p">:</span>
        <span class="n">recon_hdf</span><span class="p">[</span><span class="n">start_sino</span> <span class="o">-</span> <span class="n">start_slice</span><span class="p">:</span><span class="n">stop_sino</span> <span class="o">-</span> <span class="n">start_slice</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">recon_imgs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_sino</span><span class="p">,</span> <span class="n">stop_sino</span><span class="p">):</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/rec_&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;0000&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">))[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="o">+</span> <span class="s2">&quot;.tif&quot;</span>
            <span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">recon_imgs</span><span class="p">[:,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">start_sino</span><span class="p">,</span> <span class="p">:])</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
    <span class="n">t_save</span> <span class="o">=</span> <span class="n">t_save</span> <span class="o">+</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span>
    <span class="n">t_stop</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done slice: </span><span class="si">{0}</span><span class="s2"> - </span><span class="si">{1}</span><span class="s2"> . Time </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start_sino</span><span class="p">,</span> <span class="n">stop_sino</span><span class="p">,</span>
                                                    <span class="n">t_stop</span> <span class="o">-</span> <span class="n">t_start</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------------------------&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----------------------------Done-----------------------------&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading data cost: </span><span class="si">{0:0.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t_load</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Preprocessing cost: </span><span class="si">{0:0.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t_prep</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reconstruction cost: </span><span class="si">{0:0.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t_rec</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving output cost: </span><span class="si">{0:0.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t_save</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total time cost : </span><span class="si">{0:0.2f}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t_stop</span> <span class="o">-</span> <span class="n">t_start</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">&gt;&gt;&gt;</span>
<span class="go">---------------------------------------------------------------</span>
<span class="go">-----------------------------Start-----------------------------</span>

<span class="go">1 -&gt; Load dark-field and flat-field images, average each result</span>
<span class="go">2 -&gt; Calculate the center-of-rotation</span>
<span class="go">Center-of-rotation is 1272.75</span>
<span class="go">Done slice: 10 - 110 . Time 189.6021034</span>
<span class="go">Done slice: 110 - 210 . Time 366.9538149</span>
<span class="go">Done slice: 210 - 310 . Time 579.1721645</span>
<span class="go">Done slice: 310 - 410 . Time 783.6394176</span>
<span class="go">Done slice: 410 - 510 . Time 1001.0833168</span>
<span class="go">Done slice: 510 - 610 . Time 1206.3565348</span>
<span class="go">Done slice: 610 - 710 . Time 1415.9822423</span>
<span class="go">Done slice: 710 - 810 . Time 1630.9875868</span>
<span class="go">Done slice: 810 - 910 . Time 1844.1762275</span>
<span class="go">Done slice: 910 - 1010 . Time 2052.5243417</span>
<span class="go">Done slice: 1010 - 1110 . Time 2266.1704849000002</span>
<span class="go">Done slice: 1110 - 1210 . Time 2485.4279775</span>
<span class="go">Done slice: 1210 - 1310 . Time 2695.1756578000004</span>
<span class="go">Done slice: 1310 - 1410 . Time 2902.663489</span>
<span class="go">Done slice: 1410 - 1510 . Time 3122.5606983000002</span>
<span class="go">Done slice: 1510 - 1610 . Time 3333.1580989000004</span>
<span class="go">Done slice: 1610 - 1710 . Time 3545.0758953000004</span>
<span class="go">Done slice: 1710 - 1810 . Time 3758.1900975000003</span>
<span class="go">Done slice: 1810 - 1910 . Time 3974.6899012000003</span>
<span class="go">Done slice: 1910 - 2010 . Time 4181.2648382</span>
<span class="go">Done slice: 2010 - 2110 . Time 4389.6914713999995</span>
<span class="go">Done slice: 2110 - 2160 . Time 4511.7352912</span>
<span class="go">---------------------------------------------------------------</span>
<span class="go">-----------------------------Done-----------------------------</span>
<span class="go">Loading data cost: 675.88s</span>
<span class="go">Preprocessing cost: 3213.10s</span>
<span class="go">Reconstruction cost: 337.11s</span>
<span class="go">Saving output cost: 276.67s</span>
<span class="go">Total time cost : 4511.74s</span>
</pre></div>
</div>
<p>As shown in the time cost list above, the most time-consuming step is pre-processing,
specifically the <em>remove_all_stripe</em> method, which relies on the median filter. Although
other options for faster ring removal methods are available, parameter tweaking may be
required for individual slices or datasets within the same experiment, which is impractical.
The advantage of the <em>remove_all_stripe</em> method is that <a class="reference external" href="https://opg.optica.org/oe/fulltext.cfm?uri=oe-26-22-28396&amp;id=399265#g025">the same set of parameters</a>
can be applied to the entire volume and different datasets.</p>
</li>
</ul>
</section>
<section id="automating-the-workflow">
<h2><span class="section-number">4.5.7. </span>Automating the workflow<a class="headerlink" href="#automating-the-workflow" title="Permalink to this heading">¶</a></h2>
<p>In practice, we often need to reconstruct not just one but hundreds or even thousands of datasets
per synchrotron beamtime. In these cases, manually processing each dataset would be time-consuming
and impractical. Instead, we can leverage the power of Python to automate the workflow.
The idea is to create a Python script that can iterate through a list of datasets and pass the path
of each dataset to the full reconstruction script for processing, either one-by-one on a local workstation
or in parallel on a cluster.</p>
<p>We need to modify the full-reconstruction script to accept the file path as a command-line argument.
This will allow us to pass the file path to the script dynamically from our automation script.
There are several ways of doing this:</p>
<blockquote>
<div><ul>
<li><p>Using the <em>sys</em> module:</p>
<blockquote>
<div><p>Modify the top of the full reconstruction script:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#  Script to perform full reconstruction, named full_reconstruction.py</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">timeit</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">algotom.io.loadersaver</span> <span class="k">as</span> <span class="nn">losa</span>
<span class="kn">import</span> <span class="nn">algotom.util.utility</span> <span class="k">as</span> <span class="nn">util</span>
<span class="kn">import</span> <span class="nn">algotom.prep.correction</span> <span class="k">as</span> <span class="nn">corr</span>
<span class="kn">import</span> <span class="nn">algotom.prep.calculation</span> <span class="k">as</span> <span class="nn">calc</span>
<span class="kn">import</span> <span class="nn">algotom.prep.removal</span> <span class="k">as</span> <span class="nn">remo</span>
<span class="kn">import</span> <span class="nn">algotom.prep.filtering</span> <span class="k">as</span> <span class="nn">filt</span>
<span class="kn">import</span> <span class="nn">algotom.rec.reconstruction</span> <span class="k">as</span> <span class="nn">rec</span>


<span class="n">file_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1">#  sys.argv[0] is the name of this script.</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="c1"># To pass arguments to this script, run:</span>
<span class="c1"># python full_reconstruction.py arg1 arg2</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Load file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
<span class="c1">#  Script body ...</span>
</pre></div>
</div>
<p>Then use the automation script as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#  Script to call the full reconstruction script</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="n">python_interpreter</span> <span class="o">=</span> <span class="s2">&quot;C:/Users/nvo/Miniconda3/envs/algotom/python&quot;</span>
<span class="n">python_script</span> <span class="o">=</span> <span class="s2">&quot;full_reconstruction.py&quot;</span> <span class="c1">#  At the same location of this script. Otherwise,</span>
                                         <span class="c1">#  providing the full path to full_reconstruction.py</span>

<span class="n">input_folder</span> <span class="o">=</span> <span class="s2">&quot;E:/datasets/&quot;</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">&quot;E:/full_reconstruction/&quot;</span>
<span class="c1"># Get a list of hdf files in the input folder.</span>
<span class="n">list_file</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">input_folder</span> <span class="o">+</span> <span class="s2">&quot;/*hdf&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">list_file</span><span class="p">:</span>
    <span class="n">script</span> <span class="o">=</span> <span class="n">python_interpreter</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">python_script</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">output_base</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Using the <em>argparse</em> module:</p>
<blockquote>
<div><p>Modify the full reconstruction script as below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#  Script to perform full reconstruction, named full_reconstruction.py</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">timeit</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">algotom.io.loadersaver</span> <span class="k">as</span> <span class="nn">losa</span>
<span class="kn">import</span> <span class="nn">algotom.util.utility</span> <span class="k">as</span> <span class="nn">util</span>
<span class="kn">import</span> <span class="nn">algotom.prep.correction</span> <span class="k">as</span> <span class="nn">corr</span>
<span class="kn">import</span> <span class="nn">algotom.prep.calculation</span> <span class="k">as</span> <span class="nn">calc</span>
<span class="kn">import</span> <span class="nn">algotom.prep.removal</span> <span class="k">as</span> <span class="nn">remo</span>
<span class="kn">import</span> <span class="nn">algotom.prep.filtering</span> <span class="k">as</span> <span class="nn">filt</span>
<span class="kn">import</span> <span class="nn">algotom.rec.reconstruction</span> <span class="k">as</span> <span class="nn">rec</span>


<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Perform full reconstruction&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;file_path&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to input file&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output folder&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
<span class="c1"># To pass arguments to this script, run:</span>
<span class="c1"># python full_reconstruction.py -i file_path -o output</span>

<span class="n">file_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">file_path</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Load file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
<span class="c1">#  Script body ...</span>
</pre></div>
</div>
<p>Then just slightly modify the automation script:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#  Script to call the full reconstruction script</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="n">python_interpreter</span> <span class="o">=</span> <span class="s2">&quot;C:/Users/nvo/Miniconda3/envs/algotom/python&quot;</span>
<span class="n">python_script</span> <span class="o">=</span> <span class="s2">&quot;full_reconstruction.py&quot;</span> <span class="c1">#  At the same location of this script. Otherwise,</span>
                                         <span class="c1">#  providing the full path to full_reconstruction.py</span>

<span class="n">input_folder</span> <span class="o">=</span> <span class="s2">&quot;E:/datasets/&quot;</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">&quot;E:/full_reconstruction/&quot;</span>
<span class="c1"># Get a list of hdf files in the input folder.</span>
<span class="n">list_file</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">input_folder</span> <span class="o">+</span> <span class="s2">&quot;/*hdf&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">list_file</span><span class="p">:</span>
    <span class="n">script</span> <span class="o">=</span> <span class="n">python_interpreter</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">python_script</span> <span class="o">+</span> <span class="s2">&quot; -i &quot;</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; -o &quot;</span> <span class="o">+</span> <span class="n">output_base</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</div></blockquote>
<p>The instructions above are for running the reconstruction on a local machine (WinOS). However, if users have access to a
cluster system (LinuxOS), they can take advantage of its resources to process multiple datasets in parallel using an
embarrassingly parallel approach. The procedure of how to run reconstruction process on a cluster is as follows:</p>
<blockquote>
<div><ul>
<li><p>Install Python packages. Although a cluster may already have a standard Python environment with a set of
pre-installed packages, it may not include the package users need. In this case, users can create their own
Python environment. There are several ways to create a new Python environment, but one popular method is to use
<em>conda</em>. Conda is a package management system that makes it easy to create, manage environments and
packages. One of the advantages of <em>conda</em> is that it includes many popular Python packages, and it also
includes <em>pip</em>, which allows users to install packages only available on PyPI.org. If <em>conda</em> is not installed on
the cluster system, users can follow instructions <a class="reference external" href="https://docs.conda.io/projects/conda/en/latest/user-guide/install/linux.html">here</a>
to install it, then installing Python packages as shown <a class="reference external" href="https://algotom.readthedocs.io/en/latest/toc/section4/section4_1.html">here</a>.</p></li>
<li><p>Insert the full-path to the Python interpreter of the created environment at the top of python scripts:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/path/to/python/environment/bin/python</span>

<span class="c1">#  Script to perform full reconstruction, named full_reconstruction.py</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="c1"># ...</span>
</pre></div>
</div>
<p>then making the file executable by run the following command in a Linux terminal:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">chmod +x &lt;filename&gt;</span>
</pre></div>
</div>
</li>
<li><p>Write a bash script to submit jobs to the cluster scheduler. The bash script can be embed inside a Python script
to make it easy to customize the workflow. The following example demonstrates how to do that for a <a class="reference external" href="https://help.rc.ufl.edu/doc/Sample_SLURM_Scripts">SLURM cluster scheduler</a>
(for Univa Grid Engine scheduler, refer the example <a class="reference external" href="https://github.com/algotom/algotom/tree/master/examples/utilities">here</a>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/path/to/python/environment/bin/python</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="n">python_script</span> <span class="o">=</span> <span class="s2">&quot;full_reconstruction.py&quot;</span>

<span class="n">input_folder</span> <span class="o">=</span> <span class="s2">&quot;/facility/beamline/data/year/proposals/visit/raw_data/&quot;</span>
<span class="c1"># Get a list of nxs files in the input folder.</span>
<span class="n">list_file</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">input_folder</span> <span class="o">+</span> <span class="s2">&quot;/*nxs&quot;</span><span class="p">)</span>

<span class="c1"># Specify where to save the processed data</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">&quot;/facility/beamline/data/year/proposals/visit/processing/reconstruction&quot;</span>
<span class="c1"># Specify the folder for cluster output-file and error-file.</span>
<span class="n">cluster_dir</span> <span class="o">=</span> <span class="s2">&quot;/facility/beamline/data/year/proposals/visit/processing/cluster_output/&quot;</span>

<span class="c1"># Define a method to create a folder for saving output message from the cluster.</span>
<span class="k">def</span> <span class="nf">make_folder</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
    <span class="n">file_base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_base</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">file_base</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t create the folder: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_base</span><span class="p">))</span>

<span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">list_file</span><span class="p">:</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.nxs&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">output_folder</span> <span class="o">=</span> <span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Submit to process the raw-data file : </span><span class="si">{}</span><span class="s2">...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">))</span>
    <span class="n">cluster_output</span> <span class="o">=</span> <span class="n">cluster_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
    <span class="n">make_folder</span><span class="p">(</span><span class="n">cluster_output</span><span class="p">)</span>

    <span class="n">sbatch_script</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;#!/bin/bash</span>
<span class="s2">    #SBATCH --job-name=demo_workflow</span>
<span class="s2">    #SBATCH --ntasks 1</span>
<span class="s2">    #SBATCH --cpus-per-task 16</span>
<span class="s2">    #SBATCH --nodes=1</span>
<span class="s2">    #SBATCH --mem=16G</span>
<span class="s2">    #SBATCH --qos=normal</span>
<span class="s2">    #SBATCH --time=60:00</span>

<span class="s2">    srun -o </span><span class="si">{0}</span><span class="s2">/output_%j.txt -e </span><span class="si">{0}</span><span class="s2">/error_%j.txt ./</span><span class="si">{1}</span><span class="s2"> </span><span class="si">{2}</span><span class="s2"> </span><span class="si">{3}</span><span class="s2"></span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cluster_output</span><span class="p">,</span> <span class="n">python_script</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">)</span>

    <span class="c1"># Call sbatch and pass the sbatch script contents as input</span>
    <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;sbatch&#39;</span><span class="p">],</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">sbatch_script</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

    <span class="c1"># Print the output and error messages</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*********************************************&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;             !!!!!! Done !!!!!!              &quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*********************************************&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>To run the script, make it executable and log in to a submitting job node. Users can modify the workflow above
by reconstructing multiple datasets at once, such as 10 datasets in one batch, and waiting for them to finish
before submitting another batch. This approach ensures fair use of cluster resources among multiple users.</p></li>
</ul>
</div></blockquote>
</section>
<section id="downsampling-rescaling-and-reslicing-reconstructed-volume">
<h2><span class="section-number">4.5.8. </span>Downsampling, rescaling, and reslicing reconstructed volume<a class="headerlink" href="#downsampling-rescaling-and-reslicing-reconstructed-volume" title="Permalink to this heading">¶</a></h2>
<p>Reconstructed volume is in 32-bit tif or hdf format. In the above example, the size of the volume
is 2150 x 2560 x 2560 pixels, which corresponds to ~50 GB of data. To enable post-analysis on software
for volume visualization and analysis; e.g. Avizo, Amira, DragonFly, Drishti, Paraview, 3D Slicer, …;
it is often necessary to apply data reduction techniques such as cropping, downsampling, or rescaling.
Algotom provides convenient functions for these tasks, which can be applied to a folder of tif slices or a hdf/nxs file.</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">timeit</span>
<span class="kn">import</span> <span class="nn">algotom.io.loadersaver</span> <span class="k">as</span> <span class="nn">losa</span>
<span class="kn">import</span> <span class="nn">algotom.post.postprocessing</span> <span class="k">as</span> <span class="nn">post</span>

<span class="n">output_base</span> <span class="o">=</span> <span class="s2">&quot;E:/output/date_reduction/&quot;</span>

<span class="c1"># Rescale the volume to 16-bit data including cropping.</span>
<span class="c1"># Input is tif, output is tif</span>
<span class="n">tif_folder</span> <span class="o">=</span> <span class="s2">&quot;E:/full_reconstruction/recon_001&quot;</span>
<span class="n">output0</span> <span class="o">=</span> <span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/rescaling/&quot;</span>
<span class="n">folder_name</span> <span class="o">=</span> <span class="n">losa</span><span class="o">.</span><span class="n">make_folder_name</span><span class="p">(</span><span class="n">output0</span><span class="p">)</span>  <span class="c1"># To avoid overwriting</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">output0</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">folder_name</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
<span class="n">t_start</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="n">post</span><span class="o">.</span><span class="n">rescale_dataset</span><span class="p">(</span><span class="n">tif_folder</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">nbit</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">minmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">crop</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>

<span class="c1"># # Input is hdf, output is tif</span>
<span class="c1"># file_path = &quot;E:/full_reconstruction/recon_002/recon_data.hdf&quot;</span>
<span class="c1"># key_path = &quot;entry/data&quot;</span>
<span class="c1"># post.rescale_dataset(file_path, output, key_path=key_path, nbit=16, minmax=None,</span>
<span class="c1">#                      skip=None, crop=(100, 100, 200, 200, 200, 200))</span>
<span class="n">t_stop</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done rescaling! Time cost </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t_stop</span> <span class="o">-</span> <span class="n">t_start</span><span class="p">))</span>


<span class="c1"># Downsample the volume by 2 x 2 x 2 with cropping and rescaling to 8-bit.</span>
<span class="n">output0</span> <span class="o">=</span> <span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/downsampling/&quot;</span>
<span class="n">folder_name</span> <span class="o">=</span> <span class="n">losa</span><span class="o">.</span><span class="n">make_folder_name</span><span class="p">(</span><span class="n">output0</span><span class="p">)</span>  <span class="c1"># To avoid overwriting</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">output0</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">folder_name</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
<span class="n">t_start</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="n">post</span><span class="o">.</span><span class="n">downsample_dataset</span><span class="p">(</span><span class="n">tif_folder</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span>
                        <span class="n">rescaling</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nbit</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">minmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">crop</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
<span class="n">t_stop</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done downsampling! Time cost </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t_stop</span> <span class="o">-</span> <span class="n">t_start</span><span class="p">))</span>
</pre></div>
</div>
</div></blockquote>
<p>Reslicing the reconstructed volume is another important post-processing tool, especially for limited-angle tomography.
While some software such as ImageJ or Avizo offer this function, they require loading the entire volume into memory,
making it impossible to use on computers with limited RAM. Starting from version 1.3, Algotom provides a reslicing
function that uses the hdf format as the back-end, eliminating the need for high memory usage. Additionally, options
for cropping, rotating, and rescaling the volume are also included.</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">timeit</span>
<span class="kn">import</span> <span class="nn">algotom.io.loadersaver</span> <span class="k">as</span> <span class="nn">losa</span>
<span class="kn">import</span> <span class="nn">algotom.post.postprocessing</span> <span class="k">as</span> <span class="nn">post</span>

<span class="n">output_base</span> <span class="o">=</span> <span class="s2">&quot;E:/output/reslicing&quot;</span>

<span class="c1"># Reslice the volume along axis 1, including rotating, cropping, and rescaling to 8-bit data.</span>
<span class="c1"># Input is tif, output is tif</span>
<span class="n">tif_folder</span> <span class="o">=</span> <span class="s2">&quot;E:/full_reconstruction/recon_001&quot;</span>
<span class="n">folder_name</span> <span class="o">=</span> <span class="n">losa</span><span class="o">.</span><span class="n">make_folder_name</span><span class="p">(</span><span class="n">output_base</span><span class="p">)</span>  <span class="c1"># To avoid overwriting</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">folder_name</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
<span class="n">t_start</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>

<span class="n">post</span><span class="o">.</span><span class="n">reslice_dataset</span><span class="p">(</span><span class="n">tif_folder</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">rescaling</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rotate</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
                     <span class="n">nbit</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">crop</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>
                     <span class="n">chunk</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ncore</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># # Input is hdf, output is tif. It&#39;s possible to slice a hdf volume directly</span>
<span class="c1"># # along axis 2 but it will be extremely slow. Better use the Algotom function as below.</span>
<span class="c1">#</span>
<span class="c1"># file_path = &quot;E:/full_reconstruction/recon_002/recon_data.hdf&quot;</span>
<span class="c1"># key_path = &quot;entry/data&quot;</span>
<span class="c1"># post.reslice_dataset(file_path, output, key_path=key_path, rescaling=True,</span>
<span class="c1">#                      rotate=0.0, nbit=16, axis=2, crop=(100, 100, 200, 200, 200, 200),</span>
<span class="c1">#                      chunk=60, show_progress=True, ncore=None)</span>

<span class="n">t_stop</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done reslicing! Time cost </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t_stop</span> <span class="o">-</span> <span class="n">t_start</span><span class="p">))</span>
</pre></div>
</div>
</div></blockquote>
<p>As shown below, reslicing along the direction perpendicular to the missing wedge can produce high-quality images
suitable for post-analysis.</p>
<blockquote>
<div><a class="reference internal image-reference" href="../../_images/img_4_5_10.jpg" id="img-4-5-10"><img alt="../../_images/img_4_5_10.jpg" class="align-center" id="img-4-5-10" src="../../_images/img_4_5_10.jpg" style="width: 100%;" /></a>
</div></blockquote>
</section>
<section id="common-mistakes-and-useful-tips">
<h2><span class="section-number">4.5.9. </span>Common mistakes and useful tips<a class="headerlink" href="#common-mistakes-and-useful-tips" title="Permalink to this heading">¶</a></h2>
<ol class="arabic">
<li><p>We may see black images when using viewer software that does not support 32-bit tif images. Users need to use
<a class="reference external" href="https://imagej.net/ij/download.html">ImageJ</a> or <a class="reference external" href="https://imagej.net/software/fiji/downloads">Fiji</a>
to view 32-bit tif reconstructed slices or flat-field-corrected images.</p>
<a class="reference internal image-reference" href="../../_images/img_4_5_11.jpg" id="img-4-5-11"><img alt="../../_images/img_4_5_11.jpg" class="align-center" id="img-4-5-11" src="../../_images/img_4_5_11.jpg" style="width: 100%;" /></a>
</li>
<li><p>Black reconstructed slice is returned due to the zero division problem. Reconstruction methods in Algotom apply
the logarithm function to a sinogram by default, based on Beer-Lambert’s law. However, this can result in NaN values
if there are zeros or negative values in the sinogram. Zeros or negative values may comes from phase-retrieved images or
the <a class="reference internal" href="../section1/section1_4.html#flat-field-correction"><span class="std std-ref">flat-field correction process</span></a> using projection images which may have the following:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://areadetector.github.io/master/ADCore/NDPluginOverlay.html?highlight=time%20stamp">Time stamp</a> at one of the image corner.</p></li>
<li><p>Beam size is <a class="reference external" href="https://opg.optica.org/viewmedia.cfm?uri=oe-23-25-32859&amp;figure=oe-23-25-32859-g002&amp;imagetype=full">smaller</a> than the field of view.</p></li>
<li><p><a class="reference external" href="https://tomobank.readthedocs.io/en/latest/_images/tomo_00031.png">Low signal-to-noise ratio</a>.</p></li>
</ul>
</div></blockquote>
<p>To address these issues, there are several ways:</p>
<blockquote>
<div><ul>
<li><p>Disable the logarithm function by setting <em>apply_log</em> to <em>False</em> in a reconstruction method if the input
is a non-absorption-contrast image.</p></li>
<li><p>Crop the images to exclude problematic regions.</p></li>
<li><p>Not using dark-field image for low SNR data.</p></li>
<li><p>Replace zeros and negative values in the sinogram as below</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">nmean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sinogram</span><span class="p">)</span>
<span class="n">sinogram</span><span class="p">[</span><span class="n">sinogram</span><span class="o">&lt;=</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nmean</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</div></blockquote>
<p>Algotom provides <a class="reference external" href="https://algotom.readthedocs.io/en/latest/toc/api/algotom.prep.correction.html#algotom.prep.correction.flat_field_correction">a convenient method</a>
for flat-field correction; with the options to correct zero division, not use dark-field image, or include other preprocessing methods.</p>
</li>
<li><p>Users may apply methods on the wrong space or slice data along incorrect axis. As shown in <a class="reference internal" href="#fig-4-5-1"><span class="std std-numref">Fig. 4.5.1</span></a>, it is assumed
that the sample is upright, and therefore the rotation axis is parallel to the columns of the projection image. In 3D data,
axis 0 represents the projection space; axis 1 represents the sinogram space and the reconstruction space. It is
important to ensure that methods are applied correctly to the appropriate space and that data is sliced along the correct axis.
Sometimes the rotation axis of a tomography system may be parallel to the rows of the projection image. In such cases,
users need to rotate the projection image or adjust the slicing direction to obtain the sinogram image.</p></li>
<li><p>Cupping artifacts or outermost bright/dark ring artifacts can occur when padding is not used or wrong type of padding is used
for Fourier-based reconstruction methods. This problem has a significant impact on post-analysis, particularly image segmentation,
but very easy to fix simply by applying a proper padding such as <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.pad.html#numpy.pad">‘edge’, ‘reflect’, or ‘symmetric’</a>.
In Algotom, ‘edge’ padding is enabled by default for FFT-based methods, but in other software this function may not be enabled by default
or zero-padding is used. The following image demonstrates the difference between using zero padding and edge padding for the <em>gridrec</em> method.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tomopy</span>
<span class="kn">import</span> <span class="nn">algotom.io.loadersaver</span> <span class="k">as</span> <span class="nn">losa</span>
<span class="kn">import</span> <span class="nn">algotom.prep.calculation</span> <span class="k">as</span> <span class="nn">calc</span>
<span class="kn">import</span> <span class="nn">algotom.rec.reconstruction</span> <span class="k">as</span> <span class="nn">rec</span>

<span class="n">center</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">find_center_vo</span><span class="p">(</span><span class="n">sinogram</span><span class="p">)</span>
<span class="c1"># Algotom wrapper provides edge-padding.</span>
<span class="n">rec_img1</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">gridrec_reconstruction</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="c1"># Tomopy applies zero-padding by default.</span>
<span class="n">rec_img2</span> <span class="o">=</span> <span class="n">tomopy</span><span class="o">.</span><span class="n">recon</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">180.0</span><span class="p">,</span> <span class="n">sinogram</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
                        <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;gridrec&quot;</span><span class="p">)</span>

<span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/gridrec_edge_padding.tif&quot;</span><span class="p">,</span> <span class="n">rec_img1</span><span class="p">)</span>
<span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/gridrec_zero_padding.tif&quot;</span><span class="p">,</span> <span class="n">rec_img2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/img_4_5_12.jpg" id="img-4-5-12"><img alt="../../_images/img_4_5_12.jpg" class="align-center" id="img-4-5-12" src="../../_images/img_4_5_12.jpg" style="width: 100%;" /></a>
<p>and demonstration for the FBP method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">algotom.io.loadersaver</span> <span class="k">as</span> <span class="nn">losa</span>
<span class="kn">import</span> <span class="nn">algotom.prep.calculation</span> <span class="k">as</span> <span class="nn">calc</span>
<span class="kn">import</span> <span class="nn">algotom.rec.reconstruction</span> <span class="k">as</span> <span class="nn">rec</span>

<span class="n">center</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">find_center_vo</span><span class="p">(</span><span class="n">sinogram</span><span class="p">)</span>
<span class="c1"># Using built-in FBP method in Algotom with edge padding.</span>
<span class="n">rec_img1</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">fbp_reconstruction</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="c1"># Using FBP through Astra Toolbox. Astra applies zero-padding behind the scene.</span>
<span class="c1"># The Algotom wrapper provides edge-padding in addition to Astra&#39;s zero-padding.</span>
<span class="c1"># However, the artifacts caused by the zero-padding can still persist, as it</span>
<span class="c1"># disrupts the intensities at the boundaries, which is problematic for</span>
<span class="c1"># Fourier-based methods.</span>
<span class="n">rec_img2</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">astra_reconstruction</span><span class="p">(</span><span class="n">sinogram</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;FBP_CUDA&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/FBP_edge_padding.tif&quot;</span><span class="p">,</span> <span class="n">rec_img1</span><span class="p">)</span>
<span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/FBP_zero_padding.tif&quot;</span><span class="p">,</span> <span class="n">rec_img2</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../../_images/img_4_5_13.jpg" id="img-4-5-13"><img alt="../../_images/img_4_5_13.jpg" class="align-center" id="img-4-5-13" src="../../_images/img_4_5_13.jpg" style="width: 100%;" /></a>
</li>
<li><p>Users may not be aware of autoscaling implemented by image viewer software. Image viewers often apply autoscaling
to account for differences in intensity range between different image types, such as 32-bit, 16-bit or 8-bit. However,
this can lead to the displayed image having a contrast that does not accurately reflect the true contrast of the
original image. The following shows examples of using the ImageJ software.</p>
<p>Commonly, users may select a ROI and adjust the contrast of the image by autoscaling as shown below. An autoscaling
method works by normalizing the whole image based on the local minimum gray-scale and local maximum gray-scale of the ROI.
As can be seen, the left-side image is more noisy and has a higher dynamic range of intensities (distance between the
maximum intensity and minimum intensity) compared to the right-side image. When the auto-scaling is applied, the contrast
of the right-side image is improved because it has lower dynamic range.</p>
<blockquote>
<div><a class="reference internal image-reference" href="../../_images/img_4_5_14.png" id="img-4-5-14"><img alt="../../_images/img_4_5_14.png" class="align-center" id="img-4-5-14" src="../../_images/img_4_5_14.png" style="width: 100%;" /></a>
</div></blockquote>
<p>The following images shows the intensity profiles along the red lines in each image where the whole dynamic range of
intensities are used to plot.</p>
<blockquote>
<div><a class="reference internal image-reference" href="../../_images/img_4_5_15.png" id="img-4-5-15"><img alt="../../_images/img_4_5_15.png" class="align-center" id="img-4-5-15" src="../../_images/img_4_5_15.png" style="width: 100%;" /></a>
</div></blockquote>
<p>The following images show the intensity profiles along the red lines in each image where the dynamic range of
intensities is set to be the same in both images. As can be seen, the gray-scale values of an Aluminum sphere are
the same. Note that the intensities at the interfaces are strongly fluctuating due to the coherent effect of the
X-ray source.</p>
<blockquote>
<div><a class="reference internal image-reference" href="../../_images/img_4_5_16.png" id="img-4-5-16"><img alt="../../_images/img_4_5_16.png" class="align-center" id="img-4-5-16" src="../../_images/img_4_5_16.png" style="width: 100%;" /></a>
</div></blockquote>
<p>The above demonstration actually shows images reconstructed without and with Paganin filter (R=400), which was used
to explain the common misconception that the resulting Paganin filter image is a phase-contrast image. From a
mathematical point of view, Paganin’s formula is a <a class="reference external" href="https://opg.optica.org/oe/fulltext.cfm?uri=oe-29-12-17849&amp;id=451366#articleEquations">low-pass filter</a>
in Fourier space, with R as a tuning parameter that controls the strength of this filter. As a low-pass filter, it
reduces noise and the dynamic range of an image, which can help enhance the contrast between low-contrast features.
However, this can sometimes be confused with the phase effect, leading to the common misconception that the resulting
image is a phase-contrast image.</p>
</li>
<li><p>Overlapping parallelization should be avoided as it can degrade performance. Many functions in Algotom are set to
use multi-core by default. If users would like to write a wrapper on top to perform parallel work, such as processing
multiple datasets, making sure that the <em>ncore</em> option in Algotom API is set to 1.</p></li>
<li><p>There are different ways of applying pre-processing methods to multiple-sinograms as shown below.</p>
<p>Using with flat-field correction method:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">algotom.util.utility</span> <span class="k">as</span> <span class="nn">util</span>
<span class="kn">import</span> <span class="nn">algotom.prep.correction</span> <span class="k">as</span> <span class="nn">corr</span>
<span class="kn">import</span> <span class="nn">algotom.prep.removal</span> <span class="k">as</span> <span class="nn">remo</span>
<span class="kn">import</span> <span class="nn">algotom.prep.filtering</span> <span class="k">as</span> <span class="nn">filt</span>

<span class="n">opt1</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;remove_zinger&quot;</span><span class="p">,</span> <span class="s2">&quot;para1&quot;</span><span class="p">:</span> <span class="mf">0.08</span><span class="p">,</span> <span class="s2">&quot;para2&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<span class="n">opt2</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;remove_all_stripe&quot;</span><span class="p">,</span> <span class="s2">&quot;para1&quot;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span> <span class="s2">&quot;para2&quot;</span><span class="p">:</span> <span class="mi">51</span><span class="p">,</span> <span class="s2">&quot;para3&quot;</span><span class="p">:</span> <span class="mi">17</span><span class="p">}</span>
<span class="n">opt3</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;fresnel_filter&quot;</span><span class="p">,</span> <span class="s2">&quot;para1&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;para2&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<span class="n">sinograms</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">flat_field_correction</span><span class="p">(</span><span class="n">proj_obj</span><span class="p">[:,</span> <span class="mi">20</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span> <span class="p">:],</span> <span class="n">flat_field</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dark_field</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span> <span class="p">:],</span>
                                       <span class="n">option1</span><span class="o">=</span><span class="n">opt1</span><span class="p">,</span> <span class="n">option2</span><span class="o">=</span><span class="n">opt2</span><span class="p">,</span> <span class="n">option3</span><span class="o">=</span><span class="n">opt3</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p>Applying methods one-by-one:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sinograms</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">flat_field_correction</span><span class="p">(</span><span class="n">proj_obj</span><span class="p">[:,</span> <span class="mi">20</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span> <span class="p">:],</span> <span class="n">flat_field</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dark_field</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span> <span class="p">:])</span>
<span class="n">sino_pro</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sinograms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">sino_tmp</span> <span class="o">=</span> <span class="n">remo</span><span class="o">.</span><span class="n">remove_zinger</span><span class="p">(</span><span class="n">sinograms</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="mf">0.08</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">sino_tmp</span> <span class="o">=</span> <span class="n">remo</span><span class="o">.</span><span class="n">remove_all_stripe</span><span class="p">(</span><span class="n">sino_tmp</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
    <span class="n">sino_tmp</span> <span class="o">=</span> <span class="n">filt</span><span class="o">.</span><span class="n">fresnel_filter</span><span class="p">(</span><span class="n">sino_tmp</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">sino_pro</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sino_tmp</span><span class="p">)</span>
<span class="c1"># Convert results which is a Python list to a Numpy array and</span>
<span class="c1"># make sure axis 1 is corresponding to sinogram.</span>
<span class="n">sinograms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sino_pro</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p>Applying methods in parallel manually:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>

<span class="n">ncore</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">sinograms</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">flat_field_correction</span><span class="p">(</span><span class="n">proj_obj</span><span class="p">[:,</span> <span class="mi">20</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span> <span class="p">:],</span> <span class="n">flat_field</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dark_field</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span> <span class="p">:])</span>
<span class="n">num_sino</span> <span class="o">=</span> <span class="n">sinograms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">output_tmp</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">ncore</span><span class="p">,</span> <span class="n">prefer</span><span class="o">=</span><span class="s2">&quot;threads&quot;</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span>
    <span class="n">remo</span><span class="o">.</span><span class="n">remove_zinger</span><span class="p">)(</span><span class="n">sinograms</span><span class="p">[:,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:],</span> <span class="mf">0.08</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sino</span><span class="p">))</span>
<span class="n">sinograms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">output_tmp</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">output_tmp</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">ncore</span><span class="p">,</span> <span class="n">prefer</span><span class="o">=</span><span class="s2">&quot;threads&quot;</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span>
    <span class="n">remo</span><span class="o">.</span><span class="n">remove_all_stripe</span><span class="p">)(</span><span class="n">sinograms</span><span class="p">[:,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:],</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span>
                                                      <span class="nb">range</span><span class="p">(</span><span class="n">num_sino</span><span class="p">))</span>
<span class="n">sinograms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">output_tmp</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">output_tmp</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">ncore</span><span class="p">,</span> <span class="n">prefer</span><span class="o">=</span><span class="s2">&quot;threads&quot;</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span>
    <span class="n">filt</span><span class="o">.</span><span class="n">fresnel_filter</span><span class="p">)(</span><span class="n">sinograms</span><span class="p">[:,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:],</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sino</span><span class="p">))</span>
<span class="n">sinograms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">output_tmp</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p>Applying methods in parallel using Algotom API:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sinograms</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">flat_field_correction</span><span class="p">(</span><span class="n">proj_obj</span><span class="p">[:,</span> <span class="mi">20</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span> <span class="p">:],</span> <span class="n">flat_field</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dark_field</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">40</span><span class="p">,</span> <span class="p">:])</span>
<span class="n">sinograms</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">apply_method_to_multiple_sinograms</span><span class="p">(</span><span class="n">sinograms</span><span class="p">,</span> <span class="s2">&quot;remove_zinger&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.08</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                                    <span class="n">ncore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefer</span><span class="o">=</span><span class="s2">&quot;threads&quot;</span><span class="p">)</span>
<span class="n">sinograms</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">apply_method_to_multiple_sinograms</span><span class="p">(</span><span class="n">sinograms</span><span class="p">,</span> <span class="s2">&quot;remove_all_stripe&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">3.0</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">17</span><span class="p">],</span>
                                                    <span class="n">ncore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefer</span><span class="o">=</span><span class="s2">&quot;threads&quot;</span><span class="p">)</span>
<span class="n">sinograms</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">apply_method_to_multiple_sinograms</span><span class="p">(</span><span class="n">sinograms</span><span class="p">,</span> <span class="s2">&quot;fresnel_filter&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                                    <span class="n">ncore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefer</span><span class="o">=</span><span class="s2">&quot;threads&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p>Starting from version 1.3, Algotom’s reconstruction methods support batch processing of multiple sinograms at once.
It is important to note that the axis of the reconstructed slices is 1, which is similar to the axis used for
extracting sinograms.</p>
</li>
<li><p>Padding must be used for any Fourier-based image processing method, not just reconstruction as demonstrated in tip 5,
to reduce/remove side-effect artifacts. Without padding, well-used Fourier-based filters, such as Paganin filter or
Fresnel filter, applied on projection images can produce barrel-shaped intensity profiles in reconstructed images</p>
<blockquote>
<div><a class="reference internal image-reference" href="../../_images/img_4_5_17.jpg" id="img-4-5-17"><img alt="../../_images/img_4_5_17.jpg" class="align-center" id="img-4-5-17" src="../../_images/img_4_5_17.jpg" style="width: 50%;" /></a>
</div></blockquote>
<p>or ghost features in the top and bottom slices caused by cross-shaped artifacts in the frequency domain due to spectral leakage.</p>
<blockquote>
<div><a class="reference internal image-reference" href="../../_images/img_4_5_18.jpg" id="img-4-5-18"><img alt="../../_images/img_4_5_18.jpg" class="align-center" id="img-4-5-18" src="../../_images/img_4_5_18.jpg" style="width: 100%;" /></a>
</div></blockquote>
</li>
<li><p>In some cases, a tomography system may not be well-aligned, resulting in a rotation axis that is not perpendicular to
the rows of projection images. The angle of misalignment can be very small and difficult to detect or calculate using
projection images alone. A more accurate method involves extracting sinograms at the top, middle, and bottom of the
tomographic data (or more, to improve the fitting result later), calculating the center of rotation, and then applying
a linear fit to the results to obtain the tilt angle of the rotation axis.</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">algotom.io.loadersaver</span> <span class="k">as</span> <span class="nn">losa</span>
<span class="kn">import</span> <span class="nn">algotom.prep.correction</span> <span class="k">as</span> <span class="nn">corr</span>
<span class="kn">import</span> <span class="nn">algotom.prep.calculation</span> <span class="k">as</span> <span class="nn">calc</span>
<span class="kn">import</span> <span class="nn">algotom.rec.reconstruction</span> <span class="k">as</span> <span class="nn">rec</span>

<span class="n">file_path</span> <span class="o">=</span> <span class="s2">&quot;E:/Tomo_data/scan_68067.hdf&quot;</span>
<span class="n">output_base</span> <span class="o">=</span> <span class="s2">&quot;E:/output/tilted_projection/&quot;</span>
<span class="n">proj_path</span> <span class="o">=</span> <span class="s2">&quot;entry/projections&quot;</span>  <span class="c1"># Refer section 1.2.1 to know how to get</span>
                                 <span class="c1"># path to a dataset in a hdf file.</span>
<span class="n">flat_path</span> <span class="o">=</span> <span class="s2">&quot;entry/flats&quot;</span>
<span class="n">dark_path</span> <span class="o">=</span> <span class="s2">&quot;entry/darks&quot;</span>

<span class="c1"># Load data, average flat and dark images</span>
<span class="n">proj_obj</span> <span class="o">=</span> <span class="n">losa</span><span class="o">.</span><span class="n">load_hdf</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">proj_path</span><span class="p">)</span>  <span class="c1"># hdf object</span>
<span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="n">proj_obj</span><span class="o">.</span><span class="n">shape</span>
<span class="n">flat_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">losa</span><span class="o">.</span><span class="n">load_hdf</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">flat_path</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">dark_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">losa</span><span class="o">.</span><span class="n">load_hdf</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">dark_path</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Find center at different height for calculating the tilt angle</span>
<span class="n">slice_and_center</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">height</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="n">height</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">11</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Find center at slice </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">sinogram</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">flat_field_correction</span><span class="p">(</span><span class="n">proj_obj</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,:],</span> <span class="n">flat_field</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dark_field</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">find_center_vo</span><span class="p">(</span><span class="n">sinogram</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Center is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">center</span><span class="p">))</span>
    <span class="n">slice_and_center</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">center</span><span class="p">])</span>
<span class="n">slice_and_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">slice_and_center</span><span class="p">)</span>

<span class="c1"># Find the tilt angle using linear fit.</span>
<span class="c1"># Note that the sign of the tilt angle need to be changed if the projection</span>
<span class="c1"># images are flipped left-right or up-down by some detectors.</span>
<span class="n">tilt_angle</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">slice_and_center</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">slice_and_center</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tilt angle: </span><span class="si">{}</span><span class="s2"> (degree)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">tilt_angle</span><span class="p">)))</span>

<span class="c1"># Given tilted angle we can extract a single sinogram for reconstruction:</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">height</span> <span class="o">//</span> <span class="mi">2</span>
<span class="n">sino_tilted</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">generate_tilted_sinogram</span><span class="p">(</span><span class="n">proj_obj</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tilt_angle</span><span class="p">)</span>
<span class="n">flat_line</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">generate_tilted_profile_line</span><span class="p">(</span><span class="n">flat_field</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tilt_angle</span><span class="p">)</span>
<span class="n">dark_line</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">generate_tilted_profile_line</span><span class="p">(</span><span class="n">dark_field</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tilt_angle</span><span class="p">)</span>
<span class="n">sino_tilted</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">flat_field_correction</span><span class="p">(</span><span class="n">sino_tilted</span><span class="p">,</span> <span class="n">flat_line</span><span class="p">,</span> <span class="n">dark_line</span><span class="p">)</span>
<span class="n">center</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">find_center_vo</span><span class="p">(</span><span class="n">sino_tilted</span><span class="p">)</span>
<span class="n">rec_img</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">fbp_reconstruction</span><span class="p">(</span><span class="n">sino_tilted</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
<span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/recon.tif&quot;</span><span class="p">,</span> <span class="n">rec_img</span><span class="p">)</span>
<span class="c1"># or for a chunk of sinogram:</span>
<span class="n">start_idx</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">stop_idx</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">sinos_tilted</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">generate_tilted_sinogram_chunk</span><span class="p">(</span><span class="n">proj_obj</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">,</span> <span class="n">stop_idx</span><span class="p">,</span> <span class="n">tilt_angle</span><span class="p">)</span>
<span class="n">flats_tilted</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">generate_tilted_profile_chunk</span><span class="p">(</span><span class="n">flat_field</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">,</span> <span class="n">stop_idx</span><span class="p">,</span> <span class="n">tilt_angle</span><span class="p">)</span>
<span class="n">darks_tilted</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">generate_tilted_profile_chunk</span><span class="p">(</span><span class="n">dark_field</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">,</span> <span class="n">stop_idx</span><span class="p">,</span> <span class="n">tilt_angle</span><span class="p">)</span>
<span class="n">sinos_tilted</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">flat_field_correction</span><span class="p">(</span><span class="n">sinos_tilted</span><span class="p">,</span> <span class="n">flats_tilted</span><span class="p">,</span> <span class="n">darks_tilted</span><span class="p">)</span>
<span class="n">center</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">find_center_vo</span><span class="p">(</span><span class="n">sinos_tilted</span><span class="p">[:,</span> <span class="n">start_idx</span><span class="p">,</span> <span class="p">:])</span>
<span class="n">recs_img</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">fbp_reconstruction</span><span class="p">(</span><span class="n">sinos_tilted</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">stop_idx</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;0000&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
    <span class="n">losa</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">output_base</span> <span class="o">+</span> <span class="s2">&quot;/recon/recon_&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="n">recs_img</span><span class="p">[:,</span> <span class="n">i</span><span class="o">-</span><span class="n">start_idx</span><span class="p">,</span> <span class="p">:])</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>For increasing the field of view of the reconstructed image, the technique of 360-degree scan with offset rotation axis,
also known as half-acquisition (though this can be a confusing name), is commonly used. However, it is important to
note that the rotation axis should be shifted to the side of the field of view, not the sample itself. From
the projection image, it can be confusing as both shifts give the same results.</p>
<blockquote>
<div><a class="reference internal image-reference" href="../../_images/img_4_5_19.png" id="img-4-5-19"><img alt="../../_images/img_4_5_19.png" class="align-center" id="img-4-5-19" src="../../_images/img_4_5_19.png" style="width: 60%;" /></a>
</div></blockquote>
<p>but it’s much easier to understand using the sketch below</p>
<blockquote>
<div><a class="reference internal image-reference" href="../../_images/img_4_5_20.png" id="img-4-5-20"><img alt="../../_images/img_4_5_20.png" class="align-center" id="img-4-5-20" src="../../_images/img_4_5_20.png" style="width: 100%;" /></a>
</div></blockquote>
</li>
</ol>
</section>
<section id="data-analysis">
<h2><span class="section-number">4.5.10. </span>Data analysis<a class="headerlink" href="#data-analysis" title="Permalink to this heading">¶</a></h2>
<p>After cleaning and reconstructing all slices, the next step is to analyze the data to answer scientific questions.
There are a variety of tools and software available to users. For beginners, the following resources may be helpful:</p>
<ul class="simple">
<li><p>For learning about the quantitative information that X-ray tomography can provide, a good starting point is
the paper <a class="reference external" href="https://doi.org/10.1179/1743280413Y.0000000023">“Quantitative X-ray tomography”</a> by E. Maire and P.J. Withers.
This resource can provide a comprehensive overview of the field and help you understand the potential applications
and benefits of this technique.</p></li>
<li><p>Tutorials on YouTube are one of the most effective ways to learn quickly:</p>
<ul>
<li><p>Rigaku virtual workshop: <a class="reference external" href="https://www.youtube.com/watch?v=8nd3QsWwOiY">talk 1</a>, <a class="reference external" href="https://www.youtube.com/watch?v=vr3mgQRqy08">talk 2</a>.</p></li>
<li><p>Microscopy Australia channel: <a class="reference external" href="https://www.youtube.com/watch?v=Tf83MYmaivo">example talk</a>.</p></li>
<li><p>Cscsch channel: <a class="reference external" href="https://www.youtube.com/watch?v=rdwKCvBK85g">example talk</a>.</p></li>
<li><p>Channel of Dr. Sreenivas Bhattiprolu: <a class="reference external" href="https://www.youtube.com/&#64;DigitalSreeni/playlists">tutorial playlists</a>.</p></li>
</ul>
</li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
    
        <div id="show_right_sidebar">
            <p><a class="toggle_right_sidebar" href="#"><span class="icon"><</span><span>Page contents<span></a></p>
        </div>

        <div id="right_sidebar">
            <p><a class="toggle_right_sidebar" href="#"><span class="icon">></span><span>Page contents:<span></a></p>
            <div class="page_toc">
                <ul>
<li><a class="reference internal" href="#">4.5. Complete workflow for processing tomographic data</a><ul>
<li><a class="reference internal" href="#assessing-raw-data">4.5.1. Assessing raw data</a></li>
<li><a class="reference internal" href="#reconstructing-several-slices">4.5.2. Reconstructing several slices</a></li>
<li><a class="reference internal" href="#finding-the-center-of-rotation">4.5.3. Finding the center of rotation</a></li>
<li><a class="reference internal" href="#tweaking-parameters-of-preprocessing-methods">4.5.4. Tweaking parameters of preprocessing methods</a></li>
<li><a class="reference internal" href="#choosing-a-reconstruction-method">4.5.5. Choosing a reconstruction method</a></li>
<li><a class="reference internal" href="#performing-full-reconstruction">4.5.6. Performing full reconstruction</a></li>
<li><a class="reference internal" href="#automating-the-workflow">4.5.7. Automating the workflow</a></li>
<li><a class="reference internal" href="#downsampling-rescaling-and-reslicing-reconstructed-volume">4.5.8. Downsampling, rescaling, and reslicing reconstructed volume</a></li>
<li><a class="reference internal" href="#common-mistakes-and-useful-tips">4.5.9. Common mistakes and useful tips</a></li>
<li><a class="reference internal" href="#data-analysis">4.5.10. Data analysis</a></li>
</ul>
</li>
</ul>

            </div>
        </div>
    

      <div class="clearer"></div>
    </div>
    <div class="button_nav_wrapper">
        <div class="button_nav">
            <div class="left">
                
                <a href="section4_4.html">
                    <span class="icon"><</span><span><span class="section-number">4.4. </span>Comparison of ring removal methods on challenging sinograms</span></a>
                
            </div>

            <div class="right">
                
                    <a href="../section5.html"><span><span class="section-number">5. </span>Technical notes</span><span class="icon">></span></a>
                
            </div>
        </div>
    </div>


    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, Nghia T. Vo  NSLS-II, Brookhaven National Lab, US; Diamond Light Source, UK.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.1.1.
    </div>

<p id="theme_credit">Styled using the <a href="https://github.com/piccolo-orm/piccolo_theme">Piccolo Theme</a></p>
  </body>
</html>